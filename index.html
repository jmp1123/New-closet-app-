<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Vestiary">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f8f8f6">
<meta name="format-detection" content="telephone=no">
<!-- iOS home screen icon (Safari "Add to Home Screen") -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230c0c0c' rx='22'/><text y='.9em' font-size='72' x='50%' text-anchor='middle'>✦</text></svg>">
<title>Vestiary</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=Karla:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-box-sizing: border-box; }

/* iOS Safari: prevent text size adjustment */
html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }

/* iOS Safari: prevent callout on long press */
* { -webkit-touch-callout: none; }
/* But keep it on links/buttons that need it */
a, button, input, textarea, select { -webkit-touch-callout: default; }

:root {
  --bg: #f8f8f6;
  --white: #ffffff;
  --s2: #f1f1ef;
  --s3: #e8e8e6;
  --border: #e2e2e0;
  --border2: #b8b8b6;
  --ink: #0c0c0c;
  --ink2: #484848;
  --ink3: #888888;
  --ink4: #b8b8b8;
  --r: 14px;
  --shadow: 0 4px 24px rgba(0,0,0,.08);
  --shadow-lg: 0 16px 64px rgba(0,0,0,.14);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
}

html, body {
  height: 100%;
  font-family: 'Karla', sans-serif;
  background: var(--bg);
  color: var(--ink);
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
}

/* ─── ONBOARDING ─── */
#onboarding {
  position: fixed;
  inset: 0;
  background: var(--white);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding-top: var(--safe-top);
}

.ob-progress {
  position: sticky;
  top: 0;
  height: 3px;
  background: var(--s3);
  z-index: 10;
  flex-shrink: 0;
}
.ob-progress-fill {
  height: 100%;
  background: var(--ink);
  transition: width 0.4s ease;
  width: 0%;
}

.ob-screen {
  display: none;
  flex: 1;
  flex-direction: column;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 40px 24px 32px;
  max-width: 600px;
  margin: 0 auto;
  width: 100%;
  box-sizing: border-box;
}
.ob-screen.active { display: flex; }

/* ─── AUTH SCREENS ─── */
#auth-screen {
  position: fixed;
  inset: 0;
  background: var(--white);
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
  padding-top: var(--safe-top);
}
#auth-screen.hidden { display: none; }

.auth-container {
  width: 100%;
  max-width: 360px;
}
.auth-logo {
  text-align: center;
  margin-bottom: 40px;
}
.auth-logo-text {
  font-family: 'Cormorant Garamond', serif;
  font-size: 36px;
  font-weight: 300;
  letter-spacing: .1em;
  text-transform: uppercase;
}
.auth-logo-text em { font-style: italic; color: var(--ink3); }
.auth-tagline {
  font-size: 13px;
  color: var(--ink3);
  margin-top: 8px;
}

.auth-tabs {
  display: flex;
  margin-bottom: 24px;
  border-bottom: 1px solid var(--border);
}
.auth-tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  font-size: 13px;
  font-weight: 600;
  color: var(--ink3);
  background: none;
  border: none;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -1px;
}
.auth-tab.active {
  color: var(--ink);
  border-bottom-color: var(--ink);
}

.auth-form { display: none; }
.auth-form.active { display: block; }

.auth-field {
  margin-bottom: 16px;
}
.auth-label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .05em;
  text-transform: uppercase;
  color: var(--ink3);
  margin-bottom: 6px;
}
.auth-input {
  width: 100%;
  padding: 14px 16px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  font-size: 15px;
  font-family: 'Karla', sans-serif;
  background: var(--white);
  color: var(--ink);
  outline: none;
  -webkit-appearance: none;
}
.auth-input:focus { border-color: var(--ink); }

.auth-btn {
  width: 100%;
  padding: 16px;
  background: var(--ink);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Karla', sans-serif;
  margin-top: 8px;
}
.auth-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.auth-error {
  background: #fee;
  color: #c00;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 12px;
  margin-bottom: 16px;
  display: none;
}
.auth-error.show { display: block; }

.auth-divider {
  text-align: center;
  margin: 24px 0;
  font-size: 12px;
  color: var(--ink4);
}
.auth-skip {
  text-align: center;
}
.auth-skip-btn {
  background: none;
  border: none;
  color: var(--ink3);
  font-size: 13px;
  cursor: pointer;
  text-decoration: underline;
}

/* ─── OUTFIT PICKER MODAL ─── */
#outfit-picker-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 600;
  display: none;
  align-items: flex-end;
  justify-content: center;
}
#outfit-picker-overlay.open { display: flex; }

.outfit-picker-sheet {
  background: var(--white);
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-width: 500px;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  padding-bottom: var(--safe-bot);
}
.outfit-picker-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.outfit-picker-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 22px;
  font-weight: 300;
}
.outfit-picker-close {
  background: var(--s2);
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
}
.outfit-picker-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.outfit-picker-section {
  margin-bottom: 20px;
}
.outfit-picker-section-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--ink3);
  margin-bottom: 10px;
}
.outfit-picker-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.outfit-picker-item {
  aspect-ratio: 1;
  background: var(--s2);
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: border-color 0.2s;
}
.outfit-picker-item.selected { border-color: var(--ink); }
.outfit-picker-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.outfit-picker-item-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: var(--ink3);
  text-align: center;
  padding: 8px;
}
.outfit-picker-actions {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
}
.outfit-picker-actions .btn { flex: 1; }

/* Splash screen */
.ob-splash {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-around;
  text-align: center;
  gap: 0;
  padding: 20px 0;
}
.ob-logo-mark { margin-bottom: 20px; }
.ob-logo-text {
  font-family: 'Cormorant Garamond', serif;
  font-size: 52px;
  font-weight: 300;
  letter-spacing: .12em;
  text-transform: uppercase;
  margin-bottom: 10px;
}
.ob-logo-text em { font-style: italic; color: var(--ink3); }
.ob-tagline { font-size: 14px; color: var(--ink3); margin-bottom: 40px; }
.ob-start-hint { font-size: 13px; color: var(--ink4); line-height: 1.8; margin-bottom: 48px; }

/* Form screens */
.ob-eyebrow {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--ink3);
  margin-bottom: 14px;
}
.ob-heading {
  font-family: 'Cormorant Garamond', serif;
  font-size: 38px;
  font-weight: 300;
  line-height: 1.1;
  margin-bottom: 10px;
}
.ob-heading em { font-style: italic; color: var(--ink3); }
.ob-sub {
  font-size: 13px;
  color: var(--ink2);
  line-height: 1.7;
  margin-bottom: 28px;
}

.ob-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 32px; }
.ob-grid.one-col { grid-template-columns: 1fr; }
.ob-field { display: flex; flex-direction: column; gap: 6px; }
.ob-field.span2 { grid-column: 1 / 3; }
.ob-label {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--ink3);
}
.ob-input {
  padding: 13px 14px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  font-family: 'Karla', sans-serif;
  background: var(--white);
  color: var(--ink);
  outline: none;
  width: 100%;
  -webkit-appearance: none;
  appearance: none;
  transition: border-color .15s;
}
.ob-input:focus { border-color: var(--ink); }
.ob-input-row { display: flex; gap: 8px; align-items: center; }
.ob-input-row .ob-input { flex: 1; }
.ob-unit {
  font-size: 11px;
  font-weight: 700;
  color: var(--ink3);
  background: var(--s2);
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 13px 10px;
  white-space: nowrap;
}

/* Mood grid */
.ob-moods { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 32px; }
.ob-mood {
  border: 2px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  transition: border-color .2s;
  position: relative;
  -webkit-tap-highlight-color: transparent;
}
.ob-mood.active { border-color: var(--ink); border-width: 2.5px; }
.ob-mood-img {
  height: 110px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  position: relative;
  overflow: hidden;
}
.ob-mood-body { padding: 10px 12px; }
.ob-mood-name { font-size: 12px; font-weight: 700; color: var(--ink2); }
.ob-mood-desc { font-size: 10px; color: var(--ink3); margin-top: 2px; }
.ob-mood-check {
  display: none;
  position: absolute;
  top: 8px; right: 8px;
  width: 20px; height: 20px;
  border-radius: 50%;
  background: var(--ink);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  align-items: center;
  justify-content: center;
}
.ob-mood.active .ob-mood-check { display: flex; }

/* Work from home day picker */
.ob-wfh-day {
  background: var(--white);
  border: 2px solid var(--border);
  border-radius: 10px;
  padding: 12px 4px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.ob-wfh-day:active { transform: scale(0.95); }
.ob-wfh-day.active {
  background: var(--ink);
  border-color: var(--ink);
}
.ob-wfh-name {
  font-size: 11px;
  font-weight: 700;
  color: var(--ink2);
  text-transform: uppercase;
  letter-spacing: 0.03em;
}
.ob-wfh-day.active .ob-wfh-name { color: #fff; }
.ob-wfh-check {
  display: none;
  font-size: 12px;
  color: #fff;
  margin-top: 4px;
}
.ob-wfh-day.active .ob-wfh-check { display: block; }

/* Checkbox style */
.ob-checkbox {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  font-size: 13px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.ob-checkbox input {
  width: 18px;
  height: 18px;
  accent-color: var(--ink);
}

/* Onboarding buttons */
.ob-footer {
  margin-top: auto;
  padding-top: 24px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding-bottom: var(--safe-bot);
}
.ob-step-label { font-size: 11px; color: var(--ink3); font-weight: 600; }

.ob-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 14px 28px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Karla', sans-serif;
  cursor: pointer;
  border: none;
  min-height: 52px;
  -webkit-tap-highlight-color: transparent;
  transition: all .18s;
}
.ob-btn-primary { background: var(--ink); color: #fff; }
.ob-btn-primary:active { background: #2a2a2a; transform: scale(.98); }
.ob-btn-secondary {
  background: transparent;
  color: var(--ink2);
  border: 1.5px solid var(--border2);
}
.ob-btn-secondary:active { background: var(--s2); }
.ob-btn-full { width: 100%; max-width: 360px; font-size: 16px; padding: 17px; }

/* ─── APP SHELL ─── */
#app {
  display: none;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}
#app.visible { display: flex; }

/* App header */
.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: calc(var(--safe-top) + 12px) 18px 12px;
  background: var(--white);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}
.header-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 20px;
  font-weight: 300;
  letter-spacing: .12em;
  text-transform: uppercase;
}
.header-logo em { font-style: italic; color: var(--ink3); }
.header-right { display: flex; align-items: center; gap: 8px; }
.header-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px 11px;
  border: 1px solid var(--border);
  border-radius: 100px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: .05em;
  text-transform: uppercase;
  color: var(--ink2);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.header-pill-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--ink); }
.header-avatar {
  width: 32px; height: 32px;
  border-radius: 50%;
  background: var(--ink);
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

/* Main scroll */
.app-main {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

/* Pages */
.page { display: none; padding: 20px 18px; }
.page.active { display: block; animation: fadeUp .25s ease; }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Bottom nav */
.bottom-nav {
  display: flex;
  background: var(--white);
  border-top: 1px solid var(--border);
  padding-bottom: var(--safe-bot);
  flex-shrink: 0;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.bottom-nav::-webkit-scrollbar { display: none; }
.bn-item {
  flex: 1;
  min-width: 56px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  padding: 10px 6px 8px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  border: none;
  background: none;
  transition: background .15s;
  border-radius: 10px;
  margin: 4px 2px;
}
.bn-item:active { background: var(--s2); }
.bn-icon { width: 22px; height: 22px; color: var(--ink4); transition: color .15s; }
.bn-label { font-size: 9px; font-weight: 600; letter-spacing: .03em; color: var(--ink4); transition: color .15s; white-space: nowrap; }
.bn-item.active .bn-icon,
.bn-item.active .bn-label { color: var(--ink); }

/* ─── SHARED COMPONENTS ─── */
.pg-header { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 18px; }
.pg-title { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; }
.pg-eyebrow { font-size: 10px; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--ink3); margin-bottom: 3px; }

.card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 18px; }
.card-title {
  font-size: 10px; font-weight: 700;
  letter-spacing: .1em; text-transform: uppercase;
  color: var(--ink3); margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.card-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.btn {
  display: inline-flex; align-items: center; justify-content: center;
  padding: 10px 18px; border-radius: 100px;
  font-size: 12px; font-weight: 700;
  font-family: 'Karla', sans-serif;
  cursor: pointer; border: none;
  min-height: 40px;
  -webkit-tap-highlight-color: transparent;
  transition: all .18s;
}
.btn-dark { background: var(--ink); color: #fff; }
.btn-dark:active { background: #2a2a2a; }
.btn-outline { background: transparent; color: var(--ink); border: 1px solid var(--border2); }
.btn-outline:active { background: var(--s2); }

.chip {
  display: inline-flex; align-items: center;
  padding: 6px 14px; border-radius: 100px;
  font-size: 11px; font-weight: 600;
  cursor: pointer; border: 1px solid var(--border);
  background: var(--white); color: var(--ink3);
  -webkit-tap-highlight-color: transparent;
  transition: all .15s;
  min-height: 34px;
}
.chip.active { background: var(--ink); color: #fff; border-color: var(--ink); }

.divider { height: 1px; background: var(--border); margin: 14px 0; }

/* ─── HOME ─── */
.weather-card {
  background: var(--ink); color: #fff;
  border-radius: var(--r); padding: 18px;
  margin-bottom: 12px;
  display: flex; align-items: flex-start; justify-content: space-between;
}
.w-temp { 
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; 
  font-size: 52px; 
  font-weight: 200; 
  line-height: 1; 
  letter-spacing: -2px;
}
.w-cond { font-size: 12px; opacity: .7; margin-bottom: 8px; font-weight: 500; }
.w-lbl { font-size: 11px; opacity: .6; font-weight: 600; letter-spacing: .08em; text-transform: uppercase; margin-bottom: 4px; }
.w-rec { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,.12); border-radius: 100px; padding: 6px 14px; font-size: 11px; font-weight: 600; letter-spacing: .03em; text-transform: uppercase; width: fit-content; }
.w-days { display: flex; flex-direction: column; gap: 6px; }
.w-day { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,.08); border-radius: 10px; padding: 8px 12px; min-width: 120px; }
.w-day-name { font-size: 11px; font-weight: 700; opacity: .5; width: 26px; text-transform: uppercase; }
.w-day-ico { font-size: 16px; }
.w-day-temps { 
  display: flex; 
  gap: 6px; 
  margin-left: auto; 
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  font-weight: 500;
}
.w-hi { font-size: 15px; color: #fff; }
.w-lo { font-size: 15px; color: rgba(255,255,255,.45); }

.home-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.stat-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 14px 16px; }
.stat-label { font-size: 10px; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--ink3); margin-bottom: 4px; }
.stat-value { font-family: 'Cormorant Garamond', serif; font-size: 32px; font-weight: 300; line-height: 1; }
.stat-sub { font-size: 11px; color: var(--ink3); margin-top: 2px; }

.today-card {
  background: var(--white); border: 1px solid var(--border);
  border-radius: var(--r); padding: 16px 18px;
  margin-bottom: 12px;
}
.today-items { 
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
  gap: 8px; 
  margin: 12px 0 14px;
  padding: 16px;
  background: var(--s2);
  border-radius: 12px;
}
.today-item {
  aspect-ratio: 1;
  border-radius: 10px;
  overflow: hidden;
  background: transparent;
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-size: 22px;
}
.today-item img { 
  width: 100%; 
  height: 100%; 
  object-fit: contain; /* Changed from cover to contain for transparent bg */
}
.today-actions { display: flex; gap: 8px; }

/* Suggested Outfits */
.suggested-outfits {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding-bottom: 4px;
}
.suggested-outfits::-webkit-scrollbar { display: none; }

.suggested-outfit {
  flex-shrink: 0;
  width: 140px;
  background: var(--s2);
  border-radius: 12px;
  padding: 12px;
  cursor: pointer;
}
.suggested-outfit:active { opacity: 0.8; }

.suggested-outfit-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  margin-bottom: 10px;
}
.suggested-outfit-item {
  aspect-ratio: 1;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}
.suggested-outfit-item img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.suggested-outfit-name {
  font-size: 12px;
  font-weight: 600;
  text-align: center;
}
.suggested-outfit-type {
  font-size: 10px;
  color: var(--ink3);
  text-align: center;
}

/* Closet Insights */
.insight-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}
.insight-box {
  flex: 1;
  background: var(--s2);
  border-radius: 12px;
  padding: 14px;
  text-align: center;
}
.insight-value {
  font-family: 'Cormorant Garamond', serif;
  font-size: 28px;
  font-weight: 400;
  line-height: 1;
  margin-bottom: 4px;
}
.insight-label {
  font-size: 10px;
  color: var(--ink3);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.insight-items {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding: 4px 0;
}
.insight-items::-webkit-scrollbar { display: none; }
.insight-item {
  flex-shrink: 0;
  width: 60px;
  text-align: center;
}
.insight-item-img {
  width: 60px;
  height: 60px;
  border-radius: 10px;
  overflow: hidden;
  background: var(--s2);
  margin-bottom: 4px;
}
.insight-item-img img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.insight-item-name {
  font-size: 9px;
  color: var(--ink2);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.insight-item-wears {
  font-size: 9px;
  color: var(--ink4);
}
.insight-section-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--ink3);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin: 16px 0 10px;
}
.insight-section-title:first-child { margin-top: 0; }

/* Declutter Mode */
.declutter-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--white);
  border: 2px solid var(--border);
  border-radius: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
}
.declutter-item:active { transform: scale(0.98); }
.declutter-item.selected {
  border-color: var(--ink);
  background: var(--s2);
}
.declutter-item-check {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s;
}
.declutter-item-check span { display: none; font-size: 12px; }
.declutter-item.selected .declutter-item-check {
  background: var(--ink);
  border-color: var(--ink);
}
.declutter-item.selected .declutter-item-check span {
  display: block;
  color: #fff;
}
.declutter-item-img {
  width: 50px;
  height: 50px;
  border-radius: 8px;
  overflow: hidden;
  flex-shrink: 0;
  background: var(--s2);
}
.declutter-item-info { flex: 1; min-width: 0; }
.declutter-item-name {
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.declutter-item-meta {
  font-size: 11px;
  color: var(--ink3);
}
.declutter-item-action { flex-shrink: 0; }

.week-row { 
  display: flex; 
  gap: 8px; 
  overflow-x: auto; 
  -webkit-overflow-scrolling: touch; 
  scrollbar-width: none; 
  padding-bottom: 4px;
  scroll-behavior: smooth;
}
.week-row::-webkit-scrollbar { display: none; }
.week-day { 
  flex: 0 0 auto;
  width: 64px;
  text-align: center; 
  padding: 12px 6px; 
  border-radius: 10px; 
  cursor: pointer; 
}
.week-day.filled { background: var(--s2); }
.week-day.today { background: var(--ink); }
.week-day.planned { background: var(--ink); }
.week-day.empty { border: 1.5px dashed var(--border); }
.week-day-name { font-size: 11px; font-weight: 700; letter-spacing: .05em; text-transform: uppercase; color: var(--ink2); }
.week-day.today .week-day-name, .week-day.planned .week-day-name { color: #fff; }
.week-day-ico { font-size: 10px; margin-top: 4px; color: var(--ink3); }
.week-day.today .week-day-ico, .week-day.planned .week-day-ico { color: rgba(255,255,255,.7); }

/* ─── CLOSET ─── */
.filter-row { display: flex; gap: 6px; margin-bottom: 14px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 2px; scrollbar-width: none; }
.filter-row::-webkit-scrollbar { display: none; }
.closet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px, 1fr)); gap: 10px; }
.c-card { background: var(--white); border-radius: var(--r); overflow: hidden; border: 1px solid var(--border); cursor: pointer; -webkit-tap-highlight-color: transparent; }
.c-card:active { opacity: .85; }
.c-img { height: 185px; background: var(--s2); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 44px; }
.c-img img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
.c-body { padding: 9px 11px; }
.c-name { font-size: 12px; font-weight: 600; margin-bottom: 3px; }
.c-meta { font-size: 10px; color: var(--ink3); display: flex; justify-content: space-between; }
.c-worn { font-size: 9px; padding: 2px 7px; border-radius: 100px; background: var(--s2); color: var(--ink2); font-weight: 600; }
.add-card { border: 2px dashed var(--border); border-radius: var(--r); min-height: 230px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; cursor: pointer; color: var(--ink4); -webkit-tap-highlight-color: transparent; }
.add-card:active { background: var(--s2); }
.add-label { font-size: 10px; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; }

/* ─── OUTFITS ─── */
.outfit-scroll { display: flex; gap: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; scroll-snap-type: x mandatory; scrollbar-width: none; margin-bottom: 12px; }
.outfit-scroll::-webkit-scrollbar { display: none; }
.o-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; min-width: 260px; flex-shrink: 0; scroll-snap-align: start; cursor: pointer; -webkit-tap-highlight-color: transparent; }
.o-card.collab { border-color: var(--ink); border-width: 1.5px; }
.o-preview { height: 180px; position: relative; overflow: hidden; background: var(--s2); }
.o-grid { display: grid; width: 100%; height: 100%; }
.o-grid.two { grid-template-columns: 1fr 1fr; }
.o-grid.three { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
.o-cell { overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; font-size: 24px; background: var(--s2); }
.o-cell.wide { grid-column: 1 / 3; }
.o-cell img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
.o-div-v { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background: var(--bg); z-index: 2; }
.o-div-h { position: absolute; left: 0; right: 0; top: 50%; height: 2px; background: var(--bg); z-index: 2; }
.o-badge { position: absolute; top: 8px; left: 8px; font-size: 9px; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; padding: 3px 8px; border-radius: 100px; background: rgba(255,255,255,.92); color: var(--ink2); z-index: 3; }
.o-collab-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,.72)); padding: 10px 12px; z-index: 3; }
.o-collab-brand { font-size: 9px; font-weight: 800; letter-spacing: .09em; text-transform: uppercase; color: rgba(255,255,255,.65); }
.o-collab-name { font-size: 12px; font-weight: 700; color: #fff; }
.o-body { padding: 12px 14px; }
.o-name { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
.o-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
.o-tag { font-size: 10px; padding: 2px 8px; border-radius: 100px; background: var(--s2); color: var(--ink2); border: 1px solid var(--border); }
.o-tag.collab { background: var(--ink); color: #fff; border-color: var(--ink); }
.o-desc { font-size: 11px; color: var(--ink3); line-height: 1.5; margin-bottom: 8px; }
.o-actions { display: flex; gap: 6px; }
.shop-row { background: var(--s2); border-radius: 9px; padding: 9px 11px; margin-top: 8px; display: flex; align-items: center; gap: 9px; }
.shop-ico { width: 38px; height: 46px; border-radius: 7px; background: var(--s3); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
.shop-nm { font-size: 11px; font-weight: 600; }
.shop-brand { font-size: 10px; color: var(--ink3); }
.shop-price { font-size: 11px; font-weight: 700; margin-top: 1px; }
.shop-cta { font-size: 11px; font-weight: 700; color: var(--ink); text-decoration: underline; cursor: pointer; margin-left: auto; white-space: nowrap; }

/* ─── PLANNER ─── */
.planner-weather { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 2px; scrollbar-width: none; }
.planner-weather::-webkit-scrollbar { display: none; }
.pw-card { flex-shrink: 0; background: var(--white); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; display: flex; align-items: center; gap: 8px; min-width: 100px; }
.pw-card.today { background: var(--ink); color: #fff; border-color: transparent; }
.pw-ico { font-size: 18px; }
.pw-day { font-size: 10px; font-weight: 700; opacity: .6; }
.pw-temp { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 300; line-height: 1; }

/* Month Calendar */
.month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.month-nav-btn { background: var(--s2); border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 16px; cursor: pointer; }
.month-nav-btn:active { background: var(--s3); }
.month-title { font-family: 'Cormorant Garamond', serif; font-size: 24px; font-weight: 300; }

.calendar-grid { 
  display: grid; 
  grid-template-columns: repeat(7, 1fr); 
  gap: 6px;
  min-height: calc(100vh - 280px);
  grid-auto-rows: 1fr;
}
.calendar-header { text-align: center; font-size: 10px; font-weight: 700; color: var(--ink3); text-transform: uppercase; letter-spacing: 0.05em; padding: 8px 0; height: auto !important; min-height: 0 !important; }

.calendar-day { 
  background: var(--white); 
  border: 1px solid var(--border); 
  border-radius: 10px; 
  padding: 8px 6px;
  cursor: pointer; 
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  -webkit-tap-highlight-color: transparent;
  min-height: 60px;
}
.calendar-day:active { background: var(--s2); }
.calendar-day.other-month { opacity: 0.3; }
.calendar-day.today { border-color: var(--ink); border-width: 2px; }
.calendar-day.has-outfit { background: var(--ink); border-color: var(--ink); }
.calendar-day.has-outfit .cal-num { color: #fff; }

.cal-num { 
  font-family: 'Cormorant Garamond', serif; 
  font-size: 18px; 
  font-weight: 400; 
  line-height: 1;
  margin-bottom: 4px;
}
.cal-dot { 
  width: 6px; 
  height: 6px; 
  border-radius: 50%; 
  background: var(--ink); 
  margin-top: auto;
}
.calendar-day.has-outfit .cal-dot { background: #fff; }
.cal-thumb {
  width: 100%;
  flex: 1;
  min-height: 30px;
  border-radius: 6px;
  overflow: hidden;
  background: rgba(255,255,255,0.2);
}
.cal-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.cal-suggestion {
  font-size: 8px;
  color: var(--ink4);
  margin-top: auto;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}
.calendar-day.has-outfit .cal-suggestion { color: rgba(255,255,255,0.6); }

/* Week strip for horizontal scroll */
.week-planner { display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 8px; scrollbar-width: none; }
.week-planner::-webkit-scrollbar { display: none; }
.day-card { flex-shrink: 0; width: 130px; background: var(--white); border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; }
.day-card.today { border-color: var(--ink); border-width: 1.5px; }
.day-head { padding: 8px 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.day-name { font-size: 9px; font-weight: 700; letter-spacing: .09em; text-transform: uppercase; color: var(--ink3); }
.day-num { font-family: 'Cormorant Garamond', serif; font-size: 19px; font-weight: 300; }
.day-body { padding: 8px 10px; }
.day-event { font-size: 9px; font-weight: 700; padding: 2px 6px; background: var(--s2); border-radius: 5px; display: inline-block; margin-bottom: 6px; border: 1px solid var(--border); }
.day-outfit { background: var(--s2); border-radius: 8px; padding: 7px 8px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
.day-outfit:active { background: var(--s3); }
.day-outfit-ico { font-size: 16px; text-align: center; margin-bottom: 2px; }
.day-outfit-nm { font-size: 9px; font-weight: 600; text-align: center; color: var(--ink2); }
.day-empty { border: 1.5px dashed var(--border); border-radius: 8px; padding: 18px 8px; text-align: center; font-size: 18px; color: var(--ink4); cursor: pointer; margin-top: 4px; -webkit-tap-highlight-color: transparent; }

/* ─── STATS ─── */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.stats-big { font-family: 'Cormorant Garamond', serif; font-size: 34px; font-weight: 300; line-height: 1; }
.wear-row { display: flex; align-items: center; gap: 10px; margin-bottom: 9px; }
.wear-name { font-size: 12px; width: 130px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.wear-track { flex: 1; height: 5px; background: var(--s3); border-radius: 3px; overflow: hidden; }
.wear-fill { height: 100%; background: var(--ink); border-radius: 3px; transition: width 1.1s ease; }
.wear-count { font-size: 11px; color: var(--ink3); width: 24px; text-align: right; }
.cpw-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; border-bottom: 1px solid var(--border); }
.cpw-row:last-child { border: none; }
.cpw-name { font-size: 12px; font-weight: 600; }
.cpw-sub { font-size: 10px; color: var(--ink3); }
.cpw-val { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 300; }
.unloved-row { display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; scrollbar-width: none; }
.unloved-row::-webkit-scrollbar { display: none; }
.unloved-card { flex-shrink: 0; width: 110px; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; -webkit-tap-highlight-color: transparent; }
.unloved-card:active { opacity: .8; }
.unloved-img { height: 90px; background: var(--s2); display: flex; align-items: center; justify-content: center; font-size: 28px; }
.unloved-img img { width: 100%; height: 100%; object-fit: cover; }
.unloved-nm { font-size: 10px; font-weight: 600; padding: 5px 7px 2px; }
.unloved-worn { font-size: 10px; color: var(--ink4); padding: 0 7px 6px; }

/* ─── PACKING ─── */
.pack-form { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 18px; margin-bottom: 14px; }
.pack-field { margin-bottom: 14px; }
.pack-label { font-size: 10px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--ink3); margin-bottom: 6px; display: block; }
.pack-input { width: 100%; padding: 11px 13px; border: 1.5px solid var(--border); border-radius: 9px; font-size: 14px; font-family: 'Karla', sans-serif; outline: none; -webkit-appearance: none; }
.pack-input:focus { border-color: var(--ink); }
.pack-types { display: flex; gap: 6px; }
.pack-type { flex: 1; padding: 9px 4px; border: 1.5px solid var(--border); border-radius: 9px; text-align: center; cursor: pointer; -webkit-tap-highlight-color: transparent; transition: all .15s; }
.pack-type.active { border-color: var(--ink); background: var(--s2); }
.pack-type-ico { font-size: 18px; margin-bottom: 2px; }
.pack-type-lbl { font-size: 10px; font-weight: 700; }
.pack-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-bottom: 14px; }
.pc-item { border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
.pc-img { height: 88px; background: var(--s2); display: flex; align-items: center; justify-content: center; font-size: 26px; }
.pc-img img { width: 100%; height: 100%; object-fit: cover; }
.pc-info { padding: 6px 8px; }
.pc-nm { font-size: 10px; font-weight: 700; }
.pc-cat { font-size: 10px; color: var(--ink3); }
.pack-day-row { display: flex; align-items: center; gap: 10px; padding: 9px 12px; background: var(--s2); border-radius: 8px; margin-bottom: 6px; }
.pack-day-label { font-size: 11px; font-weight: 700; width: 36px; flex-shrink: 0; }
.pack-day-outfit { font-size: 12px; flex: 1; }
.pack-day-occ { font-size: 10px; color: var(--ink3); }

/* ─── GAPS ─── */
.gap-score { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; padding: 16px; background: var(--white); border: 1px solid var(--border); border-radius: var(--r); }
.gap-ring { width: 72px; height: 72px; border-radius: 50%; background: conic-gradient(var(--ink) 0% 68%, var(--s3) 68% 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.gap-ring-inner { width: 52px; height: 52px; border-radius: 50%; background: var(--white); display: flex; flex-direction: column; align-items: center; justify-content: center; }
.gap-ring-pct { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 300; line-height: 1; }
.gap-ring-lbl { font-size: 9px; color: var(--ink3); }
.gap-score-title { font-size: 14px; font-weight: 700; margin-bottom: 3px; }
.gap-score-sub { font-size: 12px; color: var(--ink2); line-height: 1.5; }
.gap-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.gap-item:last-child { border: none; }
.gap-ico { width: 44px; height: 44px; border-radius: 8px; background: var(--s2); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; overflow: hidden; }
.gap-info { flex: 1; }
.gap-name { font-size: 12px; font-weight: 700; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
.gap-desc { font-size: 11px; color: var(--ink3); line-height: 1.4; }
.gap-cta { font-size: 10px; font-weight: 700; color: var(--ink); text-decoration: underline; cursor: pointer; margin-top: 3px; display: inline-block; }
.sev { font-size: 9px; font-weight: 700; letter-spacing: .05em; text-transform: uppercase; padding: 2px 7px; border-radius: 100px; }
.sev-hi { background: #f0e8e8; color: #884444; }
.sev-med { background: #f0ede8; color: #886644; }
.sev-lo { background: var(--s2); color: var(--ink3); }
.cat-bar { margin-bottom: 9px; }
.cat-bar-head { display: flex; justify-content: space-between; margin-bottom: 3px; }
.cat-bar-name { font-size: 12px; }
.cat-bar-count { font-size: 11px; color: var(--ink3); }
.cat-bar-track { height: 5px; background: var(--s3); border-radius: 3px; overflow: hidden; }
.cat-bar-fill { height: 100%; background: var(--ink); border-radius: 3px; }

/* ─── CALENDAR ─── */
.sync-item { display: flex; align-items: center; gap: 11px; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
.sync-item:active { background: var(--s2); }
.sync-ico { width: 32px; height: 32px; border-radius: 7px; background: var(--s2); display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0; }
.sync-name { font-size: 13px; font-weight: 600; }
.sync-desc { font-size: 11px; color: var(--ink3); }
.sync-status { font-size: 10px; font-weight: 700; margin-left: auto; }
.sync-on { color: var(--ink); }
.sync-off { color: var(--ink4); }
.event-item { display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.event-item:last-child { border: none; }
.event-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--ink); margin-top: 5px; flex-shrink: 0; }
.event-dot.dim { background: var(--ink4); }
.event-name { font-size: 12px; font-weight: 700; }
.event-time { font-size: 11px; color: var(--ink3); }
.event-cta { font-size: 10px; font-weight: 700; color: var(--ink); text-decoration: underline; cursor: pointer; margin-top: 3px; display: inline-block; }

/* ─── BRANDS ─── */
.brands-hero { background: var(--ink); color: #fff; border-radius: var(--r); padding: 24px; margin-bottom: 16px; }
.brands-hero-title { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; margin-bottom: 6px; }
.brands-hero-sub { font-size: 12px; color: rgba(255,255,255,.45); line-height: 1.7; }
.override-bar { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 12px 16px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; }
.tier-section { margin-bottom: 20px; }
.tier-label { font-size: 10px; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--ink3); margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
.brands-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); gap: 7px; }
.brand-card { display: flex; align-items: center; gap: 9px; padding: 10px 11px; border: 1.5px solid var(--border); border-radius: 10px; cursor: pointer; -webkit-tap-highlight-color: transparent; transition: all .18s; background: var(--white); }
.brand-card:active { background: var(--s2); }
.brand-card.on { border-color: var(--ink); background: var(--ink); color: #fff; }
.brand-ico { width: 28px; height: 28px; border-radius: 6px; background: var(--s2); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
.brand-card.on .brand-ico { background: rgba(255,255,255,.12); }
.brand-name { font-size: 11px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.brand-tier-tag { font-size: 9px; color: var(--ink3); font-weight: 700; }
.brand-card.on .brand-tier-tag { color: rgba(255,255,255,.45); }

/* ─── BRAND DASHBOARD ─── */
.dash-hero { background: var(--ink); color: #fff; border-radius: var(--r); padding: 20px; margin-bottom: 14px; display: flex; align-items: center; gap: 14px; }
.dash-ico { font-size: 36px; width: 62px; height: 62px; border-radius: 12px; background: rgba(255,255,255,.1); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.dash-name { font-family: 'Cormorant Garamond', serif; font-size: 24px; font-weight: 300; }
.dash-sub { font-size: 11px; color: rgba(255,255,255,.45); margin-top: 2px; }
.dash-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.dash-stat { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 12px 14px; }
.dash-stat-label { font-size: 10px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--ink3); margin-bottom: 3px; }
.dash-stat-val { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; line-height: 1; }
.dash-stat-sub { font-size: 10px; color: var(--ink3); }
.match-row { display: flex; align-items: center; gap: 8px; padding: 7px 0; border-bottom: 1px solid var(--border); }
.match-row:last-child { border: none; }
.match-style { font-size: 12px; font-weight: 600; flex: 1; }
.match-track { width: 80px; height: 4px; background: var(--s3); border-radius: 2px; overflow: hidden; }
.match-fill { height: 100%; background: var(--ink); border-radius: 2px; }
.match-pct { font-size: 11px; color: var(--ink3); width: 28px; text-align: right; }
.rec-row { display: flex; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--border); }
.rec-row:last-child { border: none; }
.rec-ico { width: 32px; height: 32px; border-radius: 7px; background: var(--s2); display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0; }
.rec-name { font-size: 11px; font-weight: 700; }
.rec-sub { font-size: 10px; color: var(--ink3); }
.rec-price { font-size: 12px; font-weight: 700; margin-left: auto; white-space: nowrap; }

/* ─── PROFILE ─── */
.profile-avatar-wrap { display: flex; align-items: center; gap: 14px; margin-bottom: 18px; }
.profile-avatar { width: 64px; height: 64px; border-radius: 50%; background: var(--ink); color: #fff; font-size: 22px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
.profile-name { font-family: 'Cormorant Garamond', serif; font-size: 26px; font-weight: 300; }
.profile-style-lbl { font-size: 10px; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; color: var(--ink3); margin-top: 2px; }
.meas-section { margin-bottom: 14px; }
.meas-title { font-size: 10px; font-weight: 700; letter-spacing: .09em; text-transform: uppercase; color: var(--ink3); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.meas-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.meas-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; }
.meas-item { background: var(--s2); border-radius: 8px; padding: 9px 11px; }
.meas-item-label { font-size: 9px; font-weight: 700; letter-spacing: .07em; text-transform: uppercase; color: var(--ink3); }
.meas-item-val { font-size: 15px; font-weight: 700; margin-top: 1px; }
.notif-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
.notif-row:last-child { border: none; }
.notif-title { font-size: 13px; font-weight: 600; }
.notif-sub { font-size: 11px; color: var(--ink3); margin-top: 1px; }
.toggle { width: 40px; height: 24px; border-radius: 100px; cursor: pointer; position: relative; flex-shrink: 0; -webkit-tap-highlight-color: transparent; }
.toggle.on { background: var(--ink); }
.toggle.off { background: var(--s3); }
.toggle-thumb { width: 18px; height: 18px; border-radius: 50%; background: #fff; position: absolute; top: 3px; transition: left .18s; box-shadow: 0 1px 3px rgba(0,0,0,.2); }
.toggle.on .toggle-thumb { left: 19px; }
.toggle.off .toggle-thumb { left: 3px; }

/* ─── MODAL ─── */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55); backdrop-filter: blur(8px); z-index: 500; display: none; align-items: flex-end; justify-content: center; padding-bottom: var(--safe-bot); }
.modal-overlay.open { display: flex; }
.modal-sheet { background: var(--white); border-radius: 20px 20px 0 0; width: 100%; max-width: 560px; padding: 24px 22px; animation: sheetUp .3s ease; max-height: 90vh; overflow-y: auto; }
@keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-handle { width: 36px; height: 4px; border-radius: 2px; background: var(--s3); margin: 0 auto 18px; }
.modal-title { font-family: 'Cormorant Garamond', serif; font-size: 24px; font-weight: 300; margin-bottom: 5px; }
.modal-sub { font-size: 12px; color: var(--ink2); line-height: 1.6; margin-bottom: 18px; }

/* ─── TOAST ─── */
.toast { position: fixed; bottom: calc(var(--safe-bot) + 100px); left: 50%; transform: translateX(-50%) translateY(60px); background: rgba(0,0,0,0.7); color: #fff; padding: 8px 14px; border-radius: 100px; font-size: 11px; font-weight: 600; transition: transform .25s ease, opacity .25s ease; z-index: 9999; pointer-events: none; white-space: nowrap; opacity: 0; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* ── OUTFIT BUILDER ── */
.canvas-item { position:relative; width:80px; flex-shrink:0; cursor:pointer; }
.canvas-item-img { width:80px; height:95px; border-radius:10px; overflow:hidden; background:var(--s2); display:flex; align-items:center; justify-content:center; font-size:28px; border:2px solid var(--border); }
.canvas-item-img img { width:100%; height:100%; object-fit:cover; }
.canvas-item-name { font-size:9px; font-weight:700; text-align:center; margin-top:4px; color:var(--ink2); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.canvas-remove { position:absolute; top:-6px; right:-6px; width:20px; height:20px; border-radius:50%; background:var(--ink); color:#fff; border:none; font-size:12px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1; }
.builder-item { cursor:pointer; border:2px solid var(--border); transition:border-color .15s; }
.builder-item.selected { border-color:var(--ink); }
.builder-item:active { opacity:.8; }

/* ── COACH CHAT ── */
.chat-msg { padding:11px 14px; border-radius:14px; font-size:13px; line-height:1.6; max-width:85%; }
.chat-msg.coach { background:var(--s2); align-self:flex-start; border-bottom-left-radius:4px; }
.chat-msg.user { background:var(--ink); color:#fff; align-self:flex-end; border-bottom-right-radius:4px; }
.coach-quick { padding:8px 14px; border:1.5px solid var(--border2); border-radius:100px; font-size:11px; font-weight:600; cursor:pointer; background:var(--white); color:var(--ink2); font-family:'Karla',sans-serif; white-space:nowrap; -webkit-tap-highlight-color:transparent; }
.coach-quick:active { background:var(--s2); }
.chat-typing { display:flex; gap:4px; align-items:center; padding:12px 14px; background:var(--s2); border-radius:14px; border-bottom-left-radius:4px; align-self:flex-start; }
.chat-dot { width:6px; height:6px; border-radius:50%; background:var(--ink3); animation:chatBounce 1.2s infinite; }
.chat-dot:nth-child(2) { animation-delay:.2s; }
.chat-dot:nth-child(3) { animation-delay:.4s; }
@keyframes chatBounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }

/* ── LOCATION PERMISSION ── */
.perm-sheet { position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter:blur(8px); z-index:800; display:none; align-items:flex-end; justify-content:center; padding-bottom:var(--safe-bot); }
.perm-sheet.open { display:flex; }
.perm-card { background:var(--white); border-radius:20px 20px 0 0; width:100%; max-width:480px; padding:28px 24px 32px; }
.perm-handle { width:36px; height:4px; background:var(--s3); border-radius:2px; margin:0 auto 22px; }


/* ─── ICONS PAGE ─── */
.icons-search {
  display: flex; gap: 8px; margin-bottom: 14px;
}
.icons-search-input {
  flex: 1; padding: 12px 14px; border: 1.5px solid var(--border);
  border-radius: 12px; font-size: 14px; font-family: 'Karla', sans-serif;
  outline: none; -webkit-appearance: none; background: var(--white);
}
.icons-search-input:focus { border-color: var(--ink); }
.icons-cat-row {
  display: flex; gap: 6px; overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none; padding-bottom: 4px; margin-bottom: 14px;
}
.icons-cat-row::-webkit-scrollbar { display: none; }
.icon-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
}
.icon-card {
  background: var(--white); border: 1px solid var(--border);
  border-radius: var(--r); overflow: hidden; cursor: pointer;
  -webkit-tap-highlight-color: transparent; transition: all .18s;
  position: relative;
}
.icon-card:active { opacity: .85; transform: scale(.98); }
.icon-card.active-sel { border-color: var(--ink); border-width: 2px; }
.icon-photo {
  height: 160px; overflow: hidden; background: var(--s3);
  position: relative; display: flex; align-items: flex-end;
}
.icon-photo img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
.icon-photo-overlay {
  position: absolute; inset: 0;
  background: linear-gradient(transparent 40%, rgba(0,0,0,.72));
}
.icon-photo-name {
  position: absolute; bottom: 0; left: 0; right: 0;
  padding: 10px 11px;
  font-size: 13px; font-weight: 700; color: #fff; line-height: 1.2;
}
.icon-photo-cat {
  font-size: 9px; font-weight: 700; letter-spacing: .08em;
  text-transform: uppercase; color: rgba(255,255,255,.55);
  margin-bottom: 2px;
}
.icon-body { padding: 10px 11px; }
.icon-vibe { font-size: 11px; color: var(--ink2); line-height: 1.5; margin-bottom: 7px; }
.icon-tags { display: flex; gap: 4px; flex-wrap: wrap; }
.icon-tag {
  font-size: 9px; font-weight: 700; padding: 2px 7px;
  border-radius: 100px; background: var(--s2);
  color: var(--ink2); border: 1px solid var(--border);
}

/* ─── ICON DETAIL SHEET ─── */
.icon-sheet-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.6);
  backdrop-filter: blur(10px); z-index: 600;
  display: none; align-items: flex-end; justify-content: center;
  padding-bottom: var(--safe-bot);
}
.icon-sheet-overlay.open { display: flex; }
.icon-sheet {
  background: var(--white); border-radius: 22px 22px 0 0;
  width: 100%; max-width: 560px;
  max-height: 92vh; overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  animation: sheetUp .3s ease;
}
.icon-sheet-hero {
  height: 220px; position: relative; overflow: hidden;
  background: var(--s3);
}
.icon-sheet-hero img {
  width: 100%; height: 100%; object-fit: cover; object-position: top;
}
.icon-sheet-hero-overlay {
  position: absolute; inset: 0;
  background: linear-gradient(transparent 30%, rgba(0,0,0,.8));
}
.icon-sheet-hero-info {
  position: absolute; bottom: 16px; left: 18px; right: 18px;
}
.icon-sheet-close {
  position: absolute; top: 14px; right: 14px; z-index: 10;
  width: 32px; height: 32px; border-radius: 50%;
  background: rgba(255,255,255,.2); border: none; color: #fff;
  font-size: 16px; cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  -webkit-tap-highlight-color: transparent;
}
.icon-sheet-name { font-family: 'Cormorant Garamond', serif; font-size: 30px; font-weight: 300; color: #fff; line-height: 1.1; }
.icon-sheet-sub { font-size: 11px; color: rgba(255,255,255,.55); font-weight: 600; letter-spacing: .06em; text-transform: uppercase; margin-top: 2px; }
.icon-sheet-body { padding: 18px; }
.icon-tab-row { display: flex; gap: 4px; margin-bottom: 16px; background: var(--s2); border-radius: 10px; padding: 3px; }
.icon-tab {
  flex: 1; padding: 9px 6px; border: none; background: transparent;
  border-radius: 8px; font-size: 11px; font-weight: 700;
  font-family: 'Karla', sans-serif; cursor: pointer; color: var(--ink3);
  -webkit-tap-highlight-color: transparent; transition: all .18s;
}
.icon-tab.active { background: var(--white); color: var(--ink); box-shadow: 0 1px 4px rgba(0,0,0,.1); }
.icon-tab-content { display: none; }
.icon-tab-content.active { display: block; }
.match-section-title {
  font-size: 10px; font-weight: 700; letter-spacing: .1em; text-transform: uppercase;
  color: var(--ink3); margin: 14px 0 8px; display: flex; align-items: center; gap: 8px;
}
.match-section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.you-have-row {
  display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch;
  scrollbar-width: none; padding-bottom: 4px;
}
.you-have-row::-webkit-scrollbar { display: none; }
.you-have-item {
  flex-shrink: 0; width: 88px; border-radius: 10px;
  overflow: hidden; border: 1px solid var(--border);
}
.you-have-img {
  height: 88px; background: var(--s2); display: flex;
  align-items: center; justify-content: center; font-size: 26px;
  position: relative; overflow: hidden;
}
.you-have-img img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
.you-have-match { font-size: 9px; font-weight: 700; padding: 4px 7px; color: var(--ink2); }
.shop-item-card {
  display: flex; gap: 10px; padding: 10px;
  background: var(--s2); border-radius: 10px; margin-bottom: 7px;
  cursor: pointer; -webkit-tap-highlight-color: transparent;
}
.shop-item-card:active { background: var(--s3); }
.shop-item-ico {
  width: 52px; height: 62px; border-radius: 8px;
  background: var(--white); display: flex; align-items: center;
  justify-content: center; font-size: 24px; flex-shrink: 0;
  border: 1px solid var(--border); overflow: hidden;
}
.shop-item-ico img { width: 100%; height: 100%; object-fit: cover; }
.shop-item-name { font-size: 12px; font-weight: 700; margin-bottom: 2px; }
.shop-item-brand { font-size: 10px; color: var(--ink3); margin-bottom: 3px; }
.shop-price-row { display: flex; gap: 6px; align-items: center; }
.shop-price-badge {
  font-size: 9px; font-weight: 700; padding: 2px 6px;
  border-radius: 100px;
}
.badge-budget { background: #e8f4e8; color: #2a6c2a; }
.badge-mid { background: #e8eef8; color: #2a4a8c; }
.badge-invest { background: #f4ede8; color: #6c3a2a; }
.match-score-bar {
  display: flex; align-items: center; gap: 10px;
  background: var(--s2); border-radius: 10px; padding: 12px 14px; margin-bottom: 12px;
}
.match-score-ring {
  width: 52px; height: 52px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
}
.match-score-pct {
  font-family: 'Cormorant Garamond', serif; font-size: 19px; font-weight: 300;
}


/* iOS: prevent zoom on input focus — must be >= 16px */
@media screen and (-webkit-min-device-pixel-ratio: 0) {
  input[type="text"],
  input[type="email"],
  input[type="number"],
  input[type="password"],
  input[type="search"],
  input[type="url"],
  input[type="tel"],
  select,
  textarea {
    font-size: 16px !important;
  }
}


/* ─── iOS ADD TO HOME SCREEN BANNER ─── */
.ios-banner {
  display: none !important; /* Hidden - was blocking bottom nav */
}
.ios-banner-text { flex: 1; font-size: 12px; line-height: 1.5; }
.ios-banner-close { background: rgba(255,255,255,.15); border: none; color: #fff;
  width: 28px; height: 28px; border-radius: 50%; font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

</style>
</head>
<body>

<!-- ═══════════════════════════════════════
     ONBOARDING
═══════════════════════════════════════ -->
<div id="auth-screen">
  <div class="auth-container">
    <div class="auth-logo">
      <div class="auth-logo-text">Vesti<em>ary</em></div>
      <div class="auth-tagline">Your intelligent wardrobe, styled daily.</div>
    </div>
    
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="showAuthTab('login')">Log In</button>
      <button class="auth-tab" onclick="showAuthTab('signup')">Sign Up</button>
    </div>
    
    <div id="auth-error" class="auth-error"></div>
    
    <!-- Login Form -->
    <div id="login-form" class="auth-form active">
      <div class="auth-field">
        <label class="auth-label">Email</label>
        <input type="email" id="login-email" class="auth-input" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="auth-field">
        <label class="auth-label">Password</label>
        <input type="password" id="login-password" class="auth-input" placeholder="••••••••" autocomplete="current-password">
      </div>
      <button class="auth-btn" onclick="doLogin()">Log In</button>
    </div>
    
    <!-- Signup Form -->
    <div id="signup-form" class="auth-form">
      <div class="auth-field">
        <label class="auth-label">Email</label>
        <input type="email" id="signup-email" class="auth-input" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="auth-field">
        <label class="auth-label">Password</label>
        <input type="password" id="signup-password" class="auth-input" placeholder="At least 6 characters" autocomplete="new-password">
      </div>
      <button class="auth-btn" onclick="doSignup()">Create Account</button>
    </div>
    
    <div class="auth-divider">or</div>
    
    <div class="auth-skip">
      <button class="auth-skip-btn" onclick="skipAuth()">Continue without account</button>
    </div>
  </div>
</div>

<div id="onboarding">
  <div class="ob-progress"><div class="ob-progress-fill" id="ob-fill"></div></div>

  <!-- SPLASH -->
  <div class="ob-screen active" id="ob-0">
    <div class="ob-splash">
      <div class="ob-logo-mark">
        <svg width="48" height="48" viewBox="0 0 38 38" fill="none">
          <path d="M19 1L37 19L19 37L1 19Z" stroke="#0c0c0c" stroke-width="1.2"/>
          <path d="M19 8L28 19L19 30L10 19Z" stroke="#0c0c0c" stroke-width="0.7" opacity=".2"/>
          <path d="M19 12C19 12 21.5 10.5 21.5 13C21.5 14.5 19 15.2 19 15.2" stroke="#0c0c0c" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="11" y1="20.5" x2="27" y2="20.5" stroke="#0c0c0c" stroke-width="1.3" stroke-linecap="round"/>
          <path d="M19 15.2L11 20.5" stroke="#0c0c0c" stroke-width="1.3" stroke-linecap="round"/>
          <path d="M19 15.2L27 20.5" stroke="#0c0c0c" stroke-width="1.3" stroke-linecap="round"/>
          <circle cx="19" cy="1.8" r="1.2" fill="#0c0c0c"/>
          <circle cx="19" cy="36.2" r="1.2" fill="#0c0c0c"/>
          <circle cx="1.8" cy="19" r="1.2" fill="#0c0c0c"/>
          <circle cx="36.2" cy="19" r="1.2" fill="#0c0c0c"/>
        </svg>
      </div>
      <div class="ob-logo-text">Vesti<em>ary</em></div>
      <div class="ob-tagline">Your intelligent wardrobe, styled daily.</div>
      <div class="ob-start-hint">Takes about 3 minutes.<br>We'll build your full style profile<br>and save both your casual and dressy measurements.</div>
      <button onclick="goStep(1)" style="padding:17px 0;background:#0c0c0c;color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;font-family:'Karla',sans-serif;width:100%;max-width:340px;letter-spacing:.01em;">
        Get Started →
      </button>
    </div>
  </div>

  <!-- STEP 1: About You -->
  <div class="ob-screen" id="ob-1">
    <div class="ob-eyebrow">Step 1 of 4 — About You</div>
    <div class="ob-heading">Let's get<br><em>acquainted.</em></div>
    <div class="ob-sub">A few basics so Vestiary can personalize weather, events, and style suggestions.</div>
    <div class="ob-grid">
      <div class="ob-field">
        <div class="ob-label">First Name</div>
        <input class="ob-input" id="ob-fname" type="text" placeholder="James" autocomplete="given-name">
      </div>
      <div class="ob-field">
        <div class="ob-label">Last Name</div>
        <input class="ob-input" id="ob-lname" type="text" placeholder="Davis" autocomplete="family-name">
      </div>
      <div class="ob-field">
        <div class="ob-label">Age</div>
        <input class="ob-input" id="ob-age" type="number" placeholder="28">
      </div>
      <div class="ob-field">
        <div class="ob-label">City</div>
        <input class="ob-input" id="ob-city" type="text" placeholder="New York, NY">
      </div>
      <div class="ob-field span2">
        <div class="ob-label">Occupation</div>
        <input class="ob-input" id="ob-occ" type="text" placeholder="e.g. Marketing Director, Finance, Creative...">
      </div>
    </div>
    <div class="ob-footer">
      <div class="ob-step-label">Step 1 of 4</div>
      <button class="ob-btn ob-btn-primary" onclick="goStep(2)">Continue →</button>
    </div>
  </div>

  <!-- STEP 2: Casual Measurements -->
  <div class="ob-screen" id="ob-2">
    <div class="ob-eyebrow">Step 2 of 4 — Casual Fit</div>
    <div class="ob-heading">Your everyday<br><em>measurements.</em></div>
    <div class="ob-sub">Used to suggest the right sizes for casual pieces and flag fit issues.</div>
    <div class="ob-grid">
      <div class="ob-field span2">
        <div class="ob-label">Height</div>
        <div class="ob-input-row">
          <input class="ob-input" id="ob-ft" type="number" placeholder="5" style="max-width:70px">
          <div class="ob-unit">ft</div>
          <input class="ob-input" id="ob-in" type="number" placeholder="11" style="max-width:70px">
          <div class="ob-unit">in</div>
        </div>
      </div>
      <div class="ob-field">
        <div class="ob-label">T-Shirt / Crewneck</div>
        <select class="ob-input" id="ob-tshirt">
          <option>XS</option><option>S</option><option>M</option><option selected>L</option><option>XL</option><option>XXL</option>
        </select>
      </div>
      <div class="ob-field">
        <div class="ob-label">Trouser Waist</div>
        <div class="ob-input-row">
          <input class="ob-input" id="ob-cas-waist" type="number" placeholder="32">
          <div class="ob-unit">in</div>
        </div>
      </div>
      <div class="ob-field">
        <div class="ob-label">Inseam</div>
        <div class="ob-input-row">
          <input class="ob-input" id="ob-inseam" type="number" placeholder="32">
          <div class="ob-unit">in</div>
        </div>
      </div>
      <div class="ob-field">
        <div class="ob-label">Shoe Size (US)</div>
        <input class="ob-input" id="ob-shoe" type="number" placeholder="10.5" step="0.5">
      </div>
    </div>
    <div class="ob-footer">
      <div class="ob-step-label">Step 2 of 4</div>
      <div style="display:flex;gap:8px">
        <button class="ob-btn ob-btn-secondary" onclick="goStep(1)">← Back</button>
        <button class="ob-btn ob-btn-primary" onclick="goStep(3)">Continue →</button>
      </div>
    </div>
  </div>

  <!-- STEP 3: Dressy Measurements -->
  <div class="ob-screen" id="ob-3">
    <div class="ob-eyebrow">Step 3 of 4 — Dressy Fit</div>
    <div class="ob-heading">Your tailored<br><em>measurements.</em></div>
    <div class="ob-sub">For suit, dress shirt, and formal occasion suggestions. Approximate is fine.</div>
    <div class="ob-grid">
      <div class="ob-field">
        <div class="ob-label">Dress Shirt Neck</div>
        <div class="ob-input-row">
          <input class="ob-input" id="ob-neck" type="number" placeholder="15.5" step="0.5">
          <div class="ob-unit">in</div>
        </div>
      </div>
      <div class="ob-field">
        <div class="ob-label">Sleeve</div>
        <div class="ob-input-row">
          <input class="ob-input" id="ob-sleeve" type="number" placeholder="34">
          <div class="ob-unit">in</div>
        </div>
      </div>
      <div class="ob-field">
        <div class="ob-label">Suit / Blazer Size</div>
        <select class="ob-input" id="ob-suit">
          <option>36R</option><option>38R</option><option>40R</option><option selected>42R</option><option>44R</option><option>38L</option><option>40L</option><option>42L</option>
        </select>
      </div>
      <div class="ob-field">
        <div class="ob-label">Dress Trouser Waist</div>
        <div class="ob-input-row">
          <input class="ob-input" id="ob-dress-waist" type="number" placeholder="33">
          <div class="ob-unit">in</div>
        </div>
      </div>
      <div class="ob-field">
        <div class="ob-label">Chest</div>
        <div class="ob-input-row">
          <input class="ob-input" id="ob-chest" type="number" placeholder="40">
          <div class="ob-unit">in</div>
        </div>
      </div>
      <div class="ob-field">
        <div class="ob-label">Preferred Fit</div>
        <select class="ob-input" id="ob-fit-pref">
          <option>Slim</option><option selected>Regular / Modern</option><option>Relaxed</option><option>Athletic</option>
        </select>
      </div>
    </div>
    <div class="ob-footer">
      <div class="ob-step-label">Step 3 of 4</div>
      <div style="display:flex;gap:8px">
        <button class="ob-btn ob-btn-secondary" onclick="goStep(2)">← Back</button>
        <button class="ob-btn ob-btn-primary" onclick="goStep(4)">Continue →</button>
      </div>
    </div>
  </div>

  <!-- STEP 4: Work Schedule -->
  <div class="ob-screen" id="ob-4">
    <div class="ob-eyebrow">Step 4 of 5 — Work Style</div>
    <div class="ob-heading">What's your<br><em>work dress code?</em></div>
    <div class="ob-sub">This helps us suggest the right outfits for your schedule.</div>
    
    <div class="ob-field" style="margin-bottom:20px">
      <div class="ob-label">Office Dress Code</div>
      <select class="ob-input" id="ob-dress-code">
        <option value="casual">Casual (jeans, sneakers OK)</option>
        <option value="smart-casual" selected>Smart Casual (chinos, no tie)</option>
        <option value="business-casual">Business Casual (dress shirt, slacks)</option>
        <option value="business">Business Professional (suit required)</option>
        <option value="none">No dress code / Remote only</option>
      </select>
    </div>
    
    <div class="ob-label" style="margin-bottom:10px">Which days do you work from home or dress casual?</div>
    <div class="ob-wfh-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:24px">
      <div class="ob-wfh-day" data-day="0" onclick="toggleWfhDay(this)"><div class="ob-wfh-name">Sun</div><div class="ob-wfh-check">✓</div></div>
      <div class="ob-wfh-day" data-day="1" onclick="toggleWfhDay(this)"><div class="ob-wfh-name">Mon</div><div class="ob-wfh-check">✓</div></div>
      <div class="ob-wfh-day" data-day="2" onclick="toggleWfhDay(this)"><div class="ob-wfh-name">Tue</div><div class="ob-wfh-check">✓</div></div>
      <div class="ob-wfh-day" data-day="3" onclick="toggleWfhDay(this)"><div class="ob-wfh-name">Wed</div><div class="ob-wfh-check">✓</div></div>
      <div class="ob-wfh-day" data-day="4" onclick="toggleWfhDay(this)"><div class="ob-wfh-name">Thu</div><div class="ob-wfh-check">✓</div></div>
      <div class="ob-wfh-day active" data-day="5" onclick="toggleWfhDay(this)"><div class="ob-wfh-name">Fri</div><div class="ob-wfh-check">✓</div></div>
      <div class="ob-wfh-day active" data-day="6" onclick="toggleWfhDay(this)"><div class="ob-wfh-name">Sat</div><div class="ob-wfh-check">✓</div></div>
    </div>
    
    <div class="ob-label" style="margin-bottom:10px">Any special dress requirements?</div>
    <div class="ob-check-grid" style="display:flex;flex-direction:column;gap:8px;margin-bottom:24px">
      <label class="ob-checkbox"><input type="checkbox" id="ob-client-facing"> Client/customer facing role</label>
      <label class="ob-checkbox"><input type="checkbox" id="ob-creative"> Creative industry (more flexibility)</label>
      <label class="ob-checkbox"><input type="checkbox" id="ob-outdoor"> Sometimes work outdoors</label>
    </div>
    
    <div class="ob-footer">
      <div class="ob-step-label">Step 4 of 5</div>
      <div style="display:flex;gap:8px">
        <button class="ob-btn ob-btn-secondary" onclick="goStep(3)">← Back</button>
        <button class="ob-btn ob-btn-primary" onclick="goStep(5)">Continue →</button>
      </div>
    </div>
  </div>

  <!-- STEP 5: Style Quiz -->
  <div class="ob-screen" id="ob-5">
    <div class="ob-eyebrow">Step 5 of 5 — Style Profile</div>
    <div class="ob-heading">Which aesthetic<br><em>speaks to you?</em></div>
    <div class="ob-sub">Select all that resonate. We blend these into your personal style profile.</div>
    <div class="ob-moods">

      <div class="ob-mood" data-mood="ald" onclick="toggleMood(this)">
        <div class="ob-mood-img" style="background:#c8bfae;overflow:hidden">
          <img src="https://images.squarespace-cdn.com/content/v1/586e3964440243ad6f24c6f5/1597253837872-YPIKR4VKUQYY8YG96TYT/ALD.jpg" alt="ALD style" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
        </div>
        <div class="ob-mood-body"><div class="ob-mood-name">Uptown Prep</div><div class="ob-mood-desc">ALD, earthy tones, sport refs</div></div>
        <div class="ob-mood-check">✓</div>
      </div>

      <div class="ob-mood" data-mood="old-money" onclick="toggleMood(this)">
        <div class="ob-mood-img" style="background:#d5ccbe;overflow:hidden">
          <img src="https://images.unsplash.com/photo-1617137968427-85924c800a22?w=400&q=80" alt="Old money" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
        </div>
        <div class="ob-mood-body"><div class="ob-mood-name">Old Money</div><div class="ob-mood-desc">Understated wealth, heritage pieces</div></div>
        <div class="ob-mood-check">✓</div>
      </div>

      <div class="ob-mood" data-mood="streetwear" onclick="toggleMood(this)">
        <div class="ob-mood-img" style="background:#1f1f1f;overflow:hidden">
          <img src="https://images.unsplash.com/photo-1523398002811-999ca8dec234?w=400&q=80" alt="Streetwear" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
        </div>
        <div class="ob-mood-body"><div class="ob-mood-name">Streetwear</div><div class="ob-mood-desc">Sneakers, graphic tees, oversized</div></div>
        <div class="ob-mood-check">✓</div>
      </div>

      <div class="ob-mood" data-mood="business" onclick="toggleMood(this)">
        <div class="ob-mood-img" style="background:#2c2c2c;overflow:hidden">
          <img src="https://images.unsplash.com/photo-1507679799987-c73779587ccf?w=400&q=80" alt="Business" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
        </div>
        <div class="ob-mood-body"><div class="ob-mood-name">Business / Tailored</div><div class="ob-mood-desc">Suits, dress shirts, sharp lines</div></div>
        <div class="ob-mood-check">✓</div>
      </div>

      <div class="ob-mood" data-mood="minimal" onclick="toggleMood(this)">
        <div class="ob-mood-img" style="background:#e8e8e6;overflow:hidden">
          <img src="https://images.unsplash.com/photo-1490578474895-699cd4e2cf59?w=400&q=80" alt="Minimal" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
        </div>
        <div class="ob-mood-body"><div class="ob-mood-name">Minimalist</div><div class="ob-mood-desc">COS, Uniqlo, clean neutrals</div></div>
        <div class="ob-mood-check">✓</div>
      </div>

      <div class="ob-mood" data-mood="workwear" onclick="toggleMood(this)">
        <div class="ob-mood-img" style="background:#4a3c2c;overflow:hidden">
          <img src="https://images.unsplash.com/photo-1516257984-b1b4d707412e?w=400&q=80" alt="Workwear" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
        </div>
        <div class="ob-mood-body"><div class="ob-mood-name">Heritage / Workwear</div><div class="ob-mood-desc">Carhartt, Filson, rugged classics</div></div>
        <div class="ob-mood-check">✓</div>
      </div>

      <div class="ob-mood" data-mood="coastal" onclick="toggleMood(this)">
        <div class="ob-mood-img" style="background:#6d9db1;overflow:hidden">
          <img src="https://images.unsplash.com/photo-1529374255404-311a2a4f1fd9?w=400&q=80" alt="Coastal" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
        </div>
        <div class="ob-mood-body"><div class="ob-mood-name">Coastal / Surf-Prep</div><div class="ob-mood-desc">Noah, linen, nautical, relaxed</div></div>
        <div class="ob-mood-check">✓</div>
      </div>

      <div class="ob-mood" data-mood="avant" onclick="toggleMood(this)">
        <div class="ob-mood-img" style="background:#111;overflow:hidden">
          <img src="https://images.unsplash.com/photo-1539109136881-3be0616acf4b?w=400&q=80" alt="Avant-garde" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
        </div>
        <div class="ob-mood-body"><div class="ob-mood-name">Avant-garde / Dark</div><div class="ob-mood-desc">Rick Owens, CdG, statement cuts</div></div>
        <div class="ob-mood-check">✓</div>
      </div>

      <div class="ob-mood" data-mood="smart-casual" onclick="toggleMood(this)">
        <div class="ob-mood-img" style="background:#c4b8a8;overflow:hidden">
          <img src="https://images.unsplash.com/photo-1552374196-1ab2a1c593e8?w=400&q=80" alt="Smart casual" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
        </div>
        <div class="ob-mood-body"><div class="ob-mood-name">Smart Casual</div><div class="ob-mood-desc">Blazer over tee, chinos, loafers</div></div>
        <div class="ob-mood-check">✓</div>
      </div>

    </div>
    <div class="ob-footer">
      <div class="ob-step-label">Step 5 of 5</div>
      <div style="display:flex;gap:8px">
        <button class="ob-btn ob-btn-secondary" onclick="goStep(4)">← Back</button>
        <button class="ob-btn ob-btn-primary" onclick="finishOnboarding()">Enter Vestiary →</button>
      </div>
    </div>
  </div>

</div><!-- /onboarding -->

<!-- ═══════════════════════════════════════
     APP
═══════════════════════════════════════ -->
<div id="app">

  <header class="app-header">
    <div class="header-logo">Vesti<em>ary</em></div>
    <div class="header-right">
      <div class="header-pill" onclick="showPage('brands')">
        <div class="header-pill-dot"></div>
        <span id="style-label">ALD / Prep</span>
      </div>
      <div class="header-avatar" id="hdr-avatar">JD</div>
    </div>
  </header>

  <div class="app-main">

    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="pg-header">
        <div><div class="pg-eyebrow">Good Morning</div><div class="pg-title">Wednesday, Feb 18</div></div>
        <button class="btn btn-outline" onclick="openUpload()">+ Add</button>
      </div>
      <div class="weather-card">
        <div>
          <div class="w-lbl">St. Louis, MO</div>
          <div class="w-temp">41°</div>
          <div class="w-cond">Partly cloudy · Feels 36°</div>
          <div class="w-rec">🧥 Layer up — trench weather</div>
        </div>
        <div class="w-days">
          <div class="w-day"><div class="w-day-name">Thu</div><div class="w-day-ico">🌦</div><div class="w-day-temps"><span class="w-hi">45°</span><span class="w-lo">32°</span></div></div>
          <div class="w-day"><div class="w-day-name">Fri</div><div class="w-day-ico">☀️</div><div class="w-day-temps"><span class="w-hi">52°</span><span class="w-lo">38°</span></div></div>
          <div class="w-day"><div class="w-day-name">Sat</div><div class="w-day-ico">⛅</div><div class="w-day-temps"><span class="w-hi">49°</span><span class="w-lo">35°</span></div></div>
        </div>
      </div>
      <div class="home-stats">
        <div class="stat-card"><div class="stat-label">Closet</div><div class="stat-value" id="stat-items">0</div><div class="stat-sub">items</div></div>
        <div class="stat-card"><div class="stat-label">Outfits</div><div class="stat-value" id="stat-outfits">0</div><div class="stat-sub">combinations</div></div>
      </div>
      <div class="today-card" id="today-outfit-card">
        <div class="pg-eyebrow" style="margin-bottom:3px">Today's Outfit</div>
        <div id="today-outfit-name" style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:300">No outfit planned</div>
        <div class="today-items" id="today-outfit-items">
          <div style="text-align:center;padding:20px;color:var(--ink4);font-size:12px;width:100%">Tap to plan today's outfit</div>
        </div>
        <div class="today-actions">
          <button class="btn btn-dark" onclick="openOutfitPicker(getTodayKey())">Plan Outfit</button>
          <button class="btn btn-outline" onclick="showPage('builder')">Build New</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">This Week</div>
        <div class="week-row" id="week-row"></div>
      </div>
    </div>

    <!-- CLOSET -->
    <div class="page" id="page-closet">
      <div class="pg-header">
        <div><div class="pg-eyebrow">My Wardrobe</div><div class="pg-title">Closet</div></div>
        <button class="btn btn-dark" onclick="openUpload()">+ Add</button>
      </div>
      <div class="filter-row">
        <div class="chip active" onclick="filterCloset(this)">All</div>
        <div class="chip" onclick="filterCloset(this)">Tops</div>
        <div class="chip" onclick="filterCloset(this)">Bottoms</div>
        <div class="chip" onclick="filterCloset(this)">Outerwear</div>
        <div class="chip" onclick="filterCloset(this)">Footwear</div>
        <div class="chip" onclick="filterCloset(this)">Accessories</div>
      </div>
      <div class="closet-grid" id="closet-grid"></div>
    </div>

    <!-- OUTFITS -->
    <div class="page" id="page-outfits">
      <div class="pg-header">
        <div><div class="pg-eyebrow">Styled For You</div><div class="pg-title">Outfits</div></div>
        <button class="btn btn-dark" onclick="renderOutfitsPage()">✦ Refresh</button>
      </div>
      
      <!-- Empty state -->
      <div id="outfits-empty" style="display:none;text-align:center;padding:60px 20px">
        <div style="font-size:48px;margin-bottom:16px">👔</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:300;margin-bottom:8px">Add items to get styled</div>
        <div style="font-size:13px;color:var(--ink3);margin-bottom:24px">We need at least 2 items in your closet to create outfit suggestions.</div>
        <button class="btn btn-dark" onclick="showPage('closet',null);openUpload()">Add Items →</button>
      </div>
      
      <!-- Curated outfits -->
      <div id="outfits-content">
        <div style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink3);margin-bottom:10px">Curated From Your Closet</div>
        <div class="outfit-scroll" id="curated-outfits"></div>
        
        <div style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink3);margin:20px 0 10px">Saved Outfits</div>
        <div class="outfit-scroll" id="saved-outfits-display"></div>
      </div>
    </div>

    <!-- PLANNER -->
    <div class="page" id="page-planner">
      <div class="pg-header"><div><div class="pg-eyebrow">Outfit Calendar</div><div class="pg-title">Planner</div></div></div>
      
      <div class="month-nav">
        <button class="month-nav-btn" onclick="changeMonth(-1)">←</button>
        <div class="month-title" id="planner-month-title">February 2026</div>
        <button class="month-nav-btn" onclick="changeMonth(1)">→</button>
      </div>
      
      <div class="calendar-grid" id="calendar-grid">
        <div class="calendar-header">Sun</div>
        <div class="calendar-header">Mon</div>
        <div class="calendar-header">Tue</div>
        <div class="calendar-header">Wed</div>
        <div class="calendar-header">Thu</div>
        <div class="calendar-header">Fri</div>
        <div class="calendar-header">Sat</div>
      </div>
    </div>

    <!-- STATS -->
    <div class="page" id="page-stats">
      <div class="pg-header"><div><div class="pg-eyebrow">Wardrobe Intelligence</div><div class="pg-title">Stats</div></div><button class="btn btn-outline" onclick="openDeclutterMode()">Declutter</button></div>
      <div id="stats-empty" style="display:none;text-align:center;padding:60px 20px">
        <div style="font-size:48px;margin-bottom:16px">&#x1F4CA;</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:300;margin-bottom:8px">No data yet</div>
        <div style="font-size:13px;color:var(--ink3);margin-bottom:24px">Add items to your closet, wear them, and your stats will appear here.</div>
        <button class="btn btn-dark" onclick="showPage('closet',null);openUpload()">Add First Item</button>
      </div>
      <div id="stats-content">
        <div class="stats-grid" id="stats-summary-grid" style="margin-bottom:12px"></div>
        <div class="card" style="margin-bottom:12px">
          <div class="card-title">Wear Frequency</div>
          <div id="wear-bars"></div>
        </div>
        <div class="card" style="margin-bottom:12px">
          <div class="card-title">Cost Per Wear</div>
          <div id="cpw-rows"></div>
        </div>
        <div class="card" style="margin-bottom:12px">
          <div class="card-title">Category Breakdown</div>
          <div id="cat-breakdown"></div>
        </div>
        <div class="card" style="margin-bottom:12px">
          <div class="card-title">Unloved Items</div>
          <div class="unloved-row" id="unloved-row"></div>
        </div>
        
        <!-- Declutter Suggestions -->
        <div class="card" id="declutter-card" style="background:linear-gradient(135deg, #fef3e2 0%, #fce8d0 100%);border:none">
          <div class="card-title" style="display:flex;align-items:center;gap:8px">
            <span>🧹</span> Time to Declutter?
          </div>
          <div style="font-size:12px;color:var(--ink2);margin-bottom:12px">
            Items you haven't worn that could find a new home.
          </div>
          <div id="declutter-suggestions"></div>
          <button class="btn btn-dark" style="width:100%;margin-top:12px" onclick="openDeclutterMode()">
            Review All Unworn Items →
          </button>
        </div>
      </div>
    </div>

    <!-- PACKING -->
    <div class="page" id="page-packing">
      <div class="pg-header"><div><div class="pg-eyebrow">Travel Assistant</div><div class="pg-title">Packing</div></div></div>
      <div class="pack-form">
        <div class="pack-field"><label class="pack-label">Destination</label><input class="pack-input" id="pack-dest" type="text" placeholder="New York, NY"></div>
        <div class="pack-field"><label class="pack-label">Nights</label><input class="pack-input" id="pack-nights" type="number" placeholder="4" style="max-width:100px"></div>
        <div class="pack-field">
          <label class="pack-label">Trip Type</label>
          <div class="pack-types">
            <div class="pack-type active" onclick="selectPackType(this)"><div class="pack-type-ico">💼</div><div class="pack-type-lbl">Business</div></div>
            <div class="pack-type" onclick="selectPackType(this)"><div class="pack-type-ico">🏖</div><div class="pack-type-lbl">Vacation</div></div>
            <div class="pack-type" onclick="selectPackType(this)"><div class="pack-type-ico">🏙</div><div class="pack-type-lbl">City</div></div>
            <div class="pack-type" onclick="selectPackType(this)"><div class="pack-type-ico">🏔</div><div class="pack-type-lbl">Outdoors</div></div>
          </div>
        </div>
        <button class="btn btn-dark" style="width:100%;padding:13px;border-radius:10px;font-size:13px" onclick="buildPack()">Build My Capsule ✦</button>
      </div>
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Capsule Items</div>
        <div class="pack-grid" id="pack-grid"></div>
      </div>
      <div class="card">
        <div class="card-title">Day by Day</div>
        <div id="pack-days"></div>
      </div>
    </div>

    <!-- GAPS -->
    <div class="page" id="page-gaps">
      <div class="pg-header"><div><div class="pg-eyebrow">Wardrobe Analysis</div><div class="pg-title">Gap Analysis</div></div></div>
      <div class="gap-score">
        <div class="gap-ring"><div class="gap-ring-inner"><div class="gap-ring-pct">68%</div><div class="gap-ring-lbl">Complete</div></div></div>
        <div>
          <div class="gap-score-title">Well-built, with key gaps</div>
          <div class="gap-score-sub">Strong on smart-casual. Missing formal options and footwear range.</div>
        </div>
      </div>
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Missing Essentials</div>
        <div id="gap-essentials"></div>
      </div>
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Category Balance</div>
        <div id="gap-cats"></div>
      </div>
      <div class="card">
        <div class="card-title">Upgrade Opportunities</div>
        <div id="gap-upgrades"></div>
      </div>
    </div>

    <!-- CALENDAR -->
    <div class="page" id="page-calendar">
      <div class="pg-header"><div><div class="pg-eyebrow">Smart Scheduling</div><div class="pg-title">Calendar</div></div></div>
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Connected Calendars</div>
        <div class="sync-item"><div class="sync-ico">📅</div><div><div class="sync-name">Google Calendar</div><div class="sync-desc">Personal · Work</div></div><div class="sync-status sync-on">● Connected</div></div>
        <div class="sync-item"><div class="sync-ico">🍎</div><div><div class="sync-name">Apple Calendar</div><div class="sync-desc">iCloud sync</div></div><div class="sync-status sync-off">Connect →</div></div>
        <div class="sync-item"><div class="sync-ico">📧</div><div><div class="sync-name">Outlook</div><div class="sync-desc">Work calendar</div></div><div class="sync-status sync-off">Connect →</div></div>
      </div>
      <div class="card">
        <div class="card-title">Upcoming Events</div>
        <div class="event-item"><div class="event-dot"></div><div><div class="event-name">Dinner Out</div><div class="event-time">Tonight · 7:30 PM</div><div class="event-cta" onclick="showToast('Getting outfit for Dinner Out...')">Get outfit suggestion →</div></div></div>
        <div class="event-item"><div class="event-dot"></div><div><div class="event-name">Happy Hour</div><div class="event-time">Fri Feb 20 · 5:00 PM</div><div class="event-cta" onclick="showToast('Getting outfit for Happy Hour...')">Get outfit suggestion →</div></div></div>
        <div class="event-item"><div class="event-dot dim"></div><div><div class="event-name">Brunch with James</div><div class="event-time">Sun Feb 22 · 11:00 AM</div><div class="event-cta" onclick="showToast('Getting outfit...')">Get outfit suggestion →</div></div></div>
        <div class="event-item"><div class="event-dot dim"></div><div><div class="event-name">Client Presentation</div><div class="event-time">Mon Feb 23 · 9:00 AM</div><div class="event-cta" onclick="showToast('Getting outfit...')">Get outfit suggestion →</div></div></div>
      </div>
    </div>

    <!-- BRANDS -->
    <div class="page" id="page-brands">
      <div class="brands-hero">
        <div class="brands-hero-title">Pick your brand.<br><em style="font-style:italic">We'll dress you in it.</em></div>
        <div class="brands-hero-sub">Tap any brand to activate an override — every suggestion routes through that aesthetic.</div>
      </div>
      <div class="override-bar" id="override-bar" style="display:none">
        <div style="width:6px;height:6px;border-radius:50%;background:var(--ink);flex-shrink:0"></div>
        <div style="flex:1"><div style="font-size:13px;font-weight:700" id="override-name">—</div><div style="font-size:11px;color:var(--ink3)">Override active</div></div>
        <button class="btn btn-outline" onclick="clearOverride()" style="font-size:11px">Clear</button>
      </div>
      <div id="brand-tiers"></div>
      <div id="brand-dashboard" style="display:none;margin-top:20px">
        <div class="card-title" style="margin-bottom:10px">Brand Partner Dashboard</div>
        <div class="dash-hero"><div class="dash-ico" id="dash-ico">🏙</div><div><div class="dash-name" id="dash-name">Aimé Leon Dore</div><div class="dash-sub">Brand Partner · Active Override</div></div></div>
        <div class="dash-stats">
          <div class="dash-stat"><div class="dash-stat-label">Matched Users</div><div class="dash-stat-val">2.4K</div><div class="dash-stat-sub">match your aesthetic</div></div>
          <div class="dash-stat"><div class="dash-stat-label">Avg Order Value</div><div class="dash-stat-val">$312</div><div class="dash-stat-sub">from Vestiary</div></div>
          <div class="dash-stat"><div class="dash-stat-label">Click-Through</div><div class="dash-stat-val">18%</div><div class="dash-stat-sub">on collab cards</div></div>
          <div class="dash-stat"><div class="dash-stat-label">Gap Matches</div><div class="dash-stat-val">4</div><div class="dash-stat-sub">items users need</div></div>
        </div>
        <div class="card" style="margin-bottom:10px"><div class="card-title">Style Match</div><div id="dash-matches"></div></div>
        <div class="card"><div class="card-title">Top Recommended</div><div id="dash-recs"></div></div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="page" id="page-profile">
      <div class="pg-header"><div><div class="pg-eyebrow">Your Account</div><div class="pg-title">Profile</div></div><button class="btn btn-outline" onclick="showToast('Edit profile...')">Edit</button></div>
      <div class="card" style="margin-bottom:12px">
        <div class="profile-avatar-wrap">
          <div class="profile-avatar" id="profile-avatar">JD</div>
          <div><div class="profile-name" id="profile-name">James Davis</div><div class="profile-style-lbl" id="profile-style">ALD / Prep · New York, NY</div></div>
        </div>
        <div class="divider"></div>
        <div class="meas-section">
          <div class="meas-title">Casual Fit</div>
          <div class="meas-grid" id="casual-meas">
            <div class="meas-item"><div class="meas-item-label">T-Shirt</div><div class="meas-item-val">L</div></div>
            <div class="meas-item"><div class="meas-item-label">Waist</div><div class="meas-item-val">32"</div></div>
            <div class="meas-item"><div class="meas-item-label">Inseam</div><div class="meas-item-val">32"</div></div>
            <div class="meas-item"><div class="meas-item-label">Shoe</div><div class="meas-item-val">10.5</div></div>
          </div>
        </div>
        <div class="meas-section">
          <div class="meas-title">Dressy Fit</div>
          <div class="meas-grid" id="dressy-meas">
            <div class="meas-item"><div class="meas-item-label">Suit</div><div class="meas-item-val">42R</div></div>
            <div class="meas-item"><div class="meas-item-label">Neck</div><div class="meas-item-val">15.5"</div></div>
            <div class="meas-item"><div class="meas-item-label">Sleeve</div><div class="meas-item-val">34"</div></div>
            <div class="meas-item"><div class="meas-item-label">Chest</div><div class="meas-item-val">40"</div></div>
          </div>
        </div>
        <button class="btn btn-outline" style="width:100%;padding:12px;border-radius:10px;margin-top:8px" onclick="showToast('Opening measurements editor...')">Update Measurements</button>
      </div>
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Notifications</div>
        <div class="notif-row"><div><div class="notif-title">Daily outfit suggestion</div><div class="notif-sub">7:30 AM push notification</div></div><div class="toggle on" onclick="this.classList.toggle('on');this.classList.toggle('off')"><div class="toggle-thumb"></div></div></div>
        <div class="notif-row"><div><div class="notif-title">Event outfit reminder</div><div class="notif-sub">Night before detected events</div></div><div class="toggle on" onclick="this.classList.toggle('on');this.classList.toggle('off')"><div class="toggle-thumb"></div></div></div>
        <div class="notif-row"><div><div class="notif-title">Brand collab drops</div><div class="notif-sub">New matched items</div></div><div class="toggle off" onclick="this.classList.toggle('on');this.classList.toggle('off')"><div class="toggle-thumb"></div></div></div>
      </div>

      <div class="card">
        <div class="card-title">AI Photo Identification</div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
          <div style="width:34px;height:34px;border-radius:8px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">✦</div>
          <div style="flex:1">
            <div style="font-size:13px;font-weight:700">Powered by Claude AI</div>
            <div id="server-status-badge" style="font-size:11px;color:var(--ink3);margin-top:2px">Tap to check connection</div>
          </div>
          <button onclick="checkServerStatus()" class="btn btn-outline" style="font-size:11px;padding:7px 12px">Ping</button>
        </div>
        <div style="font-size:11px;color:var(--ink3);line-height:1.7;padding:10px 0 6px">
          AI identification runs through the Vestiary server — no API key needed on your device.
        </div>
        <button class="btn btn-outline" onclick="openUpload()" style="width:100%;padding:11px;border-radius:10px;font-size:12px;margin-top:4px">
          Test AI Upload →
        </button>
      </div>

      <!-- Account Actions -->
      <div class="card" id="account-actions-card">
        <div class="card-title">Account</div>
        <div id="account-info" style="font-size:12px;color:var(--ink3);margin-bottom:12px"></div>
        <button id="logout-btn" class="btn btn-outline" onclick="logout()" style="width:100%;padding:11px;border-radius:10px;font-size:12px;display:none">
          Log Out
        </button>
        <button id="login-btn" class="btn btn-dark" onclick="showLoginScreen()" style="width:100%;padding:11px;border-radius:10px;font-size:12px">
          Log In / Sign Up
        </button>
      </div>
      
      <!-- Version number (tap 5x to unlock dev mode) -->
      <div onclick="secretDevTap()" style="text-align:center;padding:20px;cursor:default">
        <div style="font-size:11px;color:var(--ink4)">Vestiary v2.0</div>
      </div>
    </div>



    <!-- ICONS: Celebrity Style -->
    <div class="page" id="page-icons">
      <div class="pg-header">
        <div><div class="pg-eyebrow">Get Inspired</div><div class="pg-title">Style Icons</div></div>
      </div>
      
      <!-- MATCH THIS LOOK - Photo Upload -->
      <div class="card" style="margin-bottom:16px;background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);color:#fff;border:none">
        <div style="display:flex;align-items:center;gap:14px">
          <div style="width:50px;height:50px;border-radius:12px;background:rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;font-size:24px">📸</div>
          <div style="flex:1">
            <div style="font-size:14px;font-weight:700;margin-bottom:2px">Match This Look</div>
            <div style="font-size:11px;opacity:0.7">Upload any photo & we'll find matching items from your closet</div>
          </div>
        </div>
        <button onclick="openMatchLookUpload()" class="btn" style="width:100%;margin-top:14px;padding:12px;background:rgba(255,255,255,0.15);color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:10px;font-size:13px;font-weight:600">
          Upload a Photo →
        </button>
      </div>
      
      <div class="icons-search">
        <input class="icons-search-input" id="icons-search" type="search" placeholder="Search a name or aesthetic..." oninput="filterIcons(this.value)">
      </div>
      <div class="icons-cat-row" id="icons-cat-row">
        <div class="chip active" onclick="filterIconCat(this,'all')">All</div>
        <div class="chip" onclick="filterIconCat(this,'musician')">Musicians</div>
        <div class="chip" onclick="filterIconCat(this,'athlete')">Athletes</div>
        <div class="chip" onclick="filterIconCat(this,'actor')">Actors</div>
        <div class="chip" onclick="filterIconCat(this,'creative')">Creatives</div>
        <div class="chip" onclick="filterIconCat(this,'business')">Business</div>
      </div>
      <div class="icon-grid" id="icon-grid"></div>
    </div>

    <!-- BUILD OUTFIT -->
    <div class="page" id="page-builder">
      <div class="pg-header"><div><div class="pg-eyebrow">Mix & Match</div><div class="pg-title">Build an Outfit</div></div><button class="btn btn-dark" onclick="saveBuiltOutfit()" id="save-outfit-btn" style="display:none">Save Outfit ✓</button></div>
      <div id="builder-empty" style="text-align:center;padding:60px 20px">
        <div style="font-size:48px;margin-bottom:16px">👕</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:300;margin-bottom:8px">Your closet is empty</div>
        <div style="font-size:13px;color:var(--ink3);margin-bottom:24px">Add items to your closet first, then come back here to build outfits.</div>
        <button class="btn btn-dark" onclick="showPage('closet',null);openUpload()">Add Items →</button>
      </div>
      <div id="builder-active" style="display:none">
        <!-- Canvas: currently selected items -->
        <div class="card" style="margin-bottom:14px">
          <div class="card-title">Your Outfit Canvas</div>
          <div id="outfit-canvas" style="min-height:100px;display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start"></div>
          <div id="canvas-empty" style="text-align:center;padding:24px;color:var(--ink4);font-size:13px">Tap items below to add them →</div>
        </div>
        <!-- Category filter -->
        <div class="filter-row" id="builder-filters">
          <div class="chip active" onclick="builderFilter(this,'all')">All</div>
          <div class="chip" onclick="builderFilter(this,'Tops')">Tops</div>
          <div class="chip" onclick="builderFilter(this,'Bottoms')">Bottoms</div>
          <div class="chip" onclick="builderFilter(this,'Outerwear')">Outerwear</div>
          <div class="chip" onclick="builderFilter(this,'Footwear')">Footwear</div>
          <div class="chip" onclick="builderFilter(this,'Accessories')">Accessories</div>
        </div>
        <!-- Item picker grid -->
        <div style="font-size:10px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--ink3);margin-bottom:10px">Tap to Add / Remove</div>
        <div class="closet-grid" id="builder-grid"></div>
      </div>
    </div>

    <!-- STYLE COACH (Premium) -->
    <div class="page" id="page-coach">
      <div class="pg-header"><div><div class="pg-eyebrow">Premium Feature</div><div class="pg-title">Style Coach</div></div></div>

      <!-- Upsell banner (shown when not premium) -->
      <div id="coach-upsell" style="background:var(--ink);color:#fff;border-radius:16px;padding:28px 22px;margin-bottom:16px;position:relative;overflow:hidden">
        <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 80% 20%, rgba(255,255,255,.07), transparent 60%);pointer-events:none"></div>
        <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:10px">✦ Vestiary Premium</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:30px;font-weight:300;line-height:1.1;margin-bottom:10px">Your personal stylist,<br><em style="font-style:italic">always on call.</em></div>
        <div style="font-size:13px;color:rgba(255,255,255,.55);line-height:1.8;margin-bottom:22px">Chat directly with a certified personal stylist who knows your entire wardrobe, measurements, and style profile. Get outfit advice, shopping recommendations, and honest feedback — anytime.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:22px">
          <div style="background:rgba(255,255,255,.08);border-radius:10px;padding:12px"><div style="font-size:18px;margin-bottom:5px">💬</div><div style="font-size:12px;font-weight:700">Unlimited Chat</div><div style="font-size:10px;color:rgba(255,255,255,.45);margin-top:2px">Message anytime</div></div>
          <div style="background:rgba(255,255,255,.08);border-radius:10px;padding:12px"><div style="font-size:18px;margin-bottom:5px">👁</div><div style="font-size:12px;font-weight:700">Closet Aware</div><div style="font-size:10px;color:rgba(255,255,255,.45);margin-top:2px">Knows your items</div></div>
          <div style="background:rgba(255,255,255,.08);border-radius:10px;padding:12px"><div style="font-size:18px;margin-bottom:5px">📐</div><div style="font-size:12px;font-weight:700">Fit Advisor</div><div style="font-size:10px;color:rgba(255,255,255,.45);margin-top:2px">Uses your measurements</div></div>
          <div style="background:rgba(255,255,255,.08);border-radius:10px;padding:12px"><div style="font-size:18px;margin-bottom:5px">🛍</div><div style="font-size:12px;font-weight:700">Shop Curation</div><div style="font-size:10px;color:rgba(255,255,255,.45);margin-top:2px">Curated just for you</div></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <button onclick="subscribePremium('monthly')" style="width:100%;padding:15px;background:#fff;color:#0c0c0c;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Karla',sans-serif">
            Start for $14.99 / month
          </button>
          <button onclick="subscribePremium('yearly')" style="width:100%;padding:15px;background:rgba(255,255,255,.12);color:#fff;border:2px solid rgba(255,255,255,.2);border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Karla',sans-serif">
            $99.99 / year — Save 44% 🔥
          </button>
        </div>
        <div style="text-align:center;font-size:10px;color:rgba(255,255,255,.3);margin-top:12px">Cancel anytime · 7-day free trial included</div>
      </div>

      <!-- Chat UI (shown when premium active) -->
      <div id="coach-chat" style="display:none;flex-direction:column;height:calc(100vh - 200px)">
        <div style="background:var(--s2);border-radius:12px;padding:12px 14px;margin-bottom:12px;display:flex;align-items:center;gap:10px">
          <div style="width:38px;height:38px;border-radius:50%;background:var(--ink);color:#fff;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">✦</div>
          <div><div style="font-size:13px;font-weight:700">Alex · Your Style Coach</div><div style="font-size:11px;color:var(--ink3)">Certified stylist · Knows your closet · Online now</div></div>
        </div>
        <div id="chat-messages" style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:4px 0;margin-bottom:12px;display:flex;flex-direction:column;gap:10px">
          <div class="chat-msg coach">Hi! I'm Alex, your personal style coach. I can see your entire wardrobe and measurements. What can I help you with today?</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="coach-quick" onclick="sendQuick(this)">What should I wear today?</button>
            <button class="coach-quick" onclick="sendQuick(this)">Review my closet</button>
            <button class="coach-quick" onclick="sendQuick(this)">Help me shop for gaps</button>
            <button class="coach-quick" onclick="sendQuick(this)">Outfit for a date</button>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end;padding-bottom:var(--safe-bot)">
          <textarea id="chat-input" placeholder="Ask your style coach..." rows="1" style="flex:1;padding:12px 14px;border:1.5px solid var(--border);border-radius:12px;font-size:14px;font-family:'Karla',sans-serif;resize:none;outline:none;-webkit-appearance:none" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendCoachMsg();}"></textarea>
          <button onclick="sendCoachMsg()" style="width:44px;height:44px;border-radius:12px;background:var(--ink);color:#fff;border:none;font-size:18px;cursor:pointer;flex-shrink:0">↑</button>
        </div>
      </div>
    </div>

    <!-- DEVELOPER DASHBOARD -->
    <div class="page" id="page-devdash">
      <div class="pg-header"><div><div class="pg-eyebrow">Internal · Confidential</div><div class="pg-title">Dev Dashboard</div></div><div style="font-size:10px;font-weight:700;color:var(--ink3)">🔒 Owner Only</div></div>

      <div style="background:#fff8e8;border:1px solid #e8d890;border-radius:12px;padding:14px 16px;margin-bottom:16px;font-size:12px;color:#6b5c1a;line-height:1.7">
        <strong>Data You Own.</strong> Every item your users upload, every outfit they build, every brand they engage with, every measurement — it all belongs to you. Here's what you're collecting and how it can drive revenue.
      </div>

      <!-- Live metrics -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
        <div class="card"><div class="stat-label">Total Users</div><div class="stats-big" id="dev-users">1</div><div class="stat-sub">registered profiles</div></div>
        <div class="card"><div class="stat-label">Items Logged</div><div class="stats-big" id="dev-items">0</div><div class="stat-sub">across all users</div></div>
        <div class="card"><div class="stat-label">Premium Subs</div><div class="stats-big">0</div><div class="stat-sub">$0 MRR</div></div>
        <div class="card"><div class="stat-label">Brand Revenue</div><div class="stats-big">$0</div><div class="stat-sub">affiliate clicks</div></div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Data You Collect</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;gap:10px;align-items:flex-start"><div style="width:32px;height:32px;border-radius:8px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">📏</div><div><div style="font-size:12px;font-weight:700">Measurements</div><div style="font-size:11px;color:var(--ink3);line-height:1.5">Casual + dressy fit data for every user. Sellable to fashion brands for sizing research. Worth ~$8-25/user to brands like Levi's, Gap, luxury labels.</div></div></div>
          <div style="display:flex;gap:10px;align-items:flex-start"><div style="width:32px;height:32px;border-radius:8px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">👗</div><div><div style="font-size:12px;font-weight:700">Wardrobe Inventory</div><div style="font-size:11px;color:var(--ink3);line-height:1.5">What brands users own, price points, wear frequency. Brands pay for competitor intelligence and category share data.</div></div></div>
          <div style="display:flex;gap:10px;align-items:flex-start"><div style="width:32px;height:32px;border-radius:8px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">🎯</div><div><div style="font-size:12px;font-weight:700">Style Profile + Moods</div><div style="font-size:11px;color:var(--ink3);line-height:1.5">9-axis style DNA per user. High-value to ad networks and fashion platforms. Enables precise lookalike targeting.</div></div></div>
          <div style="display:flex;gap:10px;align-items:flex-start"><div style="width:32px;height:32px;border-radius:8px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">📍</div><div><div style="font-size:12px;font-weight:700">Location + Occupation</div><div style="font-size:11px;color:var(--ink3);line-height:1.5">City + job title enables HHI inference. Luxury brands pay premium for high-income urban shopper profiles.</div></div></div>
          <div style="display:flex;gap:10px;align-items:flex-start"><div style="width:32px;height:32px;border-radius:8px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">🔁</div><div><div style="font-size:12px;font-weight:700">Behavioral Data</div><div style="font-size:11px;color:var(--ink3);line-height:1.5">Outfit build patterns, brand click-throughs, calendar event types. The most valuable dataset — shows purchase intent in real time.</div></div></div>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Revenue Streams</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--s2);border-radius:9px"><div><div style="font-size:12px;font-weight:700">Premium Subscriptions</div><div style="font-size:10px;color:var(--ink3)">$14.99/mo or $99.99/yr per user</div></div><div style="font-size:11px;font-weight:700;color:var(--ink)">Active</div></div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--s2);border-radius:9px"><div><div style="font-size:12px;font-weight:700">Brand Partnerships</div><div style="font-size:10px;color:var(--ink3)">Override feature + affiliate cuts (8-15%)</div></div><div style="font-size:11px;font-weight:700;color:var(--ink)">Active</div></div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--s2);border-radius:9px"><div><div style="font-size:12px;font-weight:700">Anonymized Data Licensing</div><div style="font-size:10px;color:var(--ink3)">Sell aggregated style + sizing data to brands</div></div><div style="font-size:11px;font-weight:700;color:#884444">Needs Legal Review</div></div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--s2);border-radius:9px"><div><div style="font-size:12px;font-weight:700">Targeted Ad Placement</div><div style="font-size:10px;color:var(--ink3)">Style-matched sponsored products in feed</div></div><div style="font-size:11px;font-weight:700;color:#886644">Planned</div></div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--s2);border-radius:9px"><div><div style="font-size:12px;font-weight:700">Personal Shopper API</div><div style="font-size:10px;color:var(--ink3)">License your style engine to other apps</div></div><div style="font-size:11px;font-weight:700;color:#886644">Planned</div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">User Data Export</div>
        <div style="font-size:12px;color:var(--ink2);line-height:1.7;margin-bottom:14px">All data stored locally in this demo. In production, this connects to your backend. You can export the current user's data below.</div>
        <button class="btn btn-dark" onclick="exportUserData()" style="margin-right:8px">Export My Data JSON</button>
        <button class="btn btn-outline" onclick="clearAllData()">Clear All Data</button>
      </div>
    </div>

  </div><!-- /app-main -->

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="bn-item active" onclick="showPage('home',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 10L11 3L19 10V19H14V14H8V19H3V10Z" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="bn-label">Home</span>
    </button>
    <button class="bn-item" onclick="showPage('closet',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M11 5C11 5 13.5 3.5 13.5 6C13.5 7.5 11 8 11 8" stroke-linecap="round"/><path d="M11 8L4 13.5H18" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span class="bn-label">Closet</span>
    </button>
    <button class="bn-item" onclick="showPage('outfits',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M11 3L13 8.5L19 11L13 13.5L11 19L9 13.5L3 11L9 8.5L11 3Z" stroke-linejoin="round"/></svg>
      <span class="bn-label">Outfits</span>
    </button>
    <button class="bn-item" onclick="showPage('planner',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="16" height="15" rx="2"/><line x1="3" y1="9" x2="19" y2="9"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="14" y1="2" x2="14" y2="6"/></svg>
      <span class="bn-label">Planner</span>
    </button>
    <button class="bn-item" onclick="showPage('stats',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="12" width="4" height="7" rx="1"/><rect x="9" y="7" width="4" height="12" rx="1"/><rect x="15" y="3" width="4" height="16" rx="1"/></svg>
      <span class="bn-label">Stats</span>
    </button>
    <button class="bn-item" onclick="showPage('packing',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="7" width="14" height="12" rx="2"/><path d="M8 7V5.5A2.5 2.5 0 0 1 13.5 7"/><line x1="4" y1="11" x2="18" y2="11"/></svg>
      <span class="bn-label">Packing</span>
    </button>
    <button class="bn-item" onclick="showPage('gaps',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="11" y1="7" x2="11" y2="12"/><circle cx="11" cy="14.5" r="1" fill="currentColor" stroke="none"/></svg>
      <span class="bn-label">Gaps</span>
    </button>
    <button class="bn-item" onclick="showPage('brands',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3H11L19 11L13 17L5 9V3Z" stroke-linejoin="round"/><circle cx="7" cy="7" r="1.3" fill="currentColor" stroke="none"/></svg>
      <span class="bn-label">Brands</span>
    </button>
    <button class="bn-item" onclick="showPage('icons',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="8" r="3.5"/><path d="M4 19c0-3.3 3.1-6 7-6s7 2.7 7 6" stroke-linecap="round"/><circle cx="17.5" cy="6" r="2.5" fill="currentColor" stroke="none" opacity=".4"/><text x="16" y="8" font-size="5" fill="white" text-anchor="middle">★</text></svg>
      <span class="bn-label">Icons</span>
    </button>
    <button class="bn-item" onclick="showPage('builder',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="12" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="12" width="7" height="7" rx="1.5"/><path d="M12 15.5H19M15.5 12V19" stroke-linecap="round"/></svg>
      <span class="bn-label">Build</span>
    </button>
    <button class="bn-item" onclick="showPage('coach',this)" style="position:relative">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H7l-4 3V6Z" stroke-linejoin="round"/></svg>
      <span class="bn-label">Coach</span>
      <span style="position:absolute;top:8px;right:6px;width:6px;height:6px;border-radius:50%;background:#0c0c0c;border:1.5px solid #fff"></span>
    </button>
    <button class="bn-item" onclick="showPage('profile',this)">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="8" r="4"/><path d="M3 19C3 15.7 6.6 13 11 13C15.4 13 19 15.7 19 19" stroke-linecap="round"/></svg>
      <span class="bn-label">Profile</span>
    </button>
    <button class="bn-item" id="dev-nav-btn" onclick="showPage('devdash',this)" style="display:none">
      <svg class="bn-icon" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="2"/><path d="M11 3v3M11 16v3M3 11h3M16 11h3M5.6 5.6l2.1 2.1M14.3 14.3l2.1 2.1M5.6 16.4l2.1-2.1M14.3 7.7l2.1-2.1" stroke-linecap="round"/></svg>
      <span class="bn-label">Dev</span>
    </button>
  </nav>

</div><!-- /app -->

<!-- UPLOAD / ADD ITEM SHEET -->
<div class="modal-overlay" id="upload-overlay" onclick="if(event.target===this)closeUpload()">
  <div class="modal-sheet">
    <div class="modal-handle"></div>

    <!-- STATE 1: Drop zone -->
    <div id="upload-state-drop">
      <div class="modal-title">Add to Closet</div>
      <div class="modal-sub">Take a photo or upload from your camera roll. Our AI will identify everything.</div>

      <!-- iOS: separate inputs work more reliably than toggling capture attribute -->
      <input type="file" id="upload-input-gallery" accept="image/*"
        style="display:none" onchange="handleFileSelected(this)">
      <input type="file" id="upload-input-camera" accept="image/*" capture="environment"
        style="display:none" onchange="handleFileSelected(this)">

      <!-- Drop zone — tap opens gallery on iOS -->
      <div id="upload-dropzone"
        onclick="document.getElementById('upload-input-gallery').click()"
        ondragover="event.preventDefault();this.style.borderColor='var(--ink)'"
        ondragleave="this.style.borderColor=''"
        ondrop="event.preventDefault();handleFileSelected({files:event.dataTransfer.files})"
        style="border:2px dashed var(--border2);border-radius:14px;padding:36px 20px;text-align:center;cursor:pointer;margin-bottom:14px;transition:border-color .2s;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none">
        <div style="font-size:40px;margin-bottom:10px">📷</div>
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">Tap to choose a photo</div>
        <div style="font-size:12px;color:var(--ink3)">Camera roll, files, or drag & drop</div>
        <div style="font-size:11px;color:var(--ink4);margin-top:6px">JPG, PNG, HEIC supported</div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:14px">
        <button onclick="document.getElementById('upload-input-gallery').click()" class="btn btn-outline" style="flex:1;padding:14px;border-radius:10px;font-size:14px">📁 Gallery</button>
        <button onclick="document.getElementById('upload-input-camera').click()" class="btn btn-dark" style="flex:1;padding:14px;border-radius:10px;font-size:14px">📷 Camera</button>
      </div>

      <div style="background:var(--s2);border-radius:10px;padding:10px 13px;font-size:11px;color:var(--ink3);line-height:1.6;margin-bottom:10px">
        <strong style="color:var(--ink)">✦ AI identifies:</strong> garment type, color, fabric, fit style, and brand if visible. You confirm before saving.
      </div>
      
      <div style="background:#f0f7ff;border:1px solid #d0e3ff;border-radius:10px;padding:10px 13px;font-size:11px;color:#1a5dad;line-height:1.6">
        <strong>💡 Pro tip:</strong> For best results, photograph items against a <strong>white wall or solid background</strong>. We'll automatically remove the background for clean outfit displays!
      </div>
    </div>

    <!-- STATE 2: Analysing -->
    <div id="upload-state-analysing" style="display:none;text-align:center;padding:20px 0">
      <div style="font-size:44px;margin-bottom:16px">✦</div>
      <div style="font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:300;margin-bottom:6px">Identifying your item...</div>
      <div style="font-size:12px;color:var(--ink3);margin-bottom:24px">Reading fabric, color, fit, and brand</div>
      <div id="upload-preview-wrap" style="width:120px;height:140px;border-radius:14px;overflow:hidden;margin:0 auto 20px;background:var(--s2);border:1px solid var(--border)">
        <img id="upload-preview-img" src="" alt="" style="width:100%;height:100%;object-fit:cover">
      </div>
      <div style="display:flex;justify-content:center;gap:5px">
        <div style="width:8px;height:8px;border-radius:50%;background:var(--ink);animation:chatBounce 1.2s infinite"></div>
        <div style="width:8px;height:8px;border-radius:50%;background:var(--ink);animation:chatBounce 1.2s infinite .2s"></div>
        <div style="width:8px;height:8px;border-radius:50%;background:var(--ink);animation:chatBounce 1.2s infinite .4s"></div>
      </div>
    </div>

    <!-- STATE 3: Confirm results -->
    <div id="upload-state-confirm" style="display:none">
      <div style="display:flex;gap:14px;align-items:flex-start;margin-bottom:16px">
        <div style="width:80px;height:96px;border-radius:12px;overflow:hidden;flex-shrink:0;border:1px solid var(--border);background:var(--s2)">
          <img id="confirm-preview-img" src="" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="flex:1">
          <div style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink3);margin-bottom:4px">AI Identified</div>
          <div style="font-size:18px;font-weight:700;margin-bottom:3px" id="ai-result-name">White Oxford Shirt</div>
          <div id="ai-result-details" style="font-size:12px;color:var(--ink2);line-height:1.6"></div>
        </div>
      </div>

      <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ink3);margin-bottom:8px">Confirm or Edit</div>
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
        <div>
          <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ink3);margin-bottom:4px">Name</div>
          <input id="add-name" type="text" style="width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-family:'Karla',sans-serif;outline:none;-webkit-appearance:none">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ink3);margin-bottom:4px">Category</div>
            <select id="add-cat" style="width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-family:'Karla',sans-serif;outline:none;-webkit-appearance:none;background:white">
              <option>Tops</option><option>Bottoms</option><option>Outerwear</option><option>Footwear</option><option>Accessories</option><option>Suiting</option><option>Other</option>
            </select>
          </div>
          <div>
            <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--ink3);margin-bottom:4px">Cost</div>
            <input id="add-cost" type="number" placeholder="$0" style="width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-family:'Karla',sans-serif;outline:none;-webkit-appearance:none">
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px">
        <button class="btn btn-outline" onclick="resetUploadModal()" style="flex:1;padding:13px;border-radius:10px">Try Another Photo</button>
        <button class="btn btn-dark" onclick="confirmAddItem()" style="flex:1;padding:13px;border-radius:10px">Save to Closet ✓</button>
      </div>
    </div>

    <!-- STATE 4: Error -->
    <div id="upload-state-error" style="display:none;text-align:center;padding:20px 0">
      <div style="font-size:40px;margin-bottom:12px">⚠️</div>
      <div style="font-size:15px;font-weight:700;margin-bottom:6px" id="upload-error-msg">Could not identify item</div>
      <div style="font-size:12px;color:var(--ink3);line-height:1.7;margin-bottom:20px">Try a clearer photo with good lighting, or fill in the details manually below.</div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn btn-outline" onclick="resetUploadModal()">Try Again</button>
        <button class="btn btn-dark" onclick="showManualEntry()">Enter Manually</button>
      </div>
    </div>



  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ── ONBOARDING ──
var PROFILE_KEY = 'vestiary_profile_v1';
var selectedMoods = [];

// Load saved profile or use defaults
var userProfile = (function() {
  try {
    var saved = localStorage.getItem(PROFILE_KEY);
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return null;
})();

// Check if user has completed onboarding
var hasCompletedOnboarding = !!userProfile;

// Default profile if none saved
if (!userProfile) {
  userProfile = { name:'', firstName:'', city:'', casual:{tshirt:'L',waist:'32',inseam:'32',shoe:'10.5'}, dressy:{suit:'42R',neck:'15.5',sleeve:'34',chest:'40',fitPref:'Regular'}, moods:['ald'] };
}

function saveUserProfile() {
  try { localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile)); } catch(e) {}
}

function goStep(n) {
  document.querySelectorAll('.ob-screen').forEach(function(s){ s.classList.remove('active'); });
  var target = document.getElementById('ob-' + n);
  if (target) {
    target.classList.add('active');
    var ob = document.getElementById('onboarding');
    if (ob) ob.scrollTop = 0;
  }
  var fill = document.getElementById('ob-fill');
  if (fill && n > 0) fill.style.width = ((n-1)/5*100) + '%'; // 5 steps now
}

function toggleMood(el) {
  el.classList.toggle('active');
  var mood = el.getAttribute('data-mood');
  var idx = selectedMoods.indexOf(mood);
  if (idx === -1) { selectedMoods.push(mood); }
  else { selectedMoods.splice(idx, 1); }
}

// Work from home day toggle
var selectedWfhDays = [5, 6]; // Default: Fri, Sat are casual
function toggleWfhDay(el) {
  el.classList.toggle('active');
  var day = parseInt(el.getAttribute('data-day'));
  var idx = selectedWfhDays.indexOf(day);
  if (idx === -1) { selectedWfhDays.push(day); }
  else { selectedWfhDays.splice(idx, 1); }
}

function finishOnboarding() {
  var fn = (document.getElementById('ob-fname')||{}).value || 'User';
  var ln = (document.getElementById('ob-lname')||{}).value || '';
  var city = (document.getElementById('ob-city')||{}).value || 'New York, NY';
  
  // Get work schedule settings
  var dressCode = (document.getElementById('ob-dress-code')||{value:'smart-casual'}).value;
  var clientFacing = (document.getElementById('ob-client-facing')||{}).checked || false;
  var creative = (document.getElementById('ob-creative')||{}).checked || false;
  var outdoor = (document.getElementById('ob-outdoor')||{}).checked || false;
  
  userProfile = {
    name: fn + (ln ? ' '+ln : ''), firstName: fn, city: city,
    casual: {
      tshirt: (document.getElementById('ob-tshirt')||{value:'L'}).value,
      waist: (document.getElementById('ob-cas-waist')||{value:'32'}).value || '32',
      inseam: (document.getElementById('ob-inseam')||{value:'32'}).value || '32',
      shoe: (document.getElementById('ob-shoe')||{value:'10.5'}).value || '10.5'
    },
    dressy: {
      suit: (document.getElementById('ob-suit')||{value:'42R'}).value,
      neck: (document.getElementById('ob-neck')||{value:'15.5'}).value || '15.5',
      sleeve: (document.getElementById('ob-sleeve')||{value:'34'}).value || '34',
      chest: (document.getElementById('ob-chest')||{value:'40'}).value || '40',
      fitPref: (document.getElementById('ob-fit-pref')||{value:'Regular'}).value
    },
    moods: selectedMoods.length ? selectedMoods : ['ald'],
    workSchedule: {
      dressCode: dressCode,
      casualDays: selectedWfhDays, // Days where casual is OK (0=Sun, 6=Sat)
      clientFacing: clientFacing,
      creative: creative,
      outdoor: outdoor
    }
  };

  // Save to localStorage
  saveUserProfile();
  
  applyUserProfile();
  
  document.getElementById('onboarding').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  window.requestAnimationFrame(function(){ initStats(); initPacking(); initGaps(); renderBrands(); updateWeatherDisplay(); renderPlanner(); });
}

function applyUserProfile() {
  var initials = ((userProfile.firstName || 'U')[0] + ((userProfile.name || '').split(' ')[1] || '')[0] || '').toUpperCase();
  var hdrAv = document.getElementById('hdr-avatar');
  if (hdrAv) hdrAv.textContent = initials || 'U';
  var profAv = document.getElementById('profile-avatar');
  if (profAv) profAv.textContent = initials || 'U';
  var profNm = document.getElementById('profile-name');
  if (profNm) profNm.textContent = userProfile.name || 'User';
  var profSt = document.getElementById('profile-style');
  if (profSt) profSt.textContent = styleLabel() + ' · ' + (userProfile.city || 'Set your city');
  var stLabel = document.getElementById('style-label');
  if (stLabel) stLabel.textContent = styleLabel();

  // Update measurement display
  var cm = document.getElementById('casual-meas');
  if (cm) cm.innerHTML = mItem('T-Shirt',userProfile.casual.tshirt)+mItem('Waist',userProfile.casual.waist+'"')+mItem('Inseam',userProfile.casual.inseam+'"')+mItem('Shoe',userProfile.casual.shoe);
  var dm = document.getElementById('dressy-meas');
  if (dm) dm.innerHTML = mItem('Neck',userProfile.dressy.neck+'"')+mItem('Sleeve',userProfile.dressy.sleeve+'"')+mItem('Chest',userProfile.dressy.chest+'"')+mItem('Suit',userProfile.dressy.suit);
}

function mItem(lbl, val) { return '<div class="meas-item"><div class="meas-item-label">'+lbl+'</div><div class="meas-item-val">'+val+'</div></div>'; }

function styleLabel() {
  var m = userProfile.moods || ['ald'];
  if (m.indexOf('ald')>-1) return 'ALD / Prep';
  if (m.indexOf('designer')>-1) return 'Designer';
  if (m.indexOf('minimal')>-1) return 'Minimalist';
  if (m.indexOf('noah')>-1) return 'Surf-Prep';
  if (m.indexOf('avant')>-1) return 'Avant-garde';
  return 'Todd Snyder';
}

// ── NAVIGATION ──
function showPage(name, tabEl) {
  document.querySelectorAll('.page').forEach(function(p){ p.classList.remove('active'); });
  document.querySelectorAll('.bn-item').forEach(function(t){ t.classList.remove('active'); });
  var pg = document.getElementById('page-'+name);
  if (pg) pg.classList.add('active');
  if (tabEl) tabEl.classList.add('active');
  var main = document.querySelector('.app-main');
  if (main) main.scrollTop = 0;
  // Re-render pages that depend on live data every time they are visited
  if (name === 'stats')    initStats();
  if (name === 'closet')   renderCloset();
  if (name === 'builder')  initBuilder();
  if (name === 'gaps')     initGaps();
  if (name === 'packing')  initPacking();
  if (name === 'home')     { updateHomeStats(); renderWeekView(); renderTodayOutfit(); }
  if (name === 'planner')  renderPlanner();
  if (name === 'profile')  checkServerStatus();
  if (name === 'outfits')  renderOutfitsPage();
}

// ── UPLOAD ──
function openUpload() { document.getElementById('upload-overlay').classList.add('open'); }
function closeUpload() { document.getElementById('upload-overlay').classList.remove('open'); }

// ── FILTER CHIPS ──
function filterCloset(el) {
  el.closest('.filter-row').querySelectorAll('.chip').forEach(function(c){ c.classList.remove('active'); });
  el.classList.add('active');
}

// ── STATS ──
// ── CLOSET DATA (localStorage persisted) ──
var CLOSET_KEY = 'vestiary_closet_v1';
var ITEMS = loadCloset();
function loadCloset() {
  try {
    var saved = localStorage.getItem(CLOSET_KEY);
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return []; // Start empty — user uploads their own
}
function saveCloset() {
  try { localStorage.setItem(CLOSET_KEY, JSON.stringify(ITEMS)); } catch(e) {}
}
function addItem(item) {
  item.id = Date.now();
  item.wears = item.wears || 0;
  ITEMS.push(item);
  saveCloset();
  renderCloset();
  updateHomeStats();
  
  // Sync to server if logged in
  syncItemToServer(item);
  
  // Refresh stats/gaps if currently visible so numbers are never stale
  var active = document.querySelector('.page.active');
  if (active) {
    var pid = active.id;
    if (pid === 'page-stats')   initStats();
    if (pid === 'page-gaps')    initGaps();
    if (pid === 'page-builder') initBuilder();
  }
}
function initStats() {
  var empty   = document.getElementById('stats-empty');
  var content = document.getElementById('stats-content');
  if (!empty || !content) return;

  if (ITEMS.length === 0) {
    empty.style.display   = 'block';
    content.style.display = 'none';
    return;
  }
  empty.style.display   = 'none';
  content.style.display = 'block';

  // ── SUMMARY CARDS ──
  var totalWears   = ITEMS.reduce(function(s,i){ return s + (i.wears||0); }, 0);
  var itemsWithCost = ITEMS.filter(function(i){ return i.cost > 0 && i.wears > 0; });
  var avgCPW = itemsWithCost.length
    ? (itemsWithCost.reduce(function(s,i){ return s + i.cost/i.wears; }, 0) / itemsWithCost.length)
    : 0;
  var mostWorn = ITEMS.slice().sort(function(a,b){ return (b.wears||0)-(a.wears||0); })[0];
  var cats = {};
  ITEMS.forEach(function(i){ cats[i.cat] = (cats[i.cat]||0)+1; });
  var numCats = Object.keys(cats).length;

  var sg = document.getElementById('stats-summary-grid');
  if (sg) sg.innerHTML =
    '<div class="card"><div class="stat-label">Total Items</div><div class="stats-big">'+ITEMS.length+'</div><div class="stat-sub">'+numCats+' categor'+(numCats===1?'y':'ies')+'</div></div>' +
    '<div class="card"><div class="stat-label">Total Wears</div><div class="stats-big">'+totalWears+'</div><div class="stat-sub">across all items</div></div>' +
    '<div class="card"><div class="stat-label">Most Worn</div><div style="font-size:16px;font-weight:700;margin:4px 0 2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(mostWorn ? mostWorn.name.split(' ').slice(0,2).join(' ') : '—')+'</div><div class="stat-sub">'+(mostWorn ? mostWorn.wears+' wear'+(mostWorn.wears!==1?'s':'') : 'No wears yet')+'</div></div>' +
    '<div class="card"><div class="stat-label">Avg Cost/Wear</div><div class="stats-big">'+(avgCPW > 0 ? '$'+avgCPW.toFixed(2) : '—')+'</div><div class="stat-sub">'+(itemsWithCost.length > 0 ? 'across '+itemsWithCost.length+' items with cost' : 'Add costs to track')+'</div></div>';

  // ── WEAR FREQUENCY BARS ──
  var wb = document.getElementById('wear-bars');
  if (wb) {
    var byWear = ITEMS.slice().sort(function(a,b){ return (b.wears||0)-(a.wears||0); }).slice(0,8);
    var mx = byWear[0] ? (byWear[0].wears||0) : 1;
    if (mx === 0) mx = 1;
    if (byWear.length === 0) {
      wb.innerHTML = '<div style="font-size:12px;color:var(--ink4);padding:10px 0">Wear items to see frequency data. Tap any item in your closet to log a wear.</div>';
    } else {
      wb.innerHTML = byWear.map(function(i){
        var w = i.wears||0;
        var pct = Math.round(w/mx*100);
        return '<div class="wear-row"><div class="wear-name">'+i.name+'</div>'+
          '<div class="wear-track"><div class="wear-fill" style="width:0" data-w="'+pct+'"></div></div>'+
          '<div class="wear-count">'+w+'×</div></div>';
      }).join('');
      setTimeout(function(){
        document.querySelectorAll('.wear-fill').forEach(function(f){
          f.style.width = f.getAttribute('data-w') + '%';
        });
      }, 80);
    }
  }

  // ── COST PER WEAR ──
  var cpw = document.getElementById('cpw-rows');
  if (cpw) {
    var costed = ITEMS.filter(function(i){ return i.cost > 0; })
      .slice().sort(function(a,b){
        var aw = a.wears||0, bw = b.wears||0;
        var acpw = aw > 0 ? a.cost/aw : a.cost;
        var bcpw = bw > 0 ? b.cost/bw : b.cost;
        return acpw - bcpw;
      }).slice(0,6);
    if (costed.length === 0) {
      cpw.innerHTML = '<div style="font-size:12px;color:var(--ink4);padding:10px 0">Add a cost when uploading items to track cost-per-wear.</div>';
    } else {
      cpw.innerHTML = costed.map(function(i){
        var w = i.wears||0;
        var val = w > 0 ? '$'+(i.cost/w).toFixed(2)+'/wear' : '$'+i.cost+' (unworn)';
        var sub = w > 0 ? w+' wear'+(w!==1?'s':'') + ' · $'+i.cost+' cost' : 'Not worn yet · $'+i.cost+' cost';
        return '<div class="cpw-row">'+
          '<div><div class="cpw-name">'+i.name+'</div><div class="cpw-sub">'+sub+'</div></div>'+
          '<div class="cpw-val">'+val+'</div>'+
          '</div>';
      }).join('');
    }
  }

  // ── CATEGORY BREAKDOWN ──
  var cb = document.getElementById('cat-breakdown');
  if (cb) {
    var catOrder = ['Tops','Bottoms','Outerwear','Footwear','Accessories','Suiting','Other'];
    var maxCat = Math.max.apply(null, Object.values(cats).concat([1]));
    cb.innerHTML = catOrder.filter(function(cat){ return cats[cat]; }).map(function(cat){
      var n = cats[cat];
      var pct = Math.round(n/ITEMS.length*100);
      return '<div class="cat-bar">'+
        '<div class="cat-bar-head"><div class="cat-bar-name">'+cat+'</div><div class="cat-bar-count">'+n+' item'+(n!==1?'s':'')+' · '+pct+'%</div></div>'+
        '<div class="cat-bar-track"><div class="cat-bar-fill" style="width:'+Math.round(n/maxCat*100)+'%"></div></div>'+
        '</div>';
    }).join('');
  }

  // ── UNLOVED ITEMS ──
  var ul = document.getElementById('unloved-row');
  if (ul) {
    var catIco = {Tops:'👔',Bottoms:'👖',Outerwear:'🧥',Footwear:'👟',Accessories:'🧣',Suiting:'🤵',Other:'👕'};
    var unloved = ITEMS.filter(function(i){ return (i.wears||0) === 0; }).slice(0,6);
    var lowWear = ITEMS.filter(function(i){ return (i.wears||0) > 0 && (i.wears||0) <= 3; }).slice(0,6);
    var show = unloved.length > 0 ? unloved : lowWear;
    if (show.length === 0) {
      ul.innerHTML = '<div style="font-size:12px;color:var(--ink4);padding:10px">Great — all your items have been worn! Keep tracking.</div>';
    } else {
      ul.innerHTML = show.map(function(i){
        var ico = catIco[i.cat] || '👕';
        var w = i.wears||0;
        return '<div class="unloved-card" onclick="logWear('+i.id+')">'+
          '<div class="unloved-img">'+imgHtml(i.img)+ico+'</div>'+
          '<div class="unloved-nm">'+i.name+'</div>'+
          '<div class="unloved-worn">'+(w===0?'Never worn':w+' wear'+(w!==1?'s':''))+'</div>'+
          '</div>';
      }).join('');
    }
  }
  
  // Render declutter suggestions
  renderDeclutterSuggestions();
}

// ── PACKING ──
function selectPackType(el) {
  el.closest('.pack-types').querySelectorAll('.pack-type').forEach(function(t){t.classList.remove('active');});
  el.classList.add('active');
}
var PACK_ITEMS = [
  {nm:'White Oxford',cat:'Tops',ico:'👔',img:'https://images.squarespace-cdn.com/content/v1/5f38f46c1e9a0a2781588139/1641400793088-YRTDKLQ4NLZR8SWJPN6B/white-button-down-shirt.jpg'},
  {nm:'Grey Chinos',cat:'Bottoms',ico:'🥼',img:''},
  {nm:'Dark Jeans',cat:'Bottoms',ico:'👖',img:'https://barbellapparelstaging.com/cdn/shop/products/dark-athletic-fit-jeans-mens-barbell-apparel-1_b3f5db6d-d8c3-4db2-b98a-4abd97e72e1b.jpg'},
  {nm:'Merino Crewneck',cat:'Tops',ico:'🧶',img:''},
  {nm:'Camel Trench',cat:'Outerwear',ico:'🧥',img:'https://sumarokovaatelier.com/cdn/shop/files/Camelwooltrenchcoat-SumarokovaAtelier-2.jpg'},
  {nm:'Brown Derbies',cat:'Footwear',ico:'👞',img:''},
  {nm:'White Sneakers',cat:'Footwear',ico:'👟',img:'https://www.codebygentry.com/wp-content/uploads/2021/06/how-to-clean-white-shoes.jpg'},
  {nm:'Wool Scarf',cat:'Accessories',ico:'🧣',img:''},
];
var PACK_DAYS_DATA = [
  {day:'Day 1',outfit:'Oxford + Grey Chinos + Derbies',occ:'Client Meeting'},
  {day:'Day 2',outfit:'Merino + Dark Jeans + Sneakers',occ:'Internal Day'},
  {day:'Day 3',outfit:'Oxford + Grey Chinos + Derbies',occ:'Dinner Out'},
  {day:'Day 4',outfit:'Trench + Dark Jeans + Sneakers',occ:'Travel Home'},
];
function buildPack() {
  var dest = (document.getElementById('pack-dest')||{value:'New York'}).value || 'New York';
  var nights = (document.getElementById('pack-nights')||{value:'4'}).value || '4';
  var pg = document.getElementById('pack-grid');
  if (pg) pg.innerHTML = PACK_ITEMS.map(function(i){
    return '<div class="pc-item"><div class="pc-img">'+imgHtml(i.img)+i.ico+'</div><div class="pc-info"><div class="pc-nm">'+i.nm+'</div><div class="pc-cat">'+i.cat+'</div></div></div>';
  }).join('');
  var pd = document.getElementById('pack-days');
  if (pd) pd.innerHTML = PACK_DAYS_DATA.slice(0,parseInt(nights)||4).map(function(d){
    return '<div class="pack-day-row"><div class="pack-day-label">'+d.day+'</div><div><div class="pack-day-outfit">'+d.outfit+'</div><div class="pack-day-occ">'+d.occ+'</div></div></div>';
  }).join('');
  showToast('Capsule built for '+dest+' ✓');
}
function initPacking() { buildPack(); }

// ── GAPS ──
function initGaps() {
  // Calculate actual wardrobe completeness based on user's items
  var hasSuit = ITEMS.some(function(i) { return i.cat === 'Suiting' || i.name.toLowerCase().indexOf('suit') > -1 || i.name.toLowerCase().indexOf('blazer') > -1; });
  var hasDressShoes = ITEMS.some(function(i) { return i.cat === 'Footwear' && (i.name.toLowerCase().indexOf('loafer') > -1 || i.name.toLowerCase().indexOf('oxford') > -1 || i.name.toLowerCase().indexOf('derby') > -1); });
  var hasMidLayer = ITEMS.some(function(i) { return i.name.toLowerCase().indexOf('overshirt') > -1 || i.name.toLowerCase().indexOf('cardigan') > -1 || i.name.toLowerCase().indexOf('sweater') > -1; });
  var hasDressShirt = ITEMS.filter(function(i) { return i.name.toLowerCase().indexOf('shirt') > -1 && i.cat === 'Tops'; }).length >= 2;
  
  // Build essentials list based on what's actually missing
  var essentials = [];
  if (!hasSuit) essentials.push({
    img: 'https://m.media-amazon.com/images/I/61Yzdn5QfVL._AC_UY879_.jpg',
    nm: 'Suit or Blazer',
    desc: 'No formal option for dinners or events.',
    sev: 'sev-hi', sl: 'HIGH',
    searchTerm: 'mens blazer sport coat',
    shops: [{name:'Nordstrom', url:'https://www.nordstrom.com/browse/men/clothing/coats-jackets/blazers-sport-coats'}, {name:'Todd Snyder', url:'https://www.toddsnyder.com/collections/suits-blazers'}, {name:'J.Crew', url:'https://www.jcrew.com/c/mens_category/sportcoats_vests'}]
  });
  if (!hasDressShoes) essentials.push({
    img: 'https://m.media-amazon.com/images/I/71vChOZ2CfL._AC_UY695_.jpg',
    nm: 'Dress Loafer',
    desc: 'Sneakers too casual for many events.',
    sev: 'sev-hi', sl: 'HIGH',
    searchTerm: 'mens leather loafers',
    shops: [{name:'Nordstrom', url:'https://www.nordstrom.com/browse/men/shoes/loafers-slip-ons'}, {name:'Allen Edmonds', url:'https://www.allenedmonds.com/shoes/mens-shoes/loafers-slip-ons'}, {name:'Cole Haan', url:'https://www.colehaan.com/mens-loafers-drivers'}]
  });
  if (!hasMidLayer) essentials.push({
    img: 'https://m.media-amazon.com/images/I/71EHwFBZ-WL._AC_UY879_.jpg',
    nm: 'Mid-Layer / Overshirt',
    desc: 'Gap between crewneck and outerwear.',
    sev: 'sev-med', sl: 'MED',
    searchTerm: 'mens overshirt jacket',
    shops: [{name:'Todd Snyder', url:'https://www.toddsnyder.com/collections/overshirts'}, {name:'J.Crew', url:'https://www.jcrew.com/c/mens_category/shirts/overshirts'}, {name:'Banana Republic', url:'https://bananarepublic.gap.com/browse/category.do?cid=44873'}]
  });
  if (!hasDressShirt) essentials.push({
    img: 'https://m.media-amazon.com/images/I/71KgLH3THUL._AC_UY879_.jpg',
    nm: 'Dress Shirt',
    desc: 'Need variety for multi-day occasions.',
    sev: 'sev-med', sl: 'MED',
    searchTerm: 'mens dress shirt oxford',
    shops: [{name:'Charles Tyrwhitt', url:'https://www.charlestyrwhitt.com/us/mens-dress-shirts/'}, {name:'Nordstrom', url:'https://www.nordstrom.com/browse/men/clothing/shirts/dress-shirts'}, {name:'Brooks Brothers', url:'https://www.brooksbrothers.com/men/dress-shirts/'}]
  });
  
  // Calculate completion percentage
  var totalCategories = 6;
  var filledCategories = 0;
  ['Tops', 'Bottoms', 'Footwear', 'Outerwear', 'Accessories', 'Suiting'].forEach(function(cat) {
    if (ITEMS.some(function(i) { return i.cat === cat; })) filledCategories++;
  });
  var completionPct = ITEMS.length === 0 ? 0 : Math.round((filledCategories / totalCategories) * 100);
  
  // Update the completion ring
  var ring = document.querySelector('.gap-ring');
  if (ring) ring.style.background = 'conic-gradient(var(--ink) 0% ' + completionPct + '%, var(--s3) ' + completionPct + '% 100%)';
  var pctEl = document.querySelector('.gap-ring-pct');
  if (pctEl) pctEl.textContent = completionPct + '%';
  var titleEl = document.querySelector('.gap-score-title');
  if (titleEl) {
    if (completionPct === 0) titleEl.textContent = 'Just getting started';
    else if (completionPct < 30) titleEl.textContent = 'Building your foundation';
    else if (completionPct < 60) titleEl.textContent = 'Good progress, key gaps remain';
    else if (completionPct < 80) titleEl.textContent = 'Well-built, with some gaps';
    else titleEl.textContent = 'Nearly complete wardrobe';
  }
  
  var ess = document.getElementById('gap-essentials');
  if (ess) {
    if (essentials.length === 0) {
      ess.innerHTML = '<div style="text-align:center;padding:20px;color:var(--ink3);font-size:12px">Your essentials are covered! Check upgrades below.</div>';
    } else {
      ess.innerHTML = essentials.map(function(e) {
        var shopsHtml = e.shops.map(function(s) {
          return '<a href="'+s.url+'" target="_blank" style="color:var(--ink);text-decoration:none;font-size:10px;padding:3px 8px;background:var(--s2);border-radius:4px;white-space:nowrap">'+s.name+'</a>';
        }).join(' ');
        return '<div class="gap-item">'+
          '<div class="gap-ico" style="width:50px;height:50px;background:var(--s2);border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center">'+
            '<img src="'+e.img+'" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML=\'\'">'+
          '</div>'+
          '<div class="gap-info">'+
            '<div class="gap-name">'+e.nm+' <span class="sev '+e.sev+'">'+e.sl+'</span></div>'+
            '<div class="gap-desc">'+e.desc+'</div>'+
            '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">'+shopsHtml+'</div>'+
          '</div>'+
        '</div>';
      }).join('');
    }
  }

  // Update category bars based on actual items
  var catCounts = {};
  var catTargets = {Tops:6, Bottoms:4, Footwear:5, Outerwear:3, Accessories:4, Suiting:2};
  ITEMS.forEach(function(i) { catCounts[i.cat] = (catCounts[i.cat] || 0) + 1; });
  
  var cats = document.getElementById('gap-cats');
  if (cats) cats.innerHTML = Object.keys(catTargets).map(function(cat) {
    var c = catCounts[cat] || 0;
    var t = catTargets[cat];
    return '<div class="cat-bar"><div class="cat-bar-head"><div class="cat-bar-name">'+cat+'</div><div class="cat-bar-count">'+c+' / '+t+'</div></div><div class="cat-bar-track"><div class="cat-bar-fill" style="width:'+Math.min(100, Math.round(c/t*100))+'%"></div></div></div>';
  }).join('');

  var upg = document.getElementById('gap-upgrades');
  if (upg) upg.innerHTML = [
    {img:'https://m.media-amazon.com/images/I/71WiGV6YPZL._AC_UY879_.jpg',nm:'Quality Denim',desc:'Elevate your denim game with premium selvedge.',sev:'sev-med',sl:'MED',shops:[{name:'Todd Snyder',url:'https://www.toddsnyder.com/collections/denim'},{name:'J.Crew',url:'https://www.jcrew.com/c/mens_category/denim_702702'},{name:'Nordstrom',url:'https://www.nordstrom.com/browse/men/clothing/jeans'}]},
    {img:'https://m.media-amazon.com/images/I/61-jBuGMHzL._AC_UX679_.jpg',nm:'Cashmere Knit',desc:'Upgrade basics to cashmere for elevated occasions.',sev:'sev-lo',sl:'LOW',shops:[{name:'Everlane',url:'https://www.everlane.com/collections/mens-sweaters'},{name:'Nordstrom',url:'https://www.nordstrom.com/browse/men/clothing/sweaters/cashmere'},{name:'J.Crew',url:'https://www.jcrew.com/c/mens_category/sweaters/cashmere'}]},
    {img:'https://m.media-amazon.com/images/I/61ZS8w-MXNL._AC_UY695_.jpg',nm:'Quality Belt',desc:'Missing a quality leather belt to finish looks.',sev:'sev-lo',sl:'LOW',shops:[{name:'Allen Edmonds',url:'https://www.allenedmonds.com/accessories/belts'},{name:'Nordstrom',url:'https://www.nordstrom.com/browse/men/accessories/belts'},{name:'Todd Snyder',url:'https://www.toddsnyder.com/collections/belts'}]},
  ].map(function(e){
    var shopsHtml = e.shops.map(function(s) {
      return '<a href="'+s.url+'" target="_blank" style="color:var(--ink);text-decoration:none;font-size:10px;padding:3px 8px;background:var(--s2);border-radius:4px;white-space:nowrap">'+s.name+'</a>';
    }).join(' ');
    return '<div class="gap-item">'+
      '<div class="gap-ico" style="width:50px;height:50px;background:var(--s2);border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center">'+
        '<img src="'+e.img+'" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML=\'\'">'+
      '</div>'+
      '<div class="gap-info">'+
        '<div class="gap-name">'+e.nm+' <span class="sev '+e.sev+'">'+e.sl+'</span></div>'+
        '<div class="gap-desc">'+e.desc+'</div>'+
        '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">'+shopsHtml+'</div>'+
      '</div>'+
    '</div>';
  }).join('');
}

// ── BRANDS ──
var BRANDS = {
  'Luxury & Designer':[
    {nm:'Tom Ford',t:'Designer',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Tom_Ford_logo.svg/200px-Tom_Ford_logo.svg.png'},
    {nm:'Loro Piana',t:'Luxury',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Loro_Piana_logo.svg/200px-Loro_Piana_logo.svg.png'},
    {nm:'Brunello Cucinelli',t:'Luxury',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ef/Brunello_Cucinelli_logo.svg/200px-Brunello_Cucinelli_logo.svg.png'},
    {nm:'Zegna',t:'Italian',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/7/79/Ermenegildo_Zegna_Logo.svg/200px-Ermenegildo_Zegna_Logo.svg.png'},
    {nm:'Kiton',t:'Neapolitan',logo:'https://www.kiton.com/on/demandware.static/Sites-kiton-eu-Site/-/default/dw8e0e0e0e/images/logo.svg'},
    {nm:'Brioni',t:'Bespoke',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/45/Brioni_logo.svg/200px-Brioni_logo.svg.png'},
    {nm:'Canali',t:'Italian Suits',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/58/Canali_logo.svg/200px-Canali_logo.svg.png'},
    {nm:'Berluti',t:'Shoes & RTW',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Berluti_logo.svg/200px-Berluti_logo.svg.png'}
  ],
  'Contemporary':[
    {nm:'Aimé Leon Dore',t:'Prep / NYC',logo:'https://cdn.shopify.com/s/files/1/0207/1552/files/ALD_WORDMARK_200x.png'},
    {nm:'Todd Snyder',t:'American',logo:'https://cdn.shopify.com/s/files/1/0455/2227/7677/files/TS_Logo_200x.png'},
    {nm:'Mr Porter',t:'Curator',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/Mr_Porter_logo.svg/200px-Mr_Porter_logo.svg.png'},
    {nm:'Officine Générale',t:'Parisian',logo:'https://cdn.shopify.com/s/files/1/0277/3550/0245/files/logo-og_200x.png'},
    {nm:'Drakes',t:'British',logo:'https://www.drakes.com/media/logo/stores/1/drakes-logo.svg'},
    {nm:'Rowing Blazers',t:'Collegiate',logo:'https://cdn.shopify.com/s/files/1/1527/2651/files/RB_LOGO_200x.png'},
    {nm:'Alex Mill',t:'NYC',logo:'https://cdn.shopify.com/s/files/1/0450/4957/6897/files/alexmill-logo_200x.png'},
    {nm:'Corridor',t:'NYC',logo:'https://cdn.shopify.com/s/files/1/0012/2518/7498/files/corridor-logo_200x.png'},
    {nm:'Oliver Spencer',t:'British',logo:'https://www.oliverspencer.co.uk/media/logo/stores/1/os-logo.svg'}
  ],
  'Prep & Americana':[
    {nm:'Ralph Lauren',t:'American Prep',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/Polo_Ralph_Lauren_logo.svg/200px-Polo_Ralph_Lauren_logo.svg.png'},
    {nm:'Brooks Brothers',t:'Heritage',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f9/Brooks_Brothers_logo.svg/200px-Brooks_Brothers_logo.svg.png'},
    {nm:'J.Crew',t:'Casual Prep',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/J.Crew_Logo.svg/200px-J.Crew_Logo.svg.png'},
    {nm:'J.Press',t:'Ivy League',logo:'https://www.jpressonline.com/cdn/shop/files/jpress-logo_200x.png'},
    {nm:'Peter Millar',t:'Golf / Prep',logo:'https://www.petermillar.com/on/demandware.static/Sites-petermillar-Site/-/default/images/logo.svg'},
    {nm:'Faherty',t:'Coastal',logo:'https://cdn.shopify.com/s/files/1/0923/2961/files/faherty-logo_200x.png'},
    {nm:'Baracuta',t:'British Heritage',logo:'https://www.baracuta.com/on/demandware.static/Sites-BRCT_EU-Site/-/default/images/logo.svg'},
    {nm:'Vineyard Vines',t:'Coastal Prep',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Vineyard_Vines_logo.svg/200px-Vineyard_Vines_logo.svg.png'}
  ],
  'Streetwear':[
    {nm:'Noah NYC',t:'Surf Prep',logo:'https://cdn.shopify.com/s/files/1/1104/7287/files/noah-logo_200x.png'},
    {nm:'Carhartt WIP',t:'Workwear Luxe',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8d/Carhartt_logo.svg/200px-Carhartt_logo.svg.png'},
    {nm:'Our Legacy',t:'Swedish',logo:'https://cdn.shopify.com/s/files/1/0093/0514/1702/files/our-legacy-logo_200x.png'},
    {nm:'Acne Studios',t:'Swedish Minimal',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Acne_Studios_Logo.svg/200px-Acne_Studios_Logo.svg.png'},
    {nm:'A.P.C.',t:'French Basic',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/APC_logo.svg/200px-APC_logo.svg.png'},
    {nm:'Stone Island',t:'Technical',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Stone_Island_logo.svg/200px-Stone_Island_logo.svg.png'},
    {nm:'C.P. Company',t:'Italian Sport',logo:'https://www.cpcompany.com/on/demandware.static/Sites-CPCOMPANY_EU-Site/-/default/images/logo.svg'},
    {nm:'Stüssy',t:'OG Street',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/St%C3%BCssy_logo.svg/200px-St%C3%BCssy_logo.svg.png'},
    {nm:'Kith',t:'NYC Luxe Street',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Kith_logo.svg/200px-Kith_logo.svg.png'}
  ],
  'Outdoor & Heritage':[
    {nm:'Barbour',t:'British Heritage',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/ad/Barbour_logo.svg/200px-Barbour_logo.svg.png'},
    {nm:'Filson',t:'Pacific NW',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Filson_logo.svg/200px-Filson_logo.svg.png'},
    {nm:'Patagonia',t:'Outdoor/Ethical',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/Patagonia_%28clothing%29_logo.svg/200px-Patagonia_%28clothing%29_logo.svg.png'},
    {nm:"Arc'teryx",t:'Technical',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Arc%27teryx_logo.svg/200px-Arc%27teryx_logo.svg.png'},
    {nm:'Red Wing',t:'Heritage Boots',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Red_Wing_Shoes_logo.svg/200px-Red_Wing_Shoes_logo.svg.png'},
    {nm:'Pendleton',t:'American Wool',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Pendleton_Woolen_Mills_logo.svg/200px-Pendleton_Woolen_Mills_logo.svg.png'},
    {nm:'L.L.Bean',t:'New England',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/L.L.Bean_logo.svg/200px-L.L.Bean_logo.svg.png'}
  ],
  'Essentials':[
    {nm:'Uniqlo',t:'Japanese Basics',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/9/92/UNIQLO_logo.svg/200px-UNIQLO_logo.svg.png'},
    {nm:'COS',t:'Minimalist',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/COS_%28fashion_brand%29_logo.svg/200px-COS_%28fashion_brand%29_logo.svg.png'},
    {nm:'Arket',t:'Scandinavian',logo:'https://www.arket.com/static/images/arket-logo.svg'},
    {nm:'Sunspel',t:'British Basics',logo:'https://cdn.shopify.com/s/files/1/0070/1922/files/sunspel-logo_200x.png'},
    {nm:'Everlane',t:'Ethical Basics',logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Everlane_logo.svg/200px-Everlane_logo.svg.png'},
    {nm:'Buck Mason',t:'American Basics',logo:'https://cdn.shopify.com/s/files/1/0240/3625/0665/files/buck-mason-logo_200x.png'},
    {nm:'Asket',t:'Swedish Essentials',logo:'https://cdn.shopify.com/s/files/1/0521/7567/files/asket-logo_200x.png'},
    {nm:'Taylor Stitch',t:'Workwear Basics',logo:'https://cdn.shopify.com/s/files/1/0071/0551/2011/files/taylor-stitch-logo_200x.png'}
  ],
};
var activeBrand = null;
function renderBrands() {
  var c = document.getElementById('brand-tiers');
  if (!c) return;
  c.innerHTML = Object.keys(BRANDS).map(function(tier){
    return '<div class="tier-section"><div class="tier-label">'+tier+'</div><div class="brands-grid">'
      + BRANDS[tier].map(function(b){
          var logoHtml = b.logo 
            ? '<img src="'+b.logo+'" alt="'+b.nm+'" style="width:100%;height:100%;object-fit:contain" onerror="this.parentElement.innerHTML=\''+b.nm.substring(0,2).toUpperCase()+'\'">'
            : b.nm.substring(0,2).toUpperCase();
          return '<div class="brand-card'+(activeBrand===b.nm?' on':'')+'" onclick="selectBrand(\''+b.nm.replace(/'/g,"\\'")+"','"+b.nm.substring(0,2).toUpperCase()+"'"+')"><div class="brand-ico" style="background:#fff;border-radius:8px;padding:4px">'+logoHtml+'</div><div><div class="brand-name">'+b.nm+'</div><div class="brand-tier-tag">'+b.t+'</div></div></div>';
        }).join('')
      +'</div></div>';
  }).join('');
}
function selectBrand(nm, ico) {
  if (activeBrand === nm) { clearOverride(); return; }
  activeBrand = nm;
  renderBrands();
  document.getElementById('override-bar').style.display = 'flex';
  document.getElementById('override-name').textContent = nm;
  var stLabel = document.getElementById('style-label');
  if (stLabel) stLabel.textContent = nm.split(' ')[0];
  var dash = document.getElementById('brand-dashboard');
  if (dash) dash.style.display = 'block';
  document.getElementById('dash-ico').textContent = ico;
  document.getElementById('dash-name').textContent = nm;
  var dm = document.getElementById('dash-matches');
  if (dm) dm.innerHTML = [['Prep / ALD',68],['Minimalist',48],['Todd Snyder',40],['Avant-garde',22],['Surf-Prep',18]].map(function(r){return '<div class="match-row"><div class="match-style">'+r[0]+'</div><div class="match-track"><div class="match-fill" style="width:'+r[1]+'%"></div></div><div class="match-pct">'+r[1]+'%</div></div>';}).join('');
  var dr = document.getElementById('dash-recs');
  if (dr) dr.innerHTML = [{ico:'👞',nm:'Suede Penny Loafer',sub:'Accessories',price:'$395'},{ico:'🧥',nm:'Wool Overshirt',sub:'Tops',price:'$285'},{ico:'👖',nm:'Corduroy Trousers',sub:'Bottoms',price:'$195'},{ico:'🧢',nm:'5-Panel Camp Cap',sub:'Accessories',price:'$95'}].map(function(r){return '<div class="rec-row"><div class="rec-ico">'+r.ico+'</div><div><div class="rec-name">'+r.nm+'</div><div class="rec-sub">'+r.sub+'</div></div><div class="rec-price">'+r.price+'</div></div>';}).join('');
  showToast('✦ ' + nm + ' override active');
}
function clearOverride() {
  activeBrand = null;
  renderBrands();
  document.getElementById('override-bar').style.display = 'none';
  document.getElementById('brand-dashboard').style.display = 'none';
  var stLabel = document.getElementById('style-label');
  if (stLabel) stLabel.textContent = styleLabel();
  showToast('Override cleared');
}

// ── TOAST ──
var toastTimer;
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function(){ t.classList.remove('show'); }, 1200);
}

// ────────────────────────────────────────
// CLOSET RENDER
// ────────────────────────────────────────
function imgHtml(src) { return src ? '<img src="'+src+'" onload="this.style.opacity=1" style="opacity:0;transition:opacity .3s" onerror="this.remove()" alt="">' : ''; }

function renderCloset(filter) {
  filter = filter || 'all';
  var grid = document.getElementById('closet-grid');
  if (!grid) return;
  var items = filter === 'all' ? ITEMS : ITEMS.filter(function(i){ return i.cat === filter; });
  var catIco = {Tops:'👔',Bottoms:'👖',Outerwear:'🧥',Footwear:'👟',Accessories:'🧣',Other:'👕'};
  var html = items.map(function(item){
    var ico = catIco[item.cat] || '👕';
    var imgTag = imgHtml(item.img);
    return '<div class="c-card" onclick="logWear('+item.id+')">'
      + '<div class="c-img">'+imgTag+ico+'</div>'
      + '<div class="c-body"><div class="c-name">'+item.name+'</div>'
      + '<div class="c-meta"><span>'+item.cat+'</span><span class="c-worn">'+item.wears+'×</span></div></div>'
      + '</div>';
  }).join('');
  html += '<div class="add-card" onclick="openUpload()">'
    + '<svg width="26" height="26" viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.3"><circle cx="14" cy="14" r="12"/><line x1="14" y1="9" x2="14" y2="19"/><line x1="9" y1="14" x2="19" y2="14"/></svg>'
    + '<div class="add-label">Add Item</div></div>';
  grid.innerHTML = html;

  // also update builder
  renderBuilder(builderFilter_active || 'all');
}

function logWear(id) {
  var item = ITEMS.find(function(i){ return i.id === id; });
  if (!item) return;
  item.wears++;
  saveCloset();
  renderCloset();
  updateHomeStats();
  // If on stats page, live-update
  var active = document.querySelector('.page.active');
  if (active && active.id === 'page-stats') initStats();
  showToast(item.name + ' — wear logged ✓');
}

function updateHomeStats() {
  var el = document.getElementById('stat-items');
  if (el) el.textContent = ITEMS.length;
  var el2 = document.getElementById('stat-outfits');
  if (el2) el2.textContent = SAVED_OUTFITS.length;
  var devItems = document.getElementById('dev-items');
  if (devItems) devItems.textContent = ITEMS.length;
  
  // Update week view and today's outfit
  renderWeekView();
  renderTodayOutfit();
}

// ════════════════════════════════════════════════════════
// SMART OUTFIT GENERATION ENGINE
// ════════════════════════════════════════════════════════

function generateSmartOutfits() {
  var suggestions = [];
  
  if (ITEMS.length < 2) return suggestions;
  
  // Get user preferences
  var ws = (userProfile && userProfile.workSchedule) || {};
  var dressCode = ws.dressCode || 'smart-casual';
  var casualDays = ws.casualDays || [0, 6];
  var moods = (userProfile && userProfile.moods) || ['smart-casual'];
  
  // Get today's context
  var today = new Date().getDay();
  var isCasualDay = casualDays.indexOf(today) > -1;
  var targetFormality = isCasualDay ? 'casual' : dressCode;
  
  // Categorize items with wear data
  var wardrobe = {
    tops: ITEMS.filter(function(i) { return i.cat === 'Tops'; }),
    bottoms: ITEMS.filter(function(i) { return i.cat === 'Bottoms'; }),
    footwear: ITEMS.filter(function(i) { return i.cat === 'Footwear'; }),
    outerwear: ITEMS.filter(function(i) { return i.cat === 'Outerwear'; }),
    suiting: ITEMS.filter(function(i) { return i.cat === 'Suiting'; }),
    accessories: ITEMS.filter(function(i) { return i.cat === 'Accessories'; })
  };
  
  // 1. TODAY'S CURATED OUTFIT - Based on dress code + least worn items
  var todayOutfit = buildCuratedOutfit(wardrobe, targetFormality, moods, []);
  if (todayOutfit.length >= 2) {
    suggestions.push({
      name: isCasualDay ? 'Today · Casual' : 'Today · ' + formatDressCode(dressCode),
      type: getDressCodeDescription(targetFormality),
      items: todayOutfit,
      reason: 'Curated for today'
    });
  }
  
  // 2. UNDERUSED GEMS - Items you haven't worn much
  var underusedOutfit = buildUnderusedOutfit(wardrobe, todayOutfit);
  if (underusedOutfit.length >= 2) {
    suggestions.push({
      name: 'Underused Gems',
      type: 'Give these some love',
      items: underusedOutfit,
      reason: 'Rotate your wardrobe'
    });
  }
  
  // 3. SIGNATURE LOOK - Your most worn pieces together
  var signatureOutfit = buildSignatureOutfit(wardrobe, [...todayOutfit, ...underusedOutfit]);
  if (signatureOutfit.length >= 2) {
    suggestions.push({
      name: 'Your Signatures',
      type: 'Tried & true favorites',
      items: signatureOutfit,
      reason: 'Your go-to pieces'
    });
  }
  
  // 4. STYLE MOOD - Based on their aesthetic preferences
  var moodOutfit = buildMoodBasedOutfit(wardrobe, moods, [...todayOutfit, ...underusedOutfit, ...signatureOutfit]);
  if (moodOutfit.length >= 2) {
    suggestions.push({
      name: getMoodName(moods),
      type: getMoodDescription(moods),
      items: moodOutfit,
      reason: 'Matches your style'
    });
  }
  
  return suggestions.slice(0, 4);
}

// Build outfit prioritizing least worn items that match formality
function buildCuratedOutfit(wardrobe, formality, moods, exclude) {
  var outfit = [];
  var excludeIds = exclude.map(function(i) { return i.id; });
  
  // Score and sort items by: formality match + least worn
  function scoreItem(item, preferDressy) {
    var score = 100;
    var name = (item.name || '').toLowerCase();
    
    // Penalize high wear count (prioritize underused)
    score -= (item.wears || 0) * 5;
    
    // Formality matching
    var isCasual = name.match(/casual|jeans|sneaker|t-shirt|tee|hoodie|sweater|shorts|jogger/);
    var isDressy = name.match(/dress|oxford|loafer|blazer|suit|chino|slack|trouser|derby/);
    
    if (formality === 'casual' && isCasual) score += 20;
    if (formality === 'business' && isDressy) score += 30;
    if (formality === 'business-casual' && isDressy) score += 20;
    if (formality === 'smart-casual' && !isCasual) score += 10;
    
    return score;
  }
  
  var preferDressy = formality !== 'casual';
  
  // Pick top
  var tops = wardrobe.tops.filter(function(i) { return excludeIds.indexOf(i.id) === -1; });
  tops.sort(function(a, b) { return scoreItem(b, preferDressy) - scoreItem(a, preferDressy); });
  if (tops.length > 0) outfit.push(tops[0]);
  
  // Pick bottom that coordinates
  var bottoms = wardrobe.bottoms.filter(function(i) { return excludeIds.indexOf(i.id) === -1; });
  bottoms.sort(function(a, b) { return scoreItem(b, preferDressy) - scoreItem(a, preferDressy); });
  if (bottoms.length > 0) outfit.push(bottoms[0]);
  
  // Pick footwear
  var shoes = wardrobe.footwear.filter(function(i) { return excludeIds.indexOf(i.id) === -1; });
  shoes.sort(function(a, b) { return scoreItem(b, preferDressy) - scoreItem(a, preferDressy); });
  if (shoes.length > 0) outfit.push(shoes[0]);
  
  // Add layer if business or business-casual
  if (preferDressy && wardrobe.suiting.length > 0) {
    var suits = wardrobe.suiting.filter(function(i) { return excludeIds.indexOf(i.id) === -1; });
    if (suits.length > 0) outfit.push(suits[0]);
  } else if (wardrobe.outerwear.length > 0 && outfit.length < 4) {
    var outer = wardrobe.outerwear.filter(function(i) { return excludeIds.indexOf(i.id) === -1; });
    outer.sort(function(a, b) { return scoreItem(b, preferDressy) - scoreItem(a, preferDressy); });
    if (outer.length > 0) outfit.push(outer[0]);
  }
  
  return outfit.slice(0, 4);
}

// Build outfit from least worn items
function buildUnderusedOutfit(wardrobe, exclude) {
  var excludeIds = exclude.map(function(i) { return i.id; });
  
  // Get all items sorted by wear count (ascending)
  var allItems = ITEMS.filter(function(i) { return excludeIds.indexOf(i.id) === -1; });
  allItems.sort(function(a, b) { return (a.wears || 0) - (b.wears || 0); });
  
  var outfit = [];
  var usedCats = [];
  
  // Pick one from each category, prioritizing least worn
  allItems.forEach(function(item) {
    if (outfit.length >= 4) return;
    if (usedCats.indexOf(item.cat) === -1) {
      outfit.push(item);
      usedCats.push(item.cat);
    }
  });
  
  return outfit;
}

// Build outfit from most worn favorites
function buildSignatureOutfit(wardrobe, exclude) {
  var excludeIds = exclude.map(function(i) { return i.id; });
  
  // Get all items sorted by wear count (descending)
  var allItems = ITEMS.filter(function(i) { return excludeIds.indexOf(i.id) === -1; });
  allItems.sort(function(a, b) { return (b.wears || 0) - (a.wears || 0); });
  
  var outfit = [];
  var usedCats = [];
  
  // Pick one from each category, prioritizing most worn
  allItems.forEach(function(item) {
    if (outfit.length >= 4) return;
    if (usedCats.indexOf(item.cat) === -1) {
      outfit.push(item);
      usedCats.push(item.cat);
    }
  });
  
  return outfit;
}

// Build outfit based on style moods
function buildMoodBasedOutfit(wardrobe, moods, exclude) {
  var excludeIds = exclude.map(function(i) { return i.id; });
  var mood = moods[0] || 'smart-casual';
  
  // Keywords for each mood
  var moodKeywords = {
    'streetwear': ['sneaker', 'hoodie', 'jeans', 'graphic', 'jordan', 'nike', 'oversized'],
    'business': ['suit', 'blazer', 'oxford', 'loafer', 'dress', 'tie', 'formal'],
    'old-money': ['cashmere', 'wool', 'navy', 'cream', 'loafer', 'oxford', 'polo'],
    'minimal': ['white', 'black', 'grey', 'basic', 'clean', 'simple'],
    'ald': ['polo', 'rugby', 'new balance', 'chino', 'cap', 'sweater'],
    'coastal': ['linen', 'white', 'blue', 'boat', 'relaxed', 'light'],
    'workwear': ['denim', 'boot', 'flannel', 'chore', 'canvas', 'brown'],
    'avant': ['black', 'oversized', 'layer', 'drape', 'rick']
  };
  
  var keywords = moodKeywords[mood] || [];
  
  function scoreForMood(item) {
    var score = 0;
    var name = (item.name || '').toLowerCase();
    keywords.forEach(function(kw) {
      if (name.indexOf(kw) > -1) score += 10;
    });
    return score;
  }
  
  var allItems = ITEMS.filter(function(i) { return excludeIds.indexOf(i.id) === -1; });
  allItems.sort(function(a, b) { return scoreForMood(b) - scoreForMood(a); });
  
  var outfit = [];
  var usedCats = [];
  
  allItems.forEach(function(item) {
    if (outfit.length >= 4) return;
    if (usedCats.indexOf(item.cat) === -1) {
      outfit.push(item);
      usedCats.push(item.cat);
    }
  });
  
  return outfit;
}

function formatDressCode(code) {
  switch(code) {
    case 'casual': return 'Casual';
    case 'smart-casual': return 'Smart Casual';
    case 'business-casual': return 'Biz Casual';
    case 'business': return 'Business';
    default: return 'Smart Casual';
  }
}

function getDressCodeDescription(code) {
  switch(code) {
    case 'casual': return 'Relaxed & comfortable';
    case 'smart-casual': return 'Put together, not stuffy';
    case 'business-casual': return 'Office appropriate';
    case 'business': return 'Professional & polished';
    default: return 'Versatile style';
  }
}

function getMoodName(moods) {
  var mood = moods[0] || 'smart-casual';
  var names = {
    'streetwear': 'Street Style',
    'business': 'Sharp & Tailored',
    'old-money': 'Old Money',
    'minimal': 'Minimal Clean',
    'ald': 'Prep Sport',
    'coastal': 'Coastal Ease',
    'workwear': 'Heritage',
    'avant': 'Avant-garde',
    'smart-casual': 'Smart Casual'
  };
  return names[mood] || 'Your Style';
}

function getMoodDescription(moods) {
  var mood = moods[0] || 'smart-casual';
  var descs = {
    'streetwear': 'Sneakers & layers',
    'business': 'Suits & dress shoes',
    'old-money': 'Quiet luxury vibes',
    'minimal': 'Less is more',
    'ald': 'Sporty prep aesthetic',
    'coastal': 'Relaxed & breezy',
    'workwear': 'Rugged classics',
    'avant': 'Bold & experimental',
    'smart-casual': 'Effortlessly polished'
  };
  return descs[mood] || 'Based on your profile';
}

// ════════════════════════════════════════════════════════
// OUTFITS PAGE RENDERER
// ════════════════════════════════════════════════════════

function renderOutfitsPage() {
  var emptyEl = document.getElementById('outfits-empty');
  var contentEl = document.getElementById('outfits-content');
  var curatedEl = document.getElementById('curated-outfits');
  var savedEl = document.getElementById('saved-outfits-display');
  
  if (!emptyEl || !contentEl) return;
  
  // Show empty state if not enough items
  if (ITEMS.length < 2) {
    emptyEl.style.display = 'block';
    contentEl.style.display = 'none';
    return;
  }
  
  emptyEl.style.display = 'none';
  contentEl.style.display = 'block';
  
  // Generate curated outfits
  var suggestions = generateSmartOutfits();
  
  if (curatedEl) {
    curatedEl.innerHTML = suggestions.map(function(outfit) {
      return renderOutfitCard(outfit);
    }).join('');
  }
  
  // Show saved outfits
  if (savedEl) {
    if (SAVED_OUTFITS.length === 0) {
      savedEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--ink4);font-size:12px">No saved outfits yet. Tap "Save" on any outfit above.</div>';
    } else {
      savedEl.innerHTML = SAVED_OUTFITS.map(function(outfit, idx) {
        var items = outfit.items.map(function(id) {
          return ITEMS.find(function(i) { return i.id === id; });
        }).filter(Boolean);
        return renderOutfitCard({
          name: outfit.name || 'Saved Outfit ' + (idx + 1),
          type: outfit.occasion || (items.length + ' items'),
          items: items,
          savedId: idx
        });
      }).join('');
    }
  }
}

function renderOutfitCard(outfit) {
  var items = outfit.items || [];
  var gridClass = items.length <= 2 ? 'two' : 'three';
  
  var gridHtml = items.slice(0, 4).map(function(item, idx) {
    var cellClass = (idx === 0 && items.length >= 3) ? 'o-cell wide' : 'o-cell';
    var imgHtml = item.img 
      ? '<img src="' + item.img + '" onerror="this.style.opacity=\'0\'" alt="' + item.name + '">'
      : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--s3);font-size:12px">' + (item.name || '').substring(0, 8) + '</div>';
    return '<div class="' + cellClass + '">' + imgHtml + '</div>';
  }).join('');
  
  var tagsHtml = items.slice(0, 3).map(function(item) {
    var shortName = (item.name || 'Item').split(' ').slice(0, 2).join(' ');
    return '<div class="o-tag">' + shortName + '</div>';
  }).join('');
  
  var itemIds = items.map(function(i) { return i.id; });
  var itemIdsStr = itemIds.join(',');
  
  return '<div class="o-card">' +
    '<div class="o-preview">' +
      '<div class="o-badge">' + (outfit.type || 'Outfit') + '</div>' +
      '<div class="o-grid ' + gridClass + '">' + gridHtml + '</div>' +
      (items.length > 2 ? '<div class="o-div-h" style="top:50%"></div>' : '') +
      '<div class="o-div-v"></div>' +
    '</div>' +
    '<div class="o-body">' +
      '<div class="o-name">' + (outfit.name || 'Curated Outfit') + '</div>' +
      '<div class="o-tags">' + tagsHtml + '</div>' +
      '<div class="o-actions">' +
        '<button class="btn btn-dark" onclick="saveGeneratedOutfit([' + itemIdsStr + '], \'' + (outfit.name || 'Saved Outfit').replace(/'/g, '') + '\')">Save</button>' +
        '<button class="btn btn-outline" onclick="wearOutfitToday([' + itemIdsStr + '])">Wear Today</button>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function saveGeneratedOutfit(itemIds, name) {
  SAVED_OUTFITS.push({
    items: itemIds,
    name: name,
    occasion: 'Saved',
    createdAt: Date.now()
  });
  saveOutfits();
  showToast('Outfit saved ✓');
  renderOutfitsPage();
}

function wearOutfitToday(itemIds) {
  var todayKey = getTodayKey();
  
  // Track wear count
  incrementWearCount(itemIds);
  
  weekPlan[todayKey] = {
    items: itemIds,
    name: itemIds.length + ' items'
  };
  saveWeekPlan();
  showToast('Wearing this today ✓');
}

function categorizeWardrobe() {
  var wardrobe = {
    tops: { casual: [], dressy: [], all: [] },
    bottoms: { casual: [], dressy: [], all: [] },
    footwear: { casual: [], dressy: [], all: [] },
    outerwear: { casual: [], dressy: [], all: [] },
    suiting: [],
    accessories: []
  };
  
  ITEMS.forEach(function(item) {
    var name = (item.name || '').toLowerCase();
    var isCasual = name.match(/casual|jeans|sneaker|t-shirt|tee|hoodie|sweater|shorts|jogger|trainer/);
    var isDressy = name.match(/dress|oxford|loafer|blazer|suit|chino|slack|trouser|derby|tie|formal/);
    
    switch(item.cat) {
      case 'Tops':
        wardrobe.tops.all.push(item);
        if (isCasual) wardrobe.tops.casual.push(item);
        else if (isDressy) wardrobe.tops.dressy.push(item);
        else wardrobe.tops.casual.push(item); // Default to casual
        break;
      case 'Bottoms':
        wardrobe.bottoms.all.push(item);
        if (isCasual) wardrobe.bottoms.casual.push(item);
        else if (isDressy) wardrobe.bottoms.dressy.push(item);
        else wardrobe.bottoms.casual.push(item);
        break;
      case 'Footwear':
        wardrobe.footwear.all.push(item);
        if (isCasual) wardrobe.footwear.casual.push(item);
        else if (isDressy) wardrobe.footwear.dressy.push(item);
        else wardrobe.footwear.casual.push(item);
        break;
      case 'Outerwear':
        wardrobe.outerwear.all.push(item);
        if (isCasual) wardrobe.outerwear.casual.push(item);
        else if (isDressy) wardrobe.outerwear.dressy.push(item);
        else wardrobe.outerwear.casual.push(item);
        break;
      case 'Suiting':
        wardrobe.suiting.push(item);
        break;
      case 'Accessories':
        wardrobe.accessories.push(item);
        break;
    }
  });
  
  return wardrobe;
}

function buildCasualOutfit(wardrobe, moods, exclude) {
  exclude = exclude || [];
  var excludeIds = exclude.map(function(i) { return i.id; });
  
  var items = [];
  
  // Pick casual top (or any top if no casual)
  var topPool = wardrobe.tops.casual.length ? wardrobe.tops.casual : wardrobe.tops.all;
  var top = pickItem(topPool, excludeIds);
  if (top) items.push(top);
  
  // Pick casual bottom
  var bottomPool = wardrobe.bottoms.casual.length ? wardrobe.bottoms.casual : wardrobe.bottoms.all;
  var bottom = pickItem(bottomPool, excludeIds);
  if (bottom) items.push(bottom);
  
  // Pick casual footwear
  var shoePool = wardrobe.footwear.casual.length ? wardrobe.footwear.casual : wardrobe.footwear.all;
  var shoes = pickItem(shoePool, excludeIds);
  if (shoes) items.push(shoes);
  
  // Maybe add outerwear
  if (wardrobe.outerwear.all.length) {
    var outerPool = wardrobe.outerwear.casual.length ? wardrobe.outerwear.casual : wardrobe.outerwear.all;
    var outer = pickItem(outerPool, excludeIds);
    if (outer) items.push(outer);
  }
  
  return { items: items.slice(0, 4) };
}

function buildWorkOutfit(wardrobe, dressCode, moods, exclude) {
  exclude = exclude || [];
  var excludeIds = exclude.map(function(i) { return i.id; });
  
  var items = [];
  
  if (dressCode === 'business') {
    // Full business - suit preferred
    if (wardrobe.suiting.length) {
      var suit = pickItem(wardrobe.suiting, excludeIds);
      if (suit) items.push(suit);
    }
    // Dress shirt
    var topPool = wardrobe.tops.dressy.length ? wardrobe.tops.dressy : wardrobe.tops.all;
    var top = pickItem(topPool, excludeIds);
    if (top) items.push(top);
    // Dress pants
    var bottomPool = wardrobe.bottoms.dressy.length ? wardrobe.bottoms.dressy : wardrobe.bottoms.all;
    var bottom = pickItem(bottomPool, excludeIds);
    if (bottom) items.push(bottom);
    // Dress shoes
    var shoePool = wardrobe.footwear.dressy.length ? wardrobe.footwear.dressy : wardrobe.footwear.all;
    var shoes = pickItem(shoePool, excludeIds);
    if (shoes) items.push(shoes);
    
  } else if (dressCode === 'business-casual') {
    // Business casual - dress shirt, chinos, nice shoes
    var topPool = wardrobe.tops.dressy.length ? wardrobe.tops.dressy : wardrobe.tops.all;
    var top = pickItem(topPool, excludeIds);
    if (top) items.push(top);
    
    var bottomPool = wardrobe.bottoms.dressy.length ? wardrobe.bottoms.dressy : wardrobe.bottoms.all;
    var bottom = pickItem(bottomPool, excludeIds);
    if (bottom) items.push(bottom);
    
    var shoePool = wardrobe.footwear.dressy.length ? wardrobe.footwear.dressy : wardrobe.footwear.all;
    var shoes = pickItem(shoePool, excludeIds);
    if (shoes) items.push(shoes);
    
    // Optional blazer
    if (wardrobe.suiting.length) {
      var blazer = pickItem(wardrobe.suiting, excludeIds);
      if (blazer) items.push(blazer);
    } else if (wardrobe.outerwear.dressy.length) {
      var outer = pickItem(wardrobe.outerwear.dressy, excludeIds);
      if (outer) items.push(outer);
    }
    
  } else {
    // Smart casual or casual dress code
    var topPool = wardrobe.tops.all;
    var top = pickItem(topPool, excludeIds);
    if (top) items.push(top);
    
    var bottomPool = wardrobe.bottoms.all;
    var bottom = pickItem(bottomPool, excludeIds);
    if (bottom) items.push(bottom);
    
    var shoePool = wardrobe.footwear.all;
    var shoes = pickItem(shoePool, excludeIds);
    if (shoes) items.push(shoes);
    
    if (wardrobe.outerwear.all.length) {
      var outer = pickItem(wardrobe.outerwear.all, excludeIds);
      if (outer) items.push(outer);
    }
  }
  
  return { items: items.slice(0, 4) };
}

function buildMoodOutfit(wardrobe, moods, exclude) {
  exclude = exclude || [];
  var excludeIds = exclude.map(function(i) { return i.id; });
  
  var items = [];
  var moodName = 'Your Style';
  var moodType = 'Based on Profile';
  
  // Check user's style moods and build accordingly
  if (moods.indexOf('streetwear') > -1) {
    moodName = 'Street Style';
    moodType = 'Streetwear Vibes';
    // Prefer hoodies, sneakers, jeans
    var top = pickItemByKeywords(wardrobe.tops.all, ['hoodie', 'sweatshirt', 'tee', 'graphic'], excludeIds);
    if (top) items.push(top);
    var bottom = pickItemByKeywords(wardrobe.bottoms.all, ['jeans', 'jogger', 'cargo'], excludeIds);
    if (bottom) items.push(bottom);
    var shoes = pickItemByKeywords(wardrobe.footwear.all, ['sneaker', 'trainer', 'jordan', 'nike'], excludeIds);
    if (shoes) items.push(shoes);
    
  } else if (moods.indexOf('business') > -1 || moods.indexOf('old-money') > -1) {
    moodName = 'Classic Style';
    moodType = 'Timeless & Refined';
    var top = pickItemByKeywords(wardrobe.tops.all, ['shirt', 'oxford', 'polo', 'button'], excludeIds);
    if (top) items.push(top);
    var bottom = pickItemByKeywords(wardrobe.bottoms.all, ['chino', 'trouser', 'slack', 'wool'], excludeIds);
    if (bottom) items.push(bottom);
    var shoes = pickItemByKeywords(wardrobe.footwear.all, ['loafer', 'oxford', 'derby', 'leather'], excludeIds);
    if (shoes) items.push(shoes);
    if (wardrobe.suiting.length) {
      var blazer = pickItem(wardrobe.suiting, excludeIds);
      if (blazer) items.push(blazer);
    }
    
  } else if (moods.indexOf('minimal') > -1) {
    moodName = 'Minimal';
    moodType = 'Clean & Simple';
    var top = pickItemByKeywords(wardrobe.tops.all, ['white', 'black', 'grey', 'neutral', 'basic'], excludeIds);
    if (!top) top = pickItem(wardrobe.tops.all, excludeIds);
    if (top) items.push(top);
    var bottom = pickItemByKeywords(wardrobe.bottoms.all, ['black', 'navy', 'grey', 'chino'], excludeIds);
    if (!bottom) bottom = pickItem(wardrobe.bottoms.all, excludeIds);
    if (bottom) items.push(bottom);
    var shoes = pickItem(wardrobe.footwear.all, excludeIds);
    if (shoes) items.push(shoes);
    
  } else if (moods.indexOf('ald') > -1 || moods.indexOf('coastal') > -1) {
    moodName = 'Prep Style';
    moodType = 'ALD / Coastal';
    var top = pickItemByKeywords(wardrobe.tops.all, ['polo', 'rugby', 'oxford', 'sweater'], excludeIds);
    if (!top) top = pickItem(wardrobe.tops.all, excludeIds);
    if (top) items.push(top);
    var bottom = pickItemByKeywords(wardrobe.bottoms.all, ['chino', 'short', 'khaki'], excludeIds);
    if (!bottom) bottom = pickItem(wardrobe.bottoms.all, excludeIds);
    if (bottom) items.push(bottom);
    var shoes = pickItemByKeywords(wardrobe.footwear.all, ['loafer', 'boat', 'sneaker', 'white'], excludeIds);
    if (!shoes) shoes = pickItem(wardrobe.footwear.all, excludeIds);
    if (shoes) items.push(shoes);
    
  } else {
    // Default smart casual
    moodName = 'Smart Casual';
    moodType = 'Versatile Look';
    var top = pickItem(wardrobe.tops.all, excludeIds);
    if (top) items.push(top);
    var bottom = pickItem(wardrobe.bottoms.all, excludeIds);
    if (bottom) items.push(bottom);
    var shoes = pickItem(wardrobe.footwear.all, excludeIds);
    if (shoes) items.push(shoes);
  }
  
  return { items: items.slice(0, 4), name: moodName, type: moodType };
}

function buildRandomOutfit(wardrobe, exclude) {
  exclude = exclude || [];
  var excludeIds = exclude.map(function(i) { return i.id; });
  
  var items = [];
  
  // Random picks from all items
  var top = pickRandom(wardrobe.tops.all, excludeIds);
  if (top) items.push(top);
  
  var bottom = pickRandom(wardrobe.bottoms.all, excludeIds);
  if (bottom) items.push(bottom);
  
  var shoes = pickRandom(wardrobe.footwear.all, excludeIds);
  if (shoes) items.push(shoes);
  
  var allOuter = [...wardrobe.outerwear.all, ...wardrobe.suiting];
  if (allOuter.length) {
    var outer = pickRandom(allOuter, excludeIds);
    if (outer) items.push(outer);
  }
  
  return { items: items.slice(0, 4) };
}

// Helper: Pick first available item not in exclude list
function pickItem(pool, excludeIds) {
  for (var i = 0; i < pool.length; i++) {
    if (excludeIds.indexOf(pool[i].id) === -1) {
      return pool[i];
    }
  }
  return pool[0] || null;
}

// Helper: Pick item matching keywords
function pickItemByKeywords(pool, keywords, excludeIds) {
  for (var i = 0; i < pool.length; i++) {
    if (excludeIds.indexOf(pool[i].id) === -1) {
      var name = (pool[i].name || '').toLowerCase();
      for (var k = 0; k < keywords.length; k++) {
        if (name.indexOf(keywords[k]) > -1) {
          return pool[i];
        }
      }
    }
  }
  return null;
}

// Helper: Pick random item not in exclude list
function pickRandom(pool, excludeIds) {
  var available = pool.filter(function(item) {
    return excludeIds.indexOf(item.id) === -1;
  });
  if (available.length === 0) return null;
  return available[Math.floor(Math.random() * available.length)];
}

// Helper: Format dress code for display
function formatDressCode(code) {
  switch(code) {
    case 'casual': return 'Casual';
    case 'smart-casual': return 'Smart Casual';
    case 'business-casual': return 'Biz Casual';
    case 'business': return 'Business';
    default: return 'Smart Casual';
  }
}

function applySuggestedOutfit(itemIds) {
  var todayKey = getTodayKey();
  
  // Track wear count
  incrementWearCount(itemIds);
  
  weekPlan[todayKey] = {
    items: itemIds,
    name: itemIds.length + ' items'
  };
  saveWeekPlan();
  renderWeekView();
  renderTodayOutfit();
  showToast('Outfit applied for today ✓');
}

// ────────────────────────────────────────
// WEEKLY OUTFIT PLANNER
// ────────────────────────────────────────
var WEEK_PLAN_KEY = 'vestiary_week_plan_v1';
var weekPlan = (function(){ try { return JSON.parse(localStorage.getItem(WEEK_PLAN_KEY)||'{}'); } catch(e){ return {}; } })();
var currentPickerDay = null;
var pickerSelectedItems = [];

function saveWeekPlan() {
  try { localStorage.setItem(WEEK_PLAN_KEY, JSON.stringify(weekPlan)); } catch(e) {}
}

function getTodayKey() {
  var d = new Date();
  return d.toISOString().split('T')[0]; // YYYY-MM-DD
}

function getWeekDays() {
  var days = [];
  var today = new Date();
  var dayOfWeek = today.getDay(); // 0 = Sunday
  
  // Start from Sunday of current week
  var sunday = new Date(today);
  sunday.setDate(today.getDate() - dayOfWeek);
  
  var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  for (var i = 0; i < 7; i++) {
    var d = new Date(sunday);
    d.setDate(sunday.getDate() + i);
    days.push({
      name: dayNames[i],
      date: d.toISOString().split('T')[0],
      dayNum: d.getDate(),
      isToday: d.toDateString() === today.toDateString(),
      index: i
    });
  }
  return days;
}

function renderWeekView() {
  var row = document.getElementById('week-row');
  if (!row) return;
  
  var days = getWeekDays();
  var todayIndex = days.findIndex(function(d) { return d.isToday; });
  
  row.innerHTML = days.map(function(day) {
    var planned = weekPlan[day.date];
    var hasOutfit = planned && planned.items && planned.items.length > 0;
    var className = day.isToday ? 'today' : (hasOutfit ? 'planned' : 'empty');
    var label = day.isToday ? 'Today' : (hasOutfit ? '✓' : '+');
    var style = (!day.isToday && !hasOutfit) ? 'color:var(--ink4)' : '';
    
    return '<div class="week-day ' + className + '" id="week-day-' + day.index + '" onclick="openOutfitPicker(\'' + day.date + '\')">' +
      '<div class="week-day-name" style="' + style + '">' + day.name + '</div>' +
      '<div class="week-day-ico" style="' + style + '">' + label + '</div>' +
    '</div>';
  }).join('');
  
  // Auto-scroll to today after a small delay
  setTimeout(function() {
    var todayEl = document.getElementById('week-day-' + todayIndex);
    if (todayEl && row) {
      var scrollPos = todayEl.offsetLeft - (row.offsetWidth / 2) + (todayEl.offsetWidth / 2);
      row.scrollLeft = Math.max(0, scrollPos);
    }
  }, 100);
}

function renderTodayOutfit() {
  var todayKey = getTodayKey();
  var planned = weekPlan[todayKey];
  var nameEl = document.getElementById('today-outfit-name');
  var itemsEl = document.getElementById('today-outfit-items');
  
  if (!nameEl || !itemsEl) return;
  
  if (!planned || !planned.items || planned.items.length === 0) {
    nameEl.textContent = 'No outfit planned';
    itemsEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--ink4);font-size:12px;width:100%">Tap "Plan Outfit" to select items</div>';
    return;
  }
  
  nameEl.textContent = planned.name || 'Today\'s Look';
  
  // Get the actual items
  var outfitItems = planned.items.map(function(id) {
    return ITEMS.find(function(item) { return item.id === id; });
  }).filter(Boolean);
  
  if (outfitItems.length === 0) {
    itemsEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--ink4);font-size:12px;width:100%">Items no longer in closet</div>';
    return;
  }
  
  itemsEl.innerHTML = outfitItems.map(function(item) {
    if (item.img) {
      return '<div class="today-item"><img src="' + item.img + '" alt="' + item.name + '" onerror="this.parentElement.innerHTML=\'' + item.name.substring(0,2) + '\'"></div>';
    } else {
      return '<div class="today-item" style="font-size:10px;display:flex;align-items:center;justify-content:center">' + item.name.substring(0,8) + '</div>';
    }
  }).join('');
}

function openOutfitPicker(dateKey) {
  currentPickerDay = dateKey;
  var planned = weekPlan[dateKey];
  pickerSelectedItems = (planned && planned.items) ? planned.items.slice() : [];
  
  // Get day info
  var d = new Date(dateKey);
  var dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  var dayName = dayNames[d.getDay()];
  var suggestion = getDaySuggestion(dateKey);
  
  // Set title with suggestion
  var today = new Date();
  var isToday = dateKey === today.toISOString().split('T')[0];
  var title = isToday ? 'Today\'s Outfit' : dayName;
  document.getElementById('outfit-picker-title').innerHTML = title + ' <span style="font-size:12px;color:var(--ink3);font-family:Karla,sans-serif">(' + suggestion.label + ')</span>';
  
  // Render items with suggestions highlighted
  renderOutfitPickerItems(suggestion.type);
  renderOutfitPickerSaved();
  
  document.getElementById('outfit-picker-overlay').classList.add('open');
}

function closeOutfitPicker() {
  document.getElementById('outfit-picker-overlay').classList.remove('open');
  currentPickerDay = null;
  pickerSelectedItems = [];
}

function renderOutfitPickerItems(suggestionType) {
  var container = document.getElementById('outfit-picker-items');
  if (!container) return;
  
  if (ITEMS.length === 0) {
    container.innerHTML = '<div style="grid-column:1/4;text-align:center;padding:30px;color:var(--ink4);font-size:12px">Add items to your closet first</div>';
    return;
  }
  
  // Sort items: suggested categories first based on dress code
  var sortedItems = ITEMS.slice().sort(function(a, b) {
    var aScore = 0, bScore = 0;
    var aName = (a.name || '').toLowerCase();
    var bName = (b.name || '').toLowerCase();
    
    if (suggestionType === 'casual') {
      // Prioritize casual items
      if (aName.match(/casual|jeans|sneaker|t-shirt|tee|hoodie|sweater|shorts/)) aScore += 3;
      if (bName.match(/casual|jeans|sneaker|t-shirt|tee|hoodie|sweater|shorts/)) bScore += 3;
      if (a.cat === 'Tops' || a.cat === 'Bottoms') aScore += 1;
      if (b.cat === 'Tops' || b.cat === 'Bottoms') bScore += 1;
    } else if (suggestionType === 'smart' || suggestionType === 'smart-casual') {
      // Smart casual - mix of casual and dressy
      if (aName.match(/chino|polo|loafer|blazer|oxford|button/)) aScore += 3;
      if (bName.match(/chino|polo|loafer|blazer|oxford|button/)) bScore += 3;
      if (a.cat === 'Tops') aScore += 1;
      if (b.cat === 'Tops') bScore += 1;
    } else if (suggestionType === 'business-casual') {
      // Business casual - dress shirt, slacks, no tie required
      if (aName.match(/dress|shirt|slacks|chino|loafer|oxford|blazer/)) aScore += 3;
      if (bName.match(/dress|shirt|slacks|chino|loafer|oxford|blazer/)) bScore += 3;
      if (a.cat === 'Suiting') aScore += 2;
      if (b.cat === 'Suiting') bScore += 2;
    } else if (suggestionType === 'business') {
      // Business professional - suits required
      if (a.cat === 'Suiting') aScore += 4;
      if (b.cat === 'Suiting') bScore += 4;
      if (aName.match(/suit|blazer|dress|tie|oxford|loafer|derby/)) aScore += 3;
      if (bName.match(/suit|blazer|dress|tie|oxford|loafer|derby/)) bScore += 3;
    }
    
    return bScore - aScore;
  });
  
  container.innerHTML = sortedItems.map(function(item, idx) {
    var selected = pickerSelectedItems.indexOf(item.id) > -1;
    var isSuggested = idx < 6; // First 6 items are "suggested"
    var content = item.img 
      ? '<img src="' + item.img + '" alt="' + item.name + '" onerror="this.parentElement.innerHTML=\'<div class=outfit-picker-item-placeholder>' + item.name.substring(0,12) + '</div>\'">'
      : '<div class="outfit-picker-item-placeholder">' + item.name + '</div>';
    
    var style = isSuggested && !selected ? 'box-shadow: 0 0 0 2px var(--s3);' : '';
    return '<div class="outfit-picker-item' + (selected ? ' selected' : '') + '" style="' + style + '" onclick="togglePickerItem(' + item.id + ')">' + content + '</div>';
  }).join('');
}

function renderOutfitPickerSaved() {
  var container = document.getElementById('outfit-picker-saved');
  var section = document.getElementById('saved-outfits-section');
  if (!container || !section) return;
  
  if (SAVED_OUTFITS.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  container.innerHTML = SAVED_OUTFITS.map(function(outfit) {
    return '<div style="padding:12px;background:var(--s2);border-radius:10px;margin-bottom:8px;cursor:pointer" onclick="selectSavedOutfit(' + JSON.stringify(outfit.items).replace(/"/g, '&quot;') + ')">' +
      '<div style="font-weight:600;font-size:13px">' + (outfit.name || 'Saved Outfit') + '</div>' +
      '<div style="font-size:11px;color:var(--ink3)">' + outfit.items.length + ' items</div>' +
    '</div>';
  }).join('');
}

function togglePickerItem(itemId) {
  var idx = pickerSelectedItems.indexOf(itemId);
  if (idx > -1) {
    pickerSelectedItems.splice(idx, 1);
  } else {
    pickerSelectedItems.push(itemId);
  }
  var suggestion = currentPickerDay ? getDaySuggestion(currentPickerDay) : { type: 'casual' };
  renderOutfitPickerItems(suggestion.type);
}

function selectSavedOutfit(items) {
  pickerSelectedItems = items.slice();
  renderOutfitPickerItems();
}

function saveDayOutfit() {
  if (!currentPickerDay) return;
  
  if (pickerSelectedItems.length === 0) {
    showToast('Select at least one item');
    return;
  }
  
  // Track wear count for today's outfit
  var isToday = currentPickerDay === getTodayKey();
  if (isToday) {
    incrementWearCount(pickerSelectedItems);
  }
  
  weekPlan[currentPickerDay] = {
    items: pickerSelectedItems,
    name: pickerSelectedItems.length + ' items'
  };
  saveWeekPlan();
  
  closeOutfitPicker();
  renderWeekView();
  renderTodayOutfit();
  showToast('Outfit saved ✓');
}

// Increment wear count for items
function incrementWearCount(itemIds) {
  var changed = false;
  itemIds.forEach(function(id) {
    var item = ITEMS.find(function(i) { return i.id === id; });
    if (item) {
      item.wears = (item.wears || 0) + 1;
      changed = true;
    }
  });
  if (changed) {
    saveCloset();
  }
}

function clearDayOutfit() {
  if (!currentPickerDay) return;
  
  delete weekPlan[currentPickerDay];
  saveWeekPlan();
  
  closeOutfitPicker();
  renderWeekView();
  renderTodayOutfit();
  renderPlanner();
  showToast('Outfit cleared');
}

// Month calendar state
var plannerMonth = new Date().getMonth();
var plannerYear = new Date().getFullYear();

function changeMonth(delta) {
  plannerMonth += delta;
  if (plannerMonth > 11) {
    plannerMonth = 0;
    plannerYear++;
  } else if (plannerMonth < 0) {
    plannerMonth = 11;
    plannerYear--;
  }
  renderPlanner();
}

function renderPlanner() {
  var container = document.getElementById('calendar-grid');
  var titleEl = document.getElementById('planner-month-title');
  if (!container) return;
  
  var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  
  if (titleEl) {
    titleEl.textContent = monthNames[plannerMonth] + ' ' + plannerYear;
  }
  
  // Get first day of month and number of days
  var firstDay = new Date(plannerYear, plannerMonth, 1);
  var lastDay = new Date(plannerYear, plannerMonth + 1, 0);
  var daysInMonth = lastDay.getDate();
  var startDayOfWeek = firstDay.getDay(); // 0 = Sunday
  
  var today = new Date();
  var todayStr = today.toISOString().split('T')[0];
  
  // Build calendar grid HTML (keep headers, add days)
  var html = '<div class="calendar-header">Sun</div>' +
             '<div class="calendar-header">Mon</div>' +
             '<div class="calendar-header">Tue</div>' +
             '<div class="calendar-header">Wed</div>' +
             '<div class="calendar-header">Thu</div>' +
             '<div class="calendar-header">Fri</div>' +
             '<div class="calendar-header">Sat</div>';
  
  // Previous month days
  var prevMonth = new Date(plannerYear, plannerMonth, 0);
  var prevMonthDays = prevMonth.getDate();
  for (var i = startDayOfWeek - 1; i >= 0; i--) {
    var dayNum = prevMonthDays - i;
    var dateKey = formatDateKey(plannerYear, plannerMonth - 1, dayNum);
    html += renderCalendarDay(dayNum, dateKey, false, todayStr);
  }
  
  // Current month days
  for (var d = 1; d <= daysInMonth; d++) {
    var dateKey = formatDateKey(plannerYear, plannerMonth, d);
    html += renderCalendarDay(d, dateKey, true, todayStr);
  }
  
  // Next month days to fill grid
  var totalCells = startDayOfWeek + daysInMonth;
  var remaining = (7 - (totalCells % 7)) % 7;
  for (var n = 1; n <= remaining; n++) {
    var dateKey = formatDateKey(plannerYear, plannerMonth + 1, n);
    html += renderCalendarDay(n, dateKey, false, todayStr);
  }
  
  container.innerHTML = html;
}

function formatDateKey(year, month, day) {
  // Handle month overflow
  var d = new Date(year, month, day);
  return d.toISOString().split('T')[0];
}

function getDaySuggestion(dateKey) {
  var d = new Date(dateKey);
  var dayOfWeek = d.getDay(); // 0 = Sunday, 6 = Saturday
  
  // Get user's work schedule preferences
  var ws = (userProfile && userProfile.workSchedule) || {};
  var casualDays = ws.casualDays || [0, 6]; // Default: Sun, Sat
  var dressCode = ws.dressCode || 'smart-casual';
  
  // Check if this is a casual day for the user
  if (casualDays.indexOf(dayOfWeek) > -1) {
    return { type: 'casual', label: 'Casual' };
  }
  
  // Otherwise, suggest based on their dress code
  switch (dressCode) {
    case 'casual':
      return { type: 'casual', label: 'Casual' };
    case 'smart-casual':
      return { type: 'smart', label: 'Smart Casual' };
    case 'business-casual':
      return { type: 'business-casual', label: 'Biz Casual' };
    case 'business':
      return { type: 'business', label: 'Business' };
    case 'none':
      return { type: 'casual', label: 'Casual' };
    default:
      return { type: 'smart', label: 'Smart Casual' };
  }
}

function renderCalendarDay(dayNum, dateKey, isCurrentMonth, todayStr) {
  var planned = weekPlan[dateKey];
  var hasOutfit = planned && planned.items && planned.items.length > 0;
  var isToday = dateKey === todayStr;
  var suggestion = getDaySuggestion(dateKey);
  
  var classes = 'calendar-day';
  if (!isCurrentMonth) classes += ' other-month';
  if (isToday) classes += ' today';
  if (hasOutfit) classes += ' has-outfit';
  
  var content = '<div class="cal-num">' + dayNum + '</div>';
  
  if (hasOutfit) {
    // Show first item thumbnail if available
    var firstItemId = planned.items[0];
    var firstItem = ITEMS.find(function(item) { return item.id === firstItemId; });
    if (firstItem && firstItem.img) {
      content += '<div class="cal-thumb"><img src="' + firstItem.img + '" onerror="this.parentElement.innerHTML=\'✓\'"></div>';
    } else {
      content += '<div class="cal-dot"></div>';
    }
  } else if (isCurrentMonth) {
    // Show suggestion for empty days
    content += '<div class="cal-suggestion">' + suggestion.label + '</div>';
  }
  
  return '<div class="' + classes + '" onclick="openOutfitPicker(\'' + dateKey + '\')" data-suggestion="' + suggestion.type + '">' + content + '</div>';
}

// Update saveDayOutfit to also refresh planner
var _origSaveDayOutfit = saveDayOutfit;
saveDayOutfit = function() {
  if (!currentPickerDay) return;
  
  if (pickerSelectedItems.length === 0) {
    showToast('Select at least one item');
    return;
  }
  
  weekPlan[currentPickerDay] = {
    items: pickerSelectedItems,
    name: pickerSelectedItems.length + ' items'
  };
  saveWeekPlan();
  
  closeOutfitPicker();
  renderWeekView();
  renderTodayOutfit();
  renderPlanner();
  showToast('Outfit saved ✓');
};

// ────────────────────────────────────────
// OUTFIT BUILDER
// ────────────────────────────────────────
var canvasItems = [];
var builderFilter_active = 'all';
var OUTFITS_KEY = 'vestiary_outfits_v1';
var SAVED_OUTFITS = (function(){ try { return JSON.parse(localStorage.getItem(OUTFITS_KEY)||'[]'); } catch(e){ return []; } })();

function initBuilder() {
  var empty = document.getElementById('builder-empty');
  var active = document.getElementById('builder-active');
  if (ITEMS.length === 0) {
    if (empty) empty.style.display = 'block';
    if (active) active.style.display = 'none';
  } else {
    if (empty) empty.style.display = 'none';
    if (active) active.style.display = 'block';
    renderBuilder('all');
  }
  renderCanvas();
}

function builderFilter(el, cat) {
  builderFilter_active = cat;
  el.closest('.filter-row').querySelectorAll('.chip').forEach(function(c){ c.classList.remove('active'); });
  el.classList.add('active');
  renderBuilder(cat);
}

function renderBuilder(cat) {
  var grid = document.getElementById('builder-grid');
  if (!grid) return;
  var catIco = {Tops:'👔',Bottoms:'👖',Outerwear:'🧥',Footwear:'👟',Accessories:'🧣',Other:'👕'};
  var items = cat === 'all' ? ITEMS : ITEMS.filter(function(i){ return i.cat === cat; });
  grid.innerHTML = items.map(function(item){
    var ico = catIco[item.cat] || '👕';
    var imgTag = imgHtml(item.img);
    var sel = canvasItems.find(function(ci){ return ci.id === item.id; }) ? ' selected' : '';
    return '<div class="c-card builder-item'+sel+'" onclick="toggleCanvas('+item.id+')">'
      + '<div class="c-img">'+imgTag+ico+'</div>'
      + '<div class="c-body"><div class="c-name">'+item.name+'</div>'
      + '<div class="c-meta"><span>'+item.cat+'</span></div></div>'
      + '</div>';
  }).join('');
}

function toggleCanvas(id) {
  var item = ITEMS.find(function(i){ return i.id === id; });
  if (!item) return;
  var idx = canvasItems.findIndex(function(ci){ return ci.id === id; });
  if (idx === -1) { canvasItems.push(item); }
  else { canvasItems.splice(idx, 1); }
  renderCanvas();
  renderBuilder(builderFilter_active || 'all');
}

function renderCanvas() {
  var canvas = document.getElementById('outfit-canvas');
  var empty = document.getElementById('canvas-empty');
  var saveBtn = document.getElementById('save-outfit-btn');
  if (!canvas) return;
  var catIco = {Tops:'👔',Bottoms:'👖',Outerwear:'🧥',Footwear:'👟',Accessories:'🧣',Other:'👕'};
  if (canvasItems.length === 0) {
    canvas.innerHTML = '';
    if (empty) empty.style.display = 'block';
    if (saveBtn) saveBtn.style.display = 'none';
    return;
  }
  if (empty) empty.style.display = 'none';
  if (saveBtn) saveBtn.style.display = 'inline-flex';
  canvas.innerHTML = canvasItems.map(function(item){
    var ico = catIco[item.cat] || '👕';
    var imgTag = imgHtml(item.img);
    return '<div class="canvas-item">'
      + '<div class="canvas-item-img">'+imgTag+ico+'</div>'
      + '<button class="canvas-remove" onclick="toggleCanvas('+item.id+')">×</button>'
      + '<div class="canvas-item-name">'+item.name+'</div>'
      + '</div>';
  }).join('');
}

function saveBuiltOutfit() {
  if (canvasItems.length < 2) { showToast('Add at least 2 items'); return; }
  var name = 'My Outfit ' + (SAVED_OUTFITS.length + 1);
  SAVED_OUTFITS.push({ id: Date.now(), name: name, items: canvasItems.map(function(i){return i.id;}) });
  try { localStorage.setItem(OUTFITS_KEY, JSON.stringify(SAVED_OUTFITS)); } catch(e) {}
  canvasItems = [];
  renderCanvas();
  renderBuilder(builderFilter_active || 'all');
  updateHomeStats();
  showToast('"' + name + '" saved ✓');
}

// ────────────────────────────────────────
// STYLE COACH
// ────────────────────────────────────────
var PREMIUM_KEY = 'vestiary_premium_v1';
var isPremium = (function(){ try { return localStorage.getItem(PREMIUM_KEY) === 'true'; } catch(e){ return false; } })();

var COACH_RESPONSES = {
  'what should i wear today': function() {
    if (ITEMS.length === 0) return "Your closet is empty right now — add some items and I can start dressing you!";
    var top = ITEMS.filter(function(i){return i.cat==='Tops';})[0];
    var bot = ITEMS.filter(function(i){return i.cat==='Bottoms';})[0];
    var shoe = ITEMS.filter(function(i){return i.cat==='Footwear';})[0];
    var parts = [top,bot,shoe].filter(Boolean).map(function(i){return i.name;});
    return parts.length ? "Based on today's forecast (41°, overcast), I'd suggest: " + parts.join(' + ') + ". Layer up — it'll feel colder than it looks." : "Add more items to your closet and I can build you a daily look!";
  },
  'review my closet': function() {
    if (ITEMS.length === 0) return "Your closet is empty! Start uploading items and I'll analyze your wardrobe for gaps, versatility, and cost-per-wear.";
    var cats = {};
    ITEMS.forEach(function(i){ cats[i.cat] = (cats[i.cat]||0)+1; });
    var summary = Object.keys(cats).map(function(k){return k+': '+cats[k];}).join(', ');
    return "You have " + ITEMS.length + " items: " + summary + ". " + (cats['Footwear']<2 ? "You're light on footwear — more shoe options would expand your outfits significantly." : "Good range across categories. Let's look at cost-per-wear next.");
  },
  'help me shop for gaps': function() {
    return "Based on your profile and closet, the highest-impact additions would be: (1) a quality blazer that works casual to formal, (2) a second pair of shoes — loafers or clean white sneakers, (3) a versatile mid-layer like a merino crewneck or overshirt. Want me to pull specific recommendations for any of these?";
  },
  'outfit for a date': function() {
    return "For a date night, I always say: one elevated piece, the rest clean and simple. If you have dark jeans, wear them. Add your best shoes — even simple derbies over sneakers makes a huge difference. Top it with a fitted button-down or a textured knit. Confident and intentional always reads better than trying too hard.";
  },
};

function initCoach() {
  if (isPremium) {
    document.getElementById('coach-upsell').style.display = 'none';
    document.getElementById('coach-chat').style.display = 'flex';
  }
}

function subscribePremium(plan) {
  // In production: connect to Stripe / RevenueCat / App Store IAP
  isPremium = true;
  try { localStorage.setItem(PREMIUM_KEY, 'true'); } catch(e) {}
  document.getElementById('coach-upsell').style.display = 'none';
  document.getElementById('coach-chat').style.display = 'flex';
  showToast('✦ Welcome to Vestiary Premium!');
  var price = plan === 'yearly' ? '$99.99/yr' : '$14.99/mo';
  setTimeout(function(){
    addCoachMsg("Welcome! You're now on Vestiary Premium (" + price + "). I'm Alex — I can see all " + ITEMS.length + " items in your closet, your full measurements, and your style profile. What would you like help with first?", 'coach');
  }, 600);
}

function sendQuick(btn) {
  btn.style.display = 'none';
  sendCoachMsgText(btn.textContent);
}

function sendCoachMsg() {
  var input = document.getElementById('chat-input');
  if (!input || !input.value.trim()) return;
  sendCoachMsgText(input.value.trim());
  input.value = '';
  input.style.height = 'auto';
}

// Coach conversation history (kept in memory per session)
var coachHistory = [];

function sendCoachMsgText(text) {
  addCoachMsg(text, 'user');
  coachHistory.push({ role: 'user', content: text });

  // Show typing indicator
  var msgs = document.getElementById('chat-messages');
  var typing = document.createElement('div');
  typing.className = 'chat-typing';
  typing.innerHTML = '<div class="chat-dot"></div><div class="chat-dot"></div><div class="chat-dot"></div>';
  typing.id = 'typing-indicator';
  msgs.appendChild(typing);
  msgs.scrollTop = msgs.scrollHeight;

  // Build context from user's actual data
  var cats = {};
  ITEMS.forEach(function(i){ cats[i.cat] = (cats[i.cat]||0)+1; });
  var closetSummary = ITEMS.length === 0
    ? 'The user has an empty closet so far.'
    : 'Closet has ' + ITEMS.length + ' items: ' + Object.keys(cats).map(function(k){ return cats[k] + ' ' + k; }).join(', ') + '.';
  var topItems = ITEMS.slice().sort(function(a,b){ return (b.wears||0)-(a.wears||0); }).slice(0,5).map(function(i){ return i.name; }).join(', ');

  // Build detailed wardrobe list for outfit suggestions
  var wardrobeDetails = ITEMS.map(function(item) {
    return item.name + ' (' + item.cat + ', ' + (item.color || 'unknown color') + ')';
  }).join('; ');

  // Get current weather for context
  var weatherContext = '';
  if (window.currentWeather) {
    weatherContext = 'Current weather: ' + window.currentWeather.temp + '°F, ' + window.currentWeather.description + '.';
  }

  var systemContext = [
    closetSummary,
    'FULL WARDROBE: ' + (wardrobeDetails || 'No items yet'),
    topItems ? 'Most worn items: ' + topItems + '.' : '',
    'Style profile: ' + styleLabel() + '.',
    weatherContext,
    userProfile.measurements ? 'Has measurements on file.' : '',
    'IMPORTANT: When suggesting outfits, ONLY use items from the FULL WARDROBE list above. Name specific items the user owns. If they ask for outfit ideas, create complete outfits using their actual clothes.'
  ].filter(Boolean).join(' ');

  fetch(VESTIARY_SERVER + '/api/coach', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      messages: coachHistory,
      systemContext: systemContext
    })
  })
  .then(function(r) {
    if (!r.ok) return r.json().then(function(e){ throw new Error(e.error || 'Server error'); });
    return r.json();
  })
  .then(function(data) {
    var t = document.getElementById('typing-indicator');
    if (t) t.remove();
    var reply = data.reply || "Sorry, I didn't catch that. Try again?";
    coachHistory.push({ role: 'assistant', content: reply });
    addCoachMsg(reply, 'coach');
  })
  .catch(function(err) {
    var t = document.getElementById('typing-indicator');
    if (t) t.remove();
    var msg = err.message || 'Connection error';
    if (msg.indexOf('Failed to fetch') > -1) {
      msg = 'Cannot reach the server. Make sure server.js is running.';
    }
    addCoachMsg('⚠️ ' + msg, 'coach');
  });
}

function addCoachMsg(text, role) {
  var msgs = document.getElementById('chat-messages');
  if (!msgs) return;
  var div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

// ────────────────────────────────────────
// LOCATION
// ────────────────────────────────────────
var LOC_KEY = 'vestiary_location_v1';
var userLocation = (function(){ try { return JSON.parse(localStorage.getItem(LOC_KEY)||'null'); } catch(e){ return null; } })();

function requestLocationPermission() {
  if (userLocation) return; // already have it
  document.getElementById('location-sheet').classList.add('open');
}

function grantLocation() {
  document.getElementById('location-sheet').classList.remove('open');
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, granted: true };
        try { localStorage.setItem(LOC_KEY, JSON.stringify(userLocation)); } catch(e) {}
        // Reverse geocode via free API
        fetch('https://nominatim.openstreetmap.org/reverse?lat='+pos.coords.latitude+'&lon='+pos.coords.longitude+'&format=json')
          .then(function(r){ return r.json(); })
          .then(function(d){
            var city = (d.address && (d.address.city || d.address.town || d.address.county)) || 'Your City';
            var state = (d.address && d.address.state) || '';
            userLocation.city = city + (state ? ', ' + state.substring(0,2) : '');
            try { localStorage.setItem(LOC_KEY, JSON.stringify(userLocation)); } catch(e) {}
            updateWeatherDisplay();
          }).catch(function(){ updateWeatherDisplay(); });
      },
      function(err) {
        // Silently fall back to city from profile - no toast needed
        userLocation = { granted: false, city: userProfile.city || 'New York, NY' };
        try { localStorage.setItem(LOC_KEY, JSON.stringify(userLocation)); } catch(e) {}
        updateWeatherDisplay();
      }
    );
  } else {
    skipLocation();
  }
}

function skipLocation() {
  document.getElementById('location-sheet').classList.remove('open');
  userLocation = { granted: false, city: userProfile.city || 'Enter city in Profile' };
  try { localStorage.setItem(LOC_KEY, JSON.stringify(userLocation)); } catch(e) {}
  updateWeatherDisplay();
}

function updateWeatherDisplay() {
  if (userLocation && userLocation.city) {
    var lbl = document.querySelector('.w-lbl');
    if (lbl) lbl.textContent = userLocation.city;
  }
  // Fetch real weather if we have coordinates
  if (userLocation && userLocation.lat && userLocation.lng) {
    fetchRealWeather(userLocation.lat, userLocation.lng);
  }
}

function fetchRealWeather(lat, lng) {
  var url = 'https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lng + 
    '&current=temperature_2m,apparent_temperature,weather_code' +
    '&daily=weather_code,temperature_2m_max,temperature_2m_min' +
    '&temperature_unit=fahrenheit&timezone=auto&forecast_days=4';
  
  fetch(url)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.current) {
        var temp = Math.round(data.current.temperature_2m);
        var feelsLike = Math.round(data.current.apparent_temperature);
        var code = data.current.weather_code;
        var weatherInfo = getWeatherDescription(code);
        
        // Update current weather display
        var tempEl = document.querySelector('.w-temp');
        var condEl = document.querySelector('.w-cond');
        var recEl = document.querySelector('.w-rec');
        
        if (tempEl) tempEl.textContent = temp + '°';
        if (condEl) condEl.textContent = weatherInfo.desc + ' · Feels ' + feelsLike + '°';
        if (recEl) recEl.innerHTML = getWeatherRec(temp, code);
        
        // Store for outfit suggestions
        window.currentWeather = {
          temp: temp,
          feelsLike: feelsLike,
          description: weatherInfo.desc,
          code: code
        };
      }
      
      // Update 3-day forecast
      if (data.daily) {
        var daysContainer = document.querySelector('.w-days');
        if (daysContainer) {
          var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          var html = '';
          
          // Start from tomorrow (index 1) for 3 days
          for (var i = 1; i <= 3 && i < data.daily.time.length; i++) {
            var date = new Date(data.daily.time[i]);
            var dayName = dayNames[date.getDay()];
            var hi = Math.round(data.daily.temperature_2m_max[i]);
            var lo = Math.round(data.daily.temperature_2m_min[i]);
            var dayCode = data.daily.weather_code[i];
            var dayIcon = getWeatherDescription(dayCode).icon;
            
            html += '<div class="w-day">' +
              '<div class="w-day-name">' + dayName + '</div>' +
              '<div class="w-day-ico">' + dayIcon + '</div>' +
              '<div class="w-day-temps"><span class="w-hi">' + hi + '°</span><span class="w-lo">' + lo + '°</span></div>' +
            '</div>';
          }
          daysContainer.innerHTML = html;
        }
      }
    })
    .catch(function(err) {
      console.log('Weather fetch error:', err);
    });
}

function getWeatherRec(temp, code) {
  // Outfit recommendation based on weather
  if (code >= 95) return '☔ Grab an umbrella — storms coming';
  if (code >= 61 && code <= 82) return '🌧️ Rain jacket weather';
  if (code >= 71 && code <= 75) return '❄️ Bundle up — snow day';
  if (temp < 32) return '🧣 Freezing — heavy layers needed';
  if (temp < 45) return '🧥 Layer up — coat weather';
  if (temp < 60) return '🧥 Jacket weather — light layers';
  if (temp < 75) return '👕 Perfect — light layers optional';
  if (temp < 85) return '☀️ Warm — keep it light';
  return '🔥 Hot — stay cool, minimal layers';
}

function getWeatherDescription(code) {
  var weatherMap = {
    0: { desc: 'Clear', icon: '☀️' },
    1: { desc: 'Mostly Clear', icon: '🌤' },
    2: { desc: 'Partly Cloudy', icon: '⛅' },
    3: { desc: 'Overcast', icon: '☁️' },
    45: { desc: 'Foggy', icon: '🌫' },
    48: { desc: 'Foggy', icon: '🌫' },
    51: { desc: 'Light Drizzle', icon: '🌦' },
    53: { desc: 'Drizzle', icon: '🌦' },
    55: { desc: 'Heavy Drizzle', icon: '🌧' },
    61: { desc: 'Light Rain', icon: '🌦' },
    63: { desc: 'Rain', icon: '🌧' },
    65: { desc: 'Heavy Rain', icon: '🌧' },
    71: { desc: 'Light Snow', icon: '🌨' },
    73: { desc: 'Snow', icon: '❄️' },
    75: { desc: 'Heavy Snow', icon: '❄️' },
    80: { desc: 'Rain Showers', icon: '🌧' },
    81: { desc: 'Rain Showers', icon: '🌧' },
    82: { desc: 'Heavy Showers', icon: '⛈' },
    95: { desc: 'Thunderstorm', icon: '⛈' },
    96: { desc: 'Thunderstorm', icon: '⛈' },
    99: { desc: 'Severe Storm', icon: '⛈' }
  };
  return weatherMap[code] || { desc: 'Clear', icon: '☀️' };
}

// ────────────────────────────────────────
// DEV DASHBOARD DATA TOOLS
// ────────────────────────────────────────
function exportUserData() {
  var data = {
    exportDate: new Date().toISOString(),
    userProfile: userProfile,
    location: userLocation,
    closet: ITEMS,
    savedOutfits: SAVED_OUTFITS,
    selectedMoods: selectedMoods,
    isPremium: isPremium,
    appVersion: 'Vestiary 1.0 Demo'
  };
  var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'vestiary-data.json'; a.click();
  URL.revokeObjectURL(url);
  showToast('Data exported ✓');
}

function clearAllData() {
  if (!confirm('Clear ALL local data? This cannot be undone. You will need to complete onboarding again.')) return;
  try {
    localStorage.removeItem('vestiary_closet_v1');
    localStorage.removeItem('vestiary_outfits_v1');
    localStorage.removeItem('vestiary_premium_v1');
    localStorage.removeItem('vestiary_location_v1');
    localStorage.removeItem('vestiary_profile_v1');
  } catch(e) {}
  ITEMS.length = 0;
  SAVED_OUTFITS.length = 0;
  isPremium = false;
  updateHomeStats();
  renderCloset();
  showToast('All data cleared - reloading...');
  setTimeout(function() { location.reload(); }, 1000);
}

// ────────────────────────────────────────
// UPLOAD MODAL — actually add item
// ────────────────────────────────────────
var pendingUpload = { name:'', cat:'Tops', img:'' };

function openAddItem() {
  var modal = document.getElementById('add-item-modal');
  if (modal) { modal.classList.add('open'); return; }
  openUpload(); // fallback
}

// ────────────────────────────────────────
// HOOK: run after finishOnboarding
// ────────────────────────────────────────
var _origFinish = finishOnboarding;
finishOnboarding = function() {
  _origFinish();
  // Ask for location ~1s after app loads
  setTimeout(requestLocationPermission, 1200);
  showIosBanner();
  // Init new pages
  initBuilder();
  initCoach();
  initIcons();
  updateHomeStats();
  renderCloset();
};

// Also init if app already showing (for hot reload / testing)
if (document.getElementById('app') && document.getElementById('app').style.display !== 'none') {
  setTimeout(function(){
    initBuilder();
    initCoach();
    initIcons();
    updateHomeStats();
    renderCloset();
  }, 100);
}

// AUTO-LOGIN: Check auth then skip onboarding if needed
(function checkAutoLogin() {
  // Check if user is authenticated
  checkAuthOnLoad();
  
  if (hasCompletedOnboarding && userProfile && userProfile.name) {
    // User has completed onboarding before - skip to app
    document.getElementById('auth-screen').classList.add('hidden');
    setTimeout(function() {
      document.getElementById('onboarding').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      applyUserProfile();
      initBuilder();
      initCoach();
      initIcons();
      updateHomeStats();
      renderCloset();
      initStats();
      initPacking();
      initGaps();
      renderBrands();
      updateWeatherDisplay();
      renderPlanner();
      renderWeekView();
      renderTodayOutfit();
    }, 100);
  }
})();


// ── UPLOAD STATE MANAGEMENT ──
var currentUploadBase64 = null;
var currentUploadMime = 'image/jpeg';

function uploadState(name) {
  ['drop','analysing','confirm','error'].forEach(function(s) {
    var el = document.getElementById('upload-state-' + s);
    if (el) el.style.display = (s === name) ? 'block' : 'none';
  });
}

function resetUploadModal() {
  currentUploadBase64 = null;
  // Reset file input so same file can be re-selected
  var fi = document.getElementById('upload-file-input');
  if (fi) fi.value = '';
  uploadState('drop');
}

function showManualEntry() {
  // Show confirm state with blank fields for manual entry
  var nameEl = document.getElementById('add-name');
  var catEl  = document.getElementById('add-cat');
  if (nameEl) nameEl.value = '';
  if (catEl)  catEl.value  = 'Tops';
  var detailsEl = document.getElementById('ai-result-details');
  if (detailsEl) detailsEl.textContent = 'Fill in the details below.';
  var aiName = document.getElementById('ai-result-name');
  if (aiName) aiName.textContent = 'New Item';
  // Show preview as placeholder
  var prev = document.getElementById('confirm-preview-img');
  if (prev && currentUploadBase64) {
    prev.src = 'data:' + currentUploadMime + ';base64,' + currentUploadBase64;
  } else if (prev) {
    prev.src = '';
  }
  uploadState('confirm');
}

function handleFileSelected(input) {
  var file = input.files && input.files[0];
  if (!file) return;

  // iOS HEIC files sometimes report as empty type — treat as jpeg
  var mime = file.type || 'image/jpeg';
  // HEIC/HEIF aren't supported as-is by Canvas, but iOS converts on read
  if (mime === 'image/heic' || mime === 'image/heif') mime = 'image/jpeg';
  // Only accept images
  if (!mime.startsWith('image/')) {
    showToast('Please select an image file');
    return;
  }
  currentUploadMime = 'image/jpeg'; // always normalise to jpeg after canvas resize

  var reader = new FileReader();
  reader.onerror = function() {
    showToast('Could not read file — try a different photo');
  };
  reader.onload = function(e) {
    var dataUrl = e.target.result;

    // Resize using Canvas — keeps file small, saves API cost, avoids timeouts
    // iPhone 14 Pro shoots 48MP (12MB+); we only need ~800px for identification
    var img = new Image();
    img.onerror = function() {
      // Canvas failed (can happen with HEIC on some iOS) — try raw
      var base64 = dataUrl.split(',')[1];
      currentUploadBase64 = base64;
      var prevImg = document.getElementById('upload-preview-img');
      if (prevImg) prevImg.src = dataUrl;
      uploadState('analysing');
      analyseWithAI(base64, currentUploadMime);
    };
    img.onload = function() {
      var MAX = 1024;
      var w = img.width, h = img.height;
      if (w > MAX || h > MAX) {
        if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
        else       { w = Math.round(w * MAX / h); h = MAX; }
      }
      var canvas = document.createElement('canvas');
      canvas.width  = w;
      canvas.height = h;
      var ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      var resized = canvas.toDataURL('image/jpeg', 0.85);
      var base64  = resized.split(',')[1];
      currentUploadBase64 = base64;

      // Show preview
      var prevImg = document.getElementById('upload-preview-img');
      if (prevImg) prevImg.src = resized;

      uploadState('analysing');
      analyseWithAI(base64, currentUploadMime);
    };
    img.src = dataUrl;
  };
  reader.readAsDataURL(file);

  // Reset input so same photo can be reselected if needed
  input.value = '';
}

// ── SERVER CONFIG ──
// To change the server URL without editing this file, open browser console and run:
//   localStorage.setItem('vestiary_server', 'https://your-server.railway.app')
// Then refresh the page.
var VESTIARY_SERVER = (function() {
  // 1. Check if overridden in localStorage (easiest for testing)
  try {
    var stored = localStorage.getItem('vestiary_server');
    if (stored) return stored.replace(/\/$/, ''); // strip trailing slash
  } catch(e) {}

  // 2. If running on localhost, use local server
  var host = window.location.hostname;
  if (host === 'localhost' || host === '127.0.0.1') {
    return 'http://localhost:3001';
  }

  // 3. PRODUCTION: your Railway backend
  return 'https://backend-production-e0c52.up.railway.app';
})();

// ══════════════════════════════════════════════════
// AUTH SYSTEM
// ══════════════════════════════════════════════════
var AUTH_TOKEN_KEY = 'vestiary_auth_token';
var AUTH_USER_KEY = 'vestiary_auth_user';

function getAuthToken() {
  try { return localStorage.getItem(AUTH_TOKEN_KEY); } catch(e) { return null; }
}

function getAuthUser() {
  try { 
    var u = localStorage.getItem(AUTH_USER_KEY);
    return u ? JSON.parse(u) : null;
  } catch(e) { return null; }
}

function setAuth(token, user) {
  try {
    localStorage.setItem(AUTH_TOKEN_KEY, token);
    localStorage.setItem(AUTH_USER_KEY, JSON.stringify(user));
  } catch(e) {}
}

function clearAuth() {
  try {
    localStorage.removeItem(AUTH_TOKEN_KEY);
    localStorage.removeItem(AUTH_USER_KEY);
  } catch(e) {}
}

function isLoggedIn() {
  return !!getAuthToken();
}

function showAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.auth-form').forEach(function(f) { f.classList.remove('active'); });
  
  if (tab === 'login') {
    document.querySelector('.auth-tab:first-child').classList.add('active');
    document.getElementById('login-form').classList.add('active');
  } else {
    document.querySelector('.auth-tab:last-child').classList.add('active');
    document.getElementById('signup-form').classList.add('active');
  }
  hideAuthError();
}

function showAuthError(msg) {
  var el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.add('show');
}

function hideAuthError() {
  document.getElementById('auth-error').classList.remove('show');
}

function doLogin() {
  var email = document.getElementById('login-email').value.trim();
  var password = document.getElementById('login-password').value;
  
  if (!email || !password) {
    showAuthError('Please enter email and password');
    return;
  }
  
  hideAuthError();
  
  fetch(VESTIARY_SERVER + '/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: email, password: password })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.error) {
      showAuthError(data.error);
      return;
    }
    setAuth(data.token, data.user);
    onAuthSuccess(data.user, false);
  })
  .catch(function(err) {
    showAuthError('Connection error. Please try again.');
  });
}

function doSignup() {
  var email = document.getElementById('signup-email').value.trim();
  var password = document.getElementById('signup-password').value;
  
  if (!email || !password) {
    showAuthError('Please enter email and password');
    return;
  }
  
  if (password.length < 6) {
    showAuthError('Password must be at least 6 characters');
    return;
  }
  
  hideAuthError();
  
  fetch(VESTIARY_SERVER + '/api/auth/signup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: email, password: password })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.error) {
      showAuthError(data.error);
      return;
    }
    setAuth(data.token, data.user);
    onAuthSuccess(data.user, true);
  })
  .catch(function(err) {
    showAuthError('Connection error. Please try again.');
  });
}

function skipAuth() {
  document.getElementById('auth-screen').classList.add('hidden');
  // Continue with local-only mode
}

function onAuthSuccess(user, isNewUser) {
  document.getElementById('auth-screen').classList.add('hidden');
  
  if (isNewUser) {
    // New user - show onboarding
    document.getElementById('onboarding').style.display = 'flex';
  } else {
    // Existing user - load their data and skip to app
    loadUserDataFromServer();
    skipOnboarding();
  }
}

function loadUserDataFromServer() {
  var token = getAuthToken();
  if (!token) return;
  
  // Load closet from server
  fetch(VESTIARY_SERVER + '/api/user/closet', {
    headers: { 'Authorization': 'Bearer ' + token }
  })
  .then(function(r) { return r.json(); })
  .then(function(items) {
    if (Array.isArray(items)) {
      // Convert server format to local format
      ITEMS = items.map(function(item) {
        return {
          id: item.id,
          name: item.name,
          cat: item.category,
          color: item.color,
          img: item.image_url,
          cost: item.cost || 0,
          wears: item.wears || 0
        };
      });
      saveCloset();
      renderCloset();
      initStats();
      initGaps();
    }
  })
  .catch(function(err) {
    console.error('Failed to load closet from server:', err);
  });
  
  // Load profile
  fetch(VESTIARY_SERVER + '/api/user/profile', {
    headers: { 'Authorization': 'Bearer ' + token }
  })
  .then(function(r) { return r.json(); })
  .then(function(profile) {
    if (profile && profile.name) {
      userProfile = {
        name: profile.name,
        city: profile.city,
        measurements: profile.measurements || {},
        moods: profile.style_moods || []
      };
      try { localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile)); } catch(e) {}
      applyUserProfile();
    }
  })
  .catch(function(err) {
    console.error('Failed to load profile from server:', err);
  });
}

function syncItemToServer(item) {
  var token = getAuthToken();
  if (!token) return;
  
  fetch(VESTIARY_SERVER + '/api/user/closet', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token 
    },
    body: JSON.stringify({
      name: item.name,
      category: item.cat,
      color: item.color || '',
      image_url: item.img || '',
      cost: item.cost || 0
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.id) {
      // Update local item with server ID
      var localItem = ITEMS.find(function(i) { return i.name === item.name; });
      if (localItem) {
        localItem.serverId = data.id;
        saveCloset();
      }
    }
  })
  .catch(function(err) {
    console.error('Failed to sync item to server:', err);
  });
}

function deleteItemFromServer(itemId) {
  var token = getAuthToken();
  if (!token || !itemId) return;
  
  fetch(VESTIARY_SERVER + '/api/user/closet/' + itemId, {
    method: 'DELETE',
    headers: { 'Authorization': 'Bearer ' + token }
  }).catch(function(err) {
    console.error('Failed to delete from server:', err);
  });
}

function logout() {
  clearAuth();
  // Clear local data
  try {
    localStorage.removeItem(CLOSET_KEY);
    localStorage.removeItem(PROFILE_KEY);
    localStorage.removeItem(OUTFITS_KEY);
  } catch(e) {}
  window.location.reload();
}

function showLoginScreen() {
  document.getElementById('auth-screen').classList.remove('hidden');
}

function updateAccountUI() {
  var user = getAuthUser();
  var logoutBtn = document.getElementById('logout-btn');
  var loginBtn = document.getElementById('login-btn');
  var accountInfo = document.getElementById('account-info');
  
  if (user && user.email) {
    if (logoutBtn) logoutBtn.style.display = 'block';
    if (loginBtn) loginBtn.style.display = 'none';
    if (accountInfo) accountInfo.textContent = 'Logged in as ' + user.email;
  } else {
    if (logoutBtn) logoutBtn.style.display = 'none';
    if (loginBtn) loginBtn.style.display = 'block';
    if (accountInfo) accountInfo.textContent = 'Not logged in — data saved locally only';
  }
}

// Check auth on page load
function checkAuthOnLoad() {
  var token = getAuthToken();
  var user = getAuthUser();
  
  // Update account UI in profile page
  setTimeout(updateAccountUI, 500);
  
  if (token && user) {
    // Already logged in - hide auth, load data
    document.getElementById('auth-screen').classList.add('hidden');
    loadUserDataFromServer();
    
    // Check if they completed onboarding
    if (userProfile && userProfile.name) {
      skipOnboarding();
    }
  }
  // Otherwise show auth screen (it's visible by default)
}

// SECRET DEV MODE: Tap version number 5 times to unlock
var devTapCount = 0;
var devTapTimer = null;
function secretDevTap() {
  devTapCount++;
  clearTimeout(devTapTimer);
  devTapTimer = setTimeout(function() { devTapCount = 0; }, 2000);
  
  if (devTapCount >= 5) {
    devTapCount = 0;
    var devBtn = document.getElementById('dev-nav-btn');
    if (devBtn) {
      devBtn.style.display = 'flex';
      showToast('🔓 Dev mode unlocked');
    }
  }
}

function analyseWithAI(base64, mimeType) {
  console.log('Sending to server:', VESTIARY_SERVER + '/api/identify');
  console.log('Image size:', Math.round(base64.length / 1024), 'KB');
  
  fetch(VESTIARY_SERVER + '/api/identify', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ image: base64, mimeType: mimeType })
  })
  .then(function(r) {
    console.log('Response status:', r.status);
    if (!r.ok) {
      return r.json().then(function(e) {
        throw new Error(e.error || ('Server error ' + r.status));
      });
    }
    return r.json();
  })
  .then(function(result) {
    console.log('AI result:', result);
    if (result.error) throw new Error(result.error);
    showUploadConfirm(result);
  })
  .catch(function(err) {
    console.error('AI upload error:', err);
    var errEl = document.getElementById('upload-error-msg');
    if (errEl) {
      var msg = err.message || 'Could not identify item.';
      if (msg.indexOf('Failed to fetch') > -1 || msg.indexOf('NetworkError') > -1) {
        msg = 'Cannot reach the server. Check your internet connection.';
      }
      if (msg.indexOf('CORS') > -1) {
        msg = 'Server connection blocked. Try again in a moment.';
      }
      errEl.textContent = msg;
    }
    uploadState('error');
  });
}
function showUploadConfirm(result) {
  // Populate preview
  var prev = document.getElementById('confirm-preview-img');
  if (prev && currentUploadBase64) {
    prev.src = 'data:' + currentUploadMime + ';base64,' + currentUploadBase64;
  }

  // Populate AI result display
  var aiName = document.getElementById('ai-result-name');
  if (aiName) aiName.textContent = result.name || 'Item Identified';

  var details = document.getElementById('ai-result-details');
  if (details) {
    var parts = [];
    if (result.color)  parts.push(result.color);
    if (result.fabric) parts.push(result.fabric);
    if (result.fit)    parts.push(result.fit + ' fit');
    if (result.brand)  parts.push(result.brand);
    
    // Add confidence indicator
    var confIcon = result.confidence === 'high' ? '✓' : (result.confidence === 'low' ? '?' : '');
    var confText = result.confidence ? ' · ' + result.confidence + ' confidence ' + confIcon : '';
    
    details.innerHTML = (parts.length ? parts.join(' · ') : '') +
      '<span style="color:var(--ink4);font-size:10px">' + confText + '</span><br>' +
      '<span style="color:var(--ink3)">' + (result.details || '') + '</span>';
  }

  // Pre-fill editable fields
  var nameEl = document.getElementById('add-name');
  var catEl  = document.getElementById('add-cat');
  if (nameEl) nameEl.value = result.name || '';
  if (catEl && result.cat) {
    var opts = catEl.options;
    for (var i = 0; i < opts.length; i++) {
      if (opts[i].value === result.cat) { catEl.selectedIndex = i; break; }
    }
  }

  uploadState('confirm');
}

function confirmAddItem() {
  var name = (document.getElementById('add-name')||{}).value || '';
  var cat  = (document.getElementById('add-cat')||{}).value  || 'Tops';
  var cost = parseFloat((document.getElementById('add-cost')||{}).value) || 0;
  if (!name.trim()) { showToast('Please enter an item name'); return; }

  // Store the photo as a data URL if we have one
  if (currentUploadBase64) {
    // Try to remove background via server API
    showToast('Removing background...');
    
    fetch(VESTIARY_SERVER + '/api/remove-bg', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: currentUploadBase64, mimeType: currentUploadMime })
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
      var img;
      if (result.processed && result.image) {
        // Use the processed image with transparent background
        img = 'data:' + (result.mimeType || 'image/png') + ';base64,' + result.image;
        showToast('Background removed ✓');
      } else {
        // Use original image
        img = 'data:' + currentUploadMime + ';base64,' + currentUploadBase64;
      }
      
      addItem({ name: name.trim(), cat: cat, cost: cost, img: img, wears: 0 });
      closeUpload();
      resetUploadModal();
      showPage('closet', document.querySelector('.bn-item[onclick*="closet"]'));
      showToast(name + ' added to your closet ✓');
    })
    .catch(function(err) {
      console.error('Remove-bg error:', err);
      // Fall back to original image
      var img = 'data:' + currentUploadMime + ';base64,' + currentUploadBase64;
      addItem({ name: name.trim(), cat: cat, cost: cost, img: img, wears: 0 });
      closeUpload();
      resetUploadModal();
      showPage('closet', document.querySelector('.bn-item[onclick*="closet"]'));
      showToast(name + ' added to your closet ✓');
    });
  } else {
    addItem({ name: name.trim(), cat: cat, cost: cost, img: '', wears: 0 });
    closeUpload();
    resetUploadModal();
    showPage('closet', document.querySelector('.bn-item[onclick*="closet"]'));
    showToast(name + ' added to your closet ✓');
  }
}
// ══════════════════════════════════════════════════
// STYLE ICONS — Celebrity Lookbook Engine
// ══════════════════════════════════════════════════

var ICONS_DATA = [
  {
    id: 'beckham',
    name: 'David Beckham',
    cat: 'athlete',
    catLabel: 'Athlete · Fashion Icon',
    photo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/David_Beckham_2018.jpg/440px-David_Beckham_2018.jpg',
    vibe: 'Sharp tailoring meets relaxed off-duty cool. Beckham is the blueprint for the man who can wear a three-piece suit to a match and a worn-in tee to dinner and look equally intentional.',
    moods: ['business','smart-casual','ald'],
    brands: ['Dior Homme','Hugo Boss','Kent & Curwen','Adidas','Belstaff'],
    signature: ['slim dark suits','plain crew tees','well-fitted chinos','Chelsea boots','classic denim jacket'],
    palette: ['Navy','Charcoal','Tan','White','Black'],
    keyItems: [
      { img:'https://m.media-amazon.com/images/I/71S3FJxpMaL._AC_UY695_.jpg', name:'Chelsea Boot', brand:'Ted Baker / Belstaff', budget:'$120', mid:'$280', invest:'$650', why:'His most-worn shoe. Dark suede or leather, always clean.' },
      { img:'https://m.media-amazon.com/images/I/71utX8gBi8L._AC_UY879_.jpg', name:'Slim Fit Dark Suit', brand:'Dior Homme / Hugo Boss', budget:'$299', mid:'$595', invest:'$1,800', why:'Worn casually with open collar — the off-duty power move.' },
      { img:'https://m.media-amazon.com/images/I/61-jBuGMHzL._AC_UX679_.jpg', name:'Plain Fitted Crew Tee', brand:'Sunspel / James Perse', budget:'$28', mid:'$75', invest:'$145', why:'The foundation of every Beckham street look.' },
      { img:'https://m.media-amazon.com/images/I/71WiGV6YPZL._AC_UY879_.jpg', name:'Dark Slim Jeans', brand:'J Brand / Acne Studios', budget:'$60', mid:'$180', invest:'$380', why:'Straight or slim — always a clean wash, never distressed.' },
      { img:'https://m.media-amazon.com/images/I/81LxwS4MFZL._AC_UY879_.jpg', name:'Leather Biker Jacket', brand:'Belstaff / AllSaints', budget:'$180', mid:'$450', invest:'$1,200', why:'His casual layer of choice when not in tailoring.' },
    ],
    matchCats: ['Tops','Bottoms','Footwear','Outerwear'],
    coachPrompts: [
      'Dress me like David Beckham for a dinner out',
      'What\'s the Beckham formula for smart-casual?',
      'What shoes should I get to match Beckham\'s style?',
      'How do I build a capsule wardrobe like Beckham?',
    ]
  },
  {
    id: 'pharrell',
    name: 'Pharrell Williams',
    cat: 'musician',
    catLabel: 'Musician · Creative Director',
    photo: 'https://images.unsplash.com/photo-1618354691373-d851c5c3a990?w=600&q=80',
    vibe: 'Color-forward streetwear elevated by luxury. Pharrell mixes Chanel with Supreme, Adidas with Hermès — and makes it look effortless because every piece is intentional.',
    moods: ['streetwear','avant','ald'],
    brands: ['Louis Vuitton','Chanel','Human Made','Adidas','Cactus Plant Flea Market'],
    signature: ['bold statement hats','luxury streetwear','vintage denim','rare sneakers','layered jewelry'],
    palette: ['Yellow','Red','Blue','Pink','Black'],
    keyItems: [
      { img:'https://m.media-amazon.com/images/I/71LGGAHL7FL._AC_UY695_.jpg', name:'Structured Logo Cap', brand:'Human Made / LV', budget:'$45', mid:'$120', invest:'$680', why:'Never been seen without headwear. The hat is the brand.' },
      { img:'https://m.media-amazon.com/images/I/71zKK14j0wL._AC_UY695_.jpg', name:'Statement Sneakers', brand:'Adidas Humanrace / NMD', budget:'$90', mid:'$180', invest:'$450', why:'Bold colorways — Pharrell never wears a plain white shoe.' },
      { img:'https://m.media-amazon.com/images/I/61t6wT4gRDL._AC_UY879_.jpg', name:'Wide Leg Denim', brand:'Human Made / LV', budget:'$80', mid:'$220', invest:'$890', why:'His silhouette is wide and relaxed — never slim.' },
      { img:'https://m.media-amazon.com/images/I/61P0akLV+RL._AC_UY879_.jpg', name:'Vintage-Wash Jacket', brand:'Human Made / Wrangler', budget:'$45', mid:'$160', invest:'$480', why:'Denim or chore coat, always with a story behind it.' },
      { img:'https://m.media-amazon.com/images/I/61ZS8w-MXNL._AC_UY695_.jpg', name:'Layered Chain Necklaces', brand:'Various / Chrome Hearts', budget:'$30', mid:'$150', invest:'$1,400', why:'The finishing touch that makes plain fits extraordinary.' },
    ],
    matchCats: ['Tops','Bottoms','Footwear','Accessories'],
    coachPrompts: [
      'Give me Pharrell\'s approach to color in an outfit',
      'How do I mix streetwear and luxury like Pharrell?',
      'What hat styles work for everyday wear like Pharrell?',
      'Build me a Pharrell-inspired weekend look from my closet',
    ]
  },
  {
    id: 'matty',
    name: 'Matty Healy',
    cat: 'musician',
    catLabel: 'Musician · Style Maverick',
    photo: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=600&q=80',
    vibe: 'Confident, maximalist rock energy filtered through tailoring. Matty wears suits as a rocker — not as a businessman — and that\'s exactly what makes it work.',
    moods: ['avant','business','smart-casual'],
    brands: ['Alexander McQueen','Dior','Vivienne Westwood','Gucci','Vintage'],
    signature: ['oversized suits','sheer shirts','patterned fabrics','chelsea boots','statement jewelry'],
    palette: ['Black','Burgundy','Cream','Dark Tartan','Deep Green'],
    keyItems: [
      { img:'https://m.media-amazon.com/images/I/61Yzdn5QfVL._AC_UY879_.jpg', name:'Oversized/Relaxed Suit', brand:'Gucci / Vintage thrift', budget:'$80', mid:'$340', invest:'$1,800', why:'Worn with nothing underneath or with a graphic tee — the suit is the statement.' },
      { img:'https://m.media-amazon.com/images/I/71S3FJxpMaL._AC_UY695_.jpg', name:'Pointed Chelsea Boot', brand:'ASOS / Vivienne Westwood', budget:'$75', mid:'$185', invest:'$620', why:'Elongates the leg and completes any tailored look.' },
      { img:'https://m.media-amazon.com/images/I/61R6qT0MJfL._AC_UY695_.jpg', name:'Sterling Silver Rings', brand:'Serge DeNimes / Alex Monroe', budget:'$25', mid:'$90', invest:'$380', why:'Multiple rings, every finger — the detail that separates the look.' },
      { img:'https://m.media-amazon.com/images/I/71KgLH3THUL._AC_UY879_.jpg', name:'Sheer or Satin Shirt', brand:'H&M / COS / Gucci', budget:'$35', mid:'$140', invest:'$680', why:'An unexpected texture that reads artistic rather than try-hard.' },
      { ico:'🕶', name:'Retro Tinted Glasses', brand:'Oliver Peoples / DIOR', budget:'$30', mid:'$180', invest:'$480', why:'The constant. Round or rectangular, always tinted.' },
    ],
    matchCats: ['Tops','Bottoms','Accessories','Footwear'],
    coachPrompts: [
      'How do I wear a suit the way Matty Healy does?',
      'What jewelry works for a rock-inspired look?',
      'Give me a Matty Healy outfit from my current closet',
      'How do I add edge to smart clothes like Matty?',
    ]
  },
  {
    id: 'james',
    name: 'LeBron James',
    cat: 'athlete',
    catLabel: 'Athlete · Tunnel Walk Legend',
    photo: 'https://images.unsplash.com/photo-1600878459108-617a253537e9?w=600&q=80',
    vibe: 'The arena tunnel walk as runway. LeBron mixes designer power dressing with oversized streetwear — always intentional, always statement-making, always expensive-looking.',
    moods: ['streetwear','business','avant'],
    brands: ['Thom Browne','Louis Vuitton','Nike','Ralph Lauren','Amiri'],
    signature: ['oversized tailoring','designer track suits','luxury sneakers','bold glasses','patterned shirts'],
    palette: ['Burgundy','Camel','Black','Royal Blue','Forest Green'],
    keyItems: [
      { ico:'🧥', name:'Thom Browne Suit', brand:'Thom Browne / Suitsupply', budget:'$350', mid:'$800', invest:'$3,200', why:'The signature cropped, patch-pocket suit is LeBron\'s most copied look.' },
      { ico:'👟', name:'High-End Sneaker', brand:'Nike / Air Jordan / LV', budget:'$130', mid:'$280', invest:'$900', why:'Never a basic sneaker — always a statement pair with the fit.' },
      { ico:'🕶', name:'Oversized Bold Glasses', brand:'Celine / DIOR / Chrome Hearts', budget:'$18', mid:'$120', invest:'$580', why:'The accessory that becomes the whole conversation.' },
      { ico:'🧥', name:'Luxury Track Jacket', brand:'Amiri / Palm Angels', budget:'$90', mid:'$380', invest:'$1,100', why:'Worn as a top layer over tailoring — the unexpected combo.' },
      { ico:'💼', name:'Designer Carry Bag', brand:'Louis Vuitton / Goyard', budget:'-', mid:'$680', invest:'$1,800', why:'LeBron never walks the tunnel without a bag. It finishes the look.' },
    ],
    matchCats: ['Outerwear','Footwear','Accessories'],
    coachPrompts: [
      'How do I pull off the LeBron oversized tailoring look?',
      'What\'s the best entry-level way to dress like LeBron?',
      'Give me a LeBron-inspired outfit for a casual dinner',
      'What accessories make the biggest impact like LeBron?',
    ]
  },
  {
    id: 'elon',
    name: 'Elon Musk',
    cat: 'business',
    catLabel: 'CEO · Tech Entrepreneur',
    photo: 'https://images.unsplash.com/photo-1496180727794-817822f65950?w=600&q=80',
    vibe: 'The "too busy to think about clothes" uniform elevated. Plain tees, clean trousers, good footwear — zero pattern, zero color, maximum signal that you don\'t care (which means people think you don\'t need to).',
    moods: ['minimal','smart-casual'],
    brands: ['Uniqlo','COS','Brunello Cucinelli','Rick Owens','Common Projects'],
    signature: ['plain dark tee','slim trousers','clean minimal sneaker','single dark layer','no accessories'],
    palette: ['Black','Dark Grey','Navy','Off-White'],
    keyItems: [
      { ico:'👕', name:'Plain Black/Grey Tee', brand:'Uniqlo / James Perse', budget:'$12', mid:'$55', invest:'$145', why:'The anchor. No logo, no print, perfect fit.' },
      { ico:'👖', name:'Dark Slim Trousers', brand:'Uniqlo / COS', budget:'$40', mid:'$120', invest:'$380', why:'Not jeans — trousers. Cleaner, more intentional.' },
      { ico:'👟', name:'Clean White Sneaker', brand:'Common Projects / Veja', budget:'$90', mid:'$215', invest:'$450', why:'The only shoe. No variation, no collection — just one clean pair.' },
      { ico:'🧥', name:'Minimalist Dark Jacket', brand:'COS / Rick Owens', budget:'$80', mid:'$240', invest:'$980', why:'When a layer is needed — nothing printed, nothing branded.' },
    ],
    matchCats: ['Tops','Bottoms','Footwear','Outerwear'],
    coachPrompts: [
      'Build me the "CEO minimal" uniform from my closet',
      'How do I dress like I\'m too busy to care but still look great?',
      'What\'s the tech-CEO capsule wardrobe?',
      'How many items do I actually need for a minimal wardrobe?',
    ]
  },
  {
    id: 'tyler',
    name: 'Tyler, the Creator',
    cat: 'musician',
    catLabel: 'Musician · Designer',
    photo: 'https://images.unsplash.com/photo-1606107557195-0e29a4b5b4aa?w=600&q=80',
    vibe: 'Pastels, patterns, and proportions nobody else would attempt. Tyler\'s style is cartoon-come-to-life — but executed with real fashion knowledge. Golf le Fleur has turned his aesthetic into one of the most distinctive in the game.',
    moods: ['avant','streetwear','coastal'],
    brands: ['Golf le Fleur','Lacoste','Gucci','Converse','Bode'],
    signature: ['pastel polo shirts','bold patterned shorts','bucket hats','loafers with socks','quirky accessories'],
    palette: ['Sage Green','Baby Blue','Burnt Orange','Pink','Butter Yellow'],
    keyItems: [
      { ico:'🏌', name:'Pastel Polo Shirt', brand:'Golf le Fleur / Lacoste', budget:'$55', mid:'$135', invest:'$320', why:'The Tyler cornerstone. Bold pastel, slightly relaxed fit.' },
      { ico:'🪣', name:'Bucket Hat', brand:'Golf le Fleur / Kangol', budget:'$25', mid:'$65', invest:'$180', why:'Never without one. The silhouette is part of his brand identity.' },
      { ico:'👟', name:'Converse Golf le Fleur', brand:'Golf le Fleur x Converse', budget:'$80', mid:'$110', invest:'$280+', why:'His signature sneaker — the flower detail is unmistakable.' },
      { ico:'🩳', name:'Patterned Wide Shorts', brand:'Golf le Fleur / Bode', budget:'$40', mid:'$120', invest:'$380', why:'Bold prints, always slightly long. Never athletic shorts.' },
      { ico:'🧦', name:'Statement Socks', brand:'Golf le Fleur / Tabio', budget:'$12', mid:'$28', invest:'$65', why:'Loafers with printed socks — the finishing detail that ties everything.' },
    ],
    matchCats: ['Tops','Bottoms','Footwear','Accessories'],
    coachPrompts: [
      'How do I incorporate Tyler\'s pastel aesthetic without looking costume-y?',
      'Build me a Tyler-inspired summer look from my closet',
      'What\'s the right way to style a polo like Tyler?',
      'Can I do Tyler\'s bold color approach on a budget?',
    ]
  },
  {
    id: 'clooney',
    name: 'George Clooney',
    cat: 'actor',
    catLabel: 'Actor · Classic Style Icon',
    photo: 'https://images.unsplash.com/photo-1500048993953-d23a436266cf?w=600&q=80',
    vibe: 'The definition of effortless classic masculinity. Clooney never chases trends — he ignores them and comes out looking better than everyone who did. Navy, grey, white, a good watch, and clothes that fit.',
    moods: ['smart-casual','business','old-money'],
    brands: ['Giorgio Armani','Loro Piana','Kiton','Rolex','Tom Ford'],
    signature: ['perfectly fitted blue jeans','white or light blue dress shirt','navy blazer','leather belt','clean watch'],
    palette: ['Navy','Heather Grey','White','Sand','Mid-Blue'],
    keyItems: [
      { ico:'🧥', name:'Navy Unstructured Blazer', brand:'J.Crew / Massimo Dutti', budget:'$120', mid:'$380', invest:'$1,400', why:'The cornerstone of classic masculine dressing. Pairs with everything.' },
      { ico:'👔', name:'White or Light Blue Dress Shirt', brand:'Uniqlo / Eton', budget:'$35', mid:'$120', invest:'$385', why:'Always slightly open collar — never fully buttoned.' },
      { ico:'👖', name:'Well-Fitted Mid-Wash Jeans', brand:'Levi\'s 511 / APC', budget:'$60', mid:'$165', invest:'$390', why:'Mid-wash, straight or slight taper. Not dark, not distressed.' },
      { ico:'⌚', name:'Classic Dress Watch', brand:'Seiko / Tissot / Rolex', budget:'$180', mid:'$650', invest:'$6,500', why:'The accessory that does all the communicating for you.' },
      { ico:'👞', name:'Simple Leather Loafer or Derby', brand:'Meermin / Magnanni', budget:'$90', mid:'$220', invest:'$680', why:'Always leather, always clean, always the right call.' },
    ],
    matchCats: ['Tops','Bottoms','Outerwear','Footwear'],
    coachPrompts: [
      'Give me the George Clooney formula for dressing well simply',
      'What\'s the perfect navy blazer outfit from my closet?',
      'How do jeans + blazer look as polished as Clooney?',
      'Build me a Clooney-style capsule with 10 items',
    ]
  },
  {
    id: 'ryan-reynolds',
    name: 'Ryan Reynolds',
    cat: 'actor',
    catLabel: 'Actor · Smart Casual Expert',
    photo: 'https://images.unsplash.com/photo-1493106641515-6b5631de4bb9?w=600&q=80',
    vibe: 'The most approachable version of looking great. Ryan Reynolds wears things every guy owns — and makes them look a level better through fit, proportion, and a genuine lack of trying too hard.',
    moods: ['smart-casual','minimal','ald'],
    brands: ['Tom Ford','Zara','J.Crew','Polo Ralph Lauren','David Hart'],
    signature: ['perfectly fitted casual button-down','tailored casual trousers','slim jeans','clean boots','subtle layering'],
    palette: ['Navy','Burgundy','Olive','White','Camel'],
    keyItems: [
      { ico:'👔', name:'Fitted Casual Button-Down', brand:'Uniqlo / Polo Ralph Lauren', budget:'$40', mid:'$95', invest:'$260', why:'Untucked, first button open, sleeves casually rolled. Looks expensive without trying.' },
      { ico:'🥾', name:'Clean Suede Chukka Boot', brand:'Clark\'s / Loake', budget:'$80', mid:'$195', invest:'$480', why:'The most versatile shoe in the world. Ryan\'s go-to.' },
      { ico:'🧥', name:'Slim Camel Overcoat', brand:'Zara / Topman', budget:'$120', mid:'$320', invest:'$1,100', why:'The layer that elevates a simple outfit to a great one instantly.' },
      { ico:'👖', name:'Slim Navy or Grey Chinos', brand:'Bonobos / Banana Republic', budget:'$45', mid:'$95', invest:'$220', why:'Not jeans, not dress pants — the middle ground that always works.' },
      { ico:'🧥', name:'Merino V-neck or Crewneck', brand:'Uniqlo / Reiss', budget:'$30', mid:'$85', invest:'$230', why:'Over a tee or solo — the sweater is his casual layer of choice.' },
    ],
    matchCats: ['Tops','Bottoms','Outerwear','Footwear'],
    coachPrompts: [
      'Give me the Ryan Reynolds smart-casual formula',
      'How do I make basics look as good as Ryan Reynolds?',
      'What\'s the key to his boot + chino + casual shirt look?',
      'Dress me like Ryan Reynolds for a weekend date',
    ]
  },
  {
    id: 'zuckerberg',
    name: 'Mark Zuckerberg',
    cat: 'business',
    catLabel: 'CEO · Glow-Up Icon',
    photo: 'https://images.unsplash.com/photo-1617127365659-c47fa864d8bc?w=600&q=80',
    vibe: 'The most famous wardrobe evolution in Silicon Valley. From grey tee uniform to Brunello Cucinelli cashmere and tailored basics. Mark\'s current style is quiet luxury minimalism done with real intention.',
    moods: ['minimal','old-money','smart-casual'],
    brands: ['Brunello Cucinelli','Loro Piana','Mercer Amsterdam','Zegna','Common Projects'],
    signature: ['cashmere or premium knit sweater','tailored grey or cream trousers','clean white sneaker','perfect fit basics','no accessories'],
    palette: ['Grey','Cream','Navy','White','Tan'],
    keyItems: [
      { ico:'🧶', name:'Cashmere Crewneck', brand:'Uniqlo / Brunello Cucinelli', budget:'$80', mid:'$280', invest:'$1,200', why:'The centrepiece of his current wardrobe. Quality you can feel from across the room.' },
      { ico:'👖', name:'Tailored Cream or Grey Trousers', brand:'COS / Zegna', budget:'$70', mid:'$195', invest:'$680', why:'The refined alternative to jeans — pairs with knits perfectly.' },
      { ico:'👟', name:'Clean Minimalist Sneaker', brand:'Common Projects / On Running', budget:'$120', mid:'$295', invest:'$450', why:'Achilles Low or equivalent. White or cream, no branding.' },
      { ico:'👔', name:'Premium Plain Tee', brand:'Sunspel / James Perse', budget:'$28', mid:'$75', invest:'$145', why:'The grey tee lives on — but now in mercerized cotton and a better fit.' },
    ],
    matchCats: ['Tops','Bottoms','Footwear'],
    coachPrompts: [
      'Build me the Zuckerberg quiet luxury uniform',
      'What\'s the upgrade path from basic tee to premium basics?',
      'How do I do the CEO-minimal aesthetic without looking boring?',
      'What\'s the most impactful single piece to buy for a Zuckerberg-style wardrobe?',
    ]
  },
  {
    id: 'kanye',
    name: 'Kanye West',
    cat: 'musician',
    catLabel: 'Musician · Fashion Architect',
    photo: 'https://images.unsplash.com/photo-1558171813-2e79a3c21e38?w=600&q=80',
    vibe: 'The most influential wardrobe in menswear this century. From Polo Ralph Lauren-era prep to Yeezy minimalism to Balenciaga maximalism — Kanye has defined each era of men\'s fashion for 20 years.',
    moods: ['avant','streetwear','minimal'],
    brands: ['Yeezy','Balenciaga','Gap Yeezy','Raf Simons','Helmut Lang Vintage'],
    signature: ['oversized distressed basics','neutral monochrome','sculptural boots','wide silhouettes','layered neutral tones'],
    palette: ['Earth Brown','Sand','Charcoal','Off-White','Rust'],
    keyItems: [
      { ico:'🧥', name:'Oversized Neutral Hoodie', brand:'Yeezy / Balenciaga', budget:'$35', mid:'$95', invest:'$580', why:'The foundation of Yeezy-era dressing. Fits at least 2 sizes up.' },
      { ico:'🥾', name:'Sculptural Chelsea or Combat Boot', brand:'Yeezy / Balenciaga', budget:'$120', mid:'$380', invest:'$1,100', why:'The boot is always architectural. Never just a boot.' },
      { ico:'🧥', name:'Long Distressed Coat or Jacket', brand:'Vintage / CdG / Balenciaga', budget:'$60', mid:'$280', invest:'$2,400', why:'The oversized outerwear piece that anchors the silhouette.' },
      { ico:'🩳', name:'Neutral Wide-Leg Trousers', brand:'Yeezy / COS', budget:'$45', mid:'$140', invest:'$480', why:'Wide, long, cropped at the boot. The Yeezy trouser formula.' },
      { ico:'🧦', name:'Monochrome Socks + Shoes', brand:'Uniqlo / Yeezy', budget:'$8', mid:'$25', invest:'-', why:'Everything tonal. Matching your socks to your shoes is the Yeezy detail.' },
    ],
    matchCats: ['Tops','Bottoms','Outerwear','Footwear'],
    coachPrompts: [
      'How do I do earth-tone minimalism the Yeezy way?',
      'Build me a neutral monochrome outfit from my closet',
      'What\'s the right way to wear oversized without looking sloppy?',
      'How do boots and wide trousers work together?',
    ]
  },
  {
    id: 'pitt',
    name: 'Brad Pitt',
    cat: 'actor',
    catLabel: 'Actor · Effortless Californian',
    photo: 'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=600&q=80',
    vibe: 'The original effortless Hollywood guy. Brad Pitt dresses like a man who doesn\'t have to try — because he\'s been well-dressed long enough that it\'s just who he is. Linen, denim, clean silhouettes, Cali ease.',
    moods: ['ald','smart-casual','coastal'],
    brands: ['Brioni','Loro Piana','Thom Browne','Common Projects','RRL Ralph Lauren'],
    signature: ['quality linen shirts','well-fitted vintage denim','loafers or oxfords','minimal jewelry','relaxed tailoring'],
    palette: ['Camel','Off-White','Faded Blue','Olive','Tan'],
    keyItems: [
      { ico:'👔', name:'Quality Linen Shirt', brand:'Sunspel / 120% Lino', budget:'$55', mid:'$145', invest:'$380', why:'Always slightly rumpled, always intentional. Never freshly pressed.' },
      { ico:'👖', name:'Vintage-Wash Wide Denim', brand:'RRL Ralph Lauren / Levi\'s Vintage', budget:'$65', mid:'$195', invest:'$480', why:'Worn-in, lived-in, high-waist or regular. Not slim, never skinny.' },
      { ico:'👞', name:'Leather Loafer or Penny Slip-on', brand:'Meermin / ALD / Loro Piana', budget:'$95', mid:'$260', invest:'$680', why:'Sockless, barely broken in. The California finishing touch.' },
      { ico:'🕶', name:'Vintage-Style Sunglasses', brand:'Oliver Peoples / Moscot', budget:'$35', mid:'$165', invest:'$480', why:'Worn constantly. Round or aviator — always a classic shape.' },
      { ico:'🧥', name:'Unstructured Linen Blazer', brand:'Zara / Berg & Berg', budget:'$80', mid:'$260', invest:'$860', why:'Thrown on as an afterthought. The best jacket you own worn like the least expensive.' },
    ],
    matchCats: ['Tops','Bottoms','Outerwear','Footwear'],
    coachPrompts: [
      'How do I nail Brad Pitt\'s relaxed Californian aesthetic?',
      'What\'s the right denim for a Brad Pitt-inspired look?',
      'Build me a warm-weather linen outfit from my closet',
      'How do I make loafers work the way Brad Pitt does?',
    ]
  },
  {
    id: 'harry-styles',
    name: 'Harry Styles',
    cat: 'musician',
    catLabel: 'Musician · Gender-Fluid Pioneer',
    photo: 'https://images.unsplash.com/photo-1536766820879-059fec98ec0a?w=600&q=80',
    vibe: 'Gucci-era maximalism with a vintage 70s soul. Harry made flared trousers, sheer tops, and double-breasted suits a mainstream conversation — and he\'s never looked anything less than completely committed.',
    moods: ['avant','smart-casual','streetwear'],
    brands: ['Gucci','Alessandra Rich','JW Anderson','Palomo Spain','Bode'],
    signature: ['flared or wide-leg trousers','vintage-inspired prints','open sheer shirts','bold accessories','double-breasted suits'],
    palette: ['Burgundy','Mustard','Cream','Forest Green','Navy'],
    keyItems: [
      { ico:'👖', name:'Flared or Wide-Leg Trouser', brand:'Gucci / ASOS / Zara', budget:'$40', mid:'$145', invest:'$780', why:'The most Harry Styles item in menswear. High waist, wide leg.' },
      { ico:'👔', name:'Vintage-Print or Bold Pattern Shirt', brand:'Bode / Vintage / Gucci', budget:'$35', mid:'$165', invest:'$680', why:'Never a plain shirt. Pattern, print, crochet, sheer, jacquard.' },
      { ico:'📿', name:'Nail Polish + Rings', brand:'NCLA / Gucci', budget:'$9', mid:'$30', invest:'$180', why:'The detail that shows real commitment to personal style over conformity.' },
      { ico:'🥾', name:'Stacked Heel Chelsea Boot', brand:'ASOS / Acne Studios', budget:'$65', mid:'$250', invest:'$780', why:'Always slightly elevated heel — it\'s the silhouette, not just a shoe.' },
      { ico:'🧥', name:'Double-Breasted Statement Suit', brand:'Zara / Gucci / Bode', budget:'$180', mid:'$480', invest:'$2,400', why:'Worn as separates or a full look. Always a statement fabric.' },
    ],
    matchCats: ['Tops','Bottoms','Accessories','Footwear'],
    coachPrompts: [
      'How do I approach Harry Styles-level boldness without full commitment?',
      'What\'s a wearable entry point into Harry\'s aesthetic?',
      'Build me a Harry Styles-inspired look with what I own',
      'What\'s the most important piece for a 70s Harry aesthetic?',
    ]
  },
];

var iconCatFilter = 'all';
var iconSearchQuery = '';
var activeIconId = null;

function initIcons() {
  renderIconGrid();
}

function filterIconCat(el, cat) {
  iconCatFilter = cat;
  el.closest('.icons-cat-row').querySelectorAll('.chip').forEach(function(c){ c.classList.remove('active'); });
  el.classList.add('active');
  renderIconGrid();
}

function filterIcons(query) {
  iconSearchQuery = query.toLowerCase();
  renderIconGrid();
}

function renderIconGrid() {
  var grid = document.getElementById('icon-grid');
  if (!grid) return;

  var filtered = ICONS_DATA.filter(function(ic) {
    var catMatch = iconCatFilter === 'all' || ic.cat === iconCatFilter;
    var searchMatch = !iconSearchQuery ||
      ic.name.toLowerCase().indexOf(iconSearchQuery) > -1 ||
      ic.vibe.toLowerCase().indexOf(iconSearchQuery) > -1 ||
      ic.brands.join(' ').toLowerCase().indexOf(iconSearchQuery) > -1 ||
      ic.moods.join(' ').toLowerCase().indexOf(iconSearchQuery) > -1;
    return catMatch && searchMatch;
  });

  if (filtered.length === 0) {
    grid.innerHTML = '<div style="grid-column:1/3;text-align:center;padding:40px 20px;color:var(--ink3)"><div style="font-size:32px;margin-bottom:10px">🔍</div><div style="font-size:13px">No icons match "'+iconSearchQuery+'"</div></div>';
    return;
  }

  grid.innerHTML = filtered.map(function(ic) {
    // Generate initials from name
    var nameParts = ic.name.split(' ');
    var initials = nameParts.map(function(p) { return p[0]; }).join('').substring(0,2);
    // Generate a consistent color based on the name
    var colors = ['#1a1a2e','#16213e','#0f3460','#533483','#622569','#3c1642','#086972','#17252a'];
    var colorIdx = ic.name.length % colors.length;
    var bgColor = colors[colorIdx];
    
    return '<div class="icon-card" onclick="openIconSheet(\''+ic.id+'\')">'+
      '<div class="icon-photo" style="background:'+bgColor+'">'+
        '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">'+
          '<span style="font-family:\'Cormorant Garamond\',serif;font-size:42px;font-weight:300;color:rgba(255,255,255,0.9);letter-spacing:0.05em">'+initials+'</span>'+
        '</div>'+
        '<div class="icon-photo-overlay"></div>'+
        '<div class="icon-photo-name">'+
          '<div class="icon-photo-cat">'+ic.catLabel+'</div>'+
          ic.name+
        '</div>'+
      '</div>'+
      '<div class="icon-body">'+
        '<div class="icon-vibe">'+ic.vibe.substring(0,80)+'...</div>'+
        '<div class="icon-tags">'+ic.brands.slice(0,3).map(function(b){ return '<div class="icon-tag">'+b+'</div>'; }).join('')+'</div>'+
      '</div>'+
    '</div>';
  }).join('');
}

function openIconSheet(id) {
  var ic = ICONS_DATA.find(function(x){ return x.id === id; });
  if (!ic) return;
  activeIconId = id;

  // Generate initials and color
  var nameParts = ic.name.split(' ');
  var initials = nameParts.map(function(p) { return p[0]; }).join('').substring(0,2);
  var colors = ['#1a1a2e','#16213e','#0f3460','#533483','#622569','#3c1642','#086972','#17252a'];
  var colorIdx = ic.name.length % colors.length;
  var bgColor = colors[colorIdx];

  // Populate sheet hero with initials instead of photo
  var img = document.getElementById('icon-sheet-img');
  if (img) { 
    img.style.display = 'none';
    img.parentElement.style.background = bgColor;
    // Add initials overlay
    var existingInitials = img.parentElement.querySelector('.initials-overlay');
    if (!existingInitials) {
      var initialsDiv = document.createElement('div');
      initialsDiv.className = 'initials-overlay';
      initialsDiv.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:"Cormorant Garamond",serif;font-size:72px;font-weight:300;color:rgba(255,255,255,0.3);letter-spacing:0.05em;z-index:1';
      img.parentElement.appendChild(initialsDiv);
    }
    var initialsEl = img.parentElement.querySelector('.initials-overlay');
    if (initialsEl) initialsEl.textContent = initials;
  }
  var nm = document.getElementById('icon-sheet-name');
  if (nm) nm.textContent = ic.name;
  var ct = document.getElementById('icon-sheet-cat');
  if (ct) ct.textContent = ic.catLabel;
  var vb = document.getElementById('icon-sheet-vibe');
  if (vb) vb.textContent = ic.vibe;

  // Calculate match score from user's closet
  var matchScore = calcMatchScore(ic);
  var ring = document.getElementById('icon-match-ring');
  if (ring) ring.style.background = 'conic-gradient(var(--ink) 0% '+matchScore+'%, var(--s3) '+matchScore+'% 100%)';
  var pct = document.getElementById('icon-match-pct');
  if (pct) pct.textContent = matchScore+'%';
  var hl = document.getElementById('icon-match-headline');
  if (hl) hl.textContent = matchScore < 20 ? "Let's build this look" : matchScore < 50 ? "You're "+matchScore+"% there" : matchScore < 80 ? "Strong foundation — "+matchScore+"% match" : "You're basically living this aesthetic";
  var sub = document.getElementById('icon-match-sub');
  if (sub) sub.textContent = ic.keyItems.length + ' key pieces define the look';

  // Populate "what you have" from closet
  renderIconClosetMatch(ic);

  // Populate "what to add"
  renderIconAddList(ic);

  // Populate shop list
  renderIconShopList(ic);

  // Populate coach prompts
  renderIconCoachPrompts(ic);

  // Reset tabs
  iconTab(null, 'match');

  // Open sheet
  document.getElementById('icon-sheet-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeIconSheet() {
  document.getElementById('icon-sheet-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

function calcMatchScore(ic) {
  if (ITEMS.length === 0) return 0;
  var points = 0;
  var max = ic.matchCats.length * 2;
  ic.matchCats.forEach(function(cat) {
    var has = ITEMS.filter(function(i){ return i.cat === cat; });
    if (has.length > 0) points += 1;
    if (has.length > 1) points += 1;
  });
  // Also check moods overlap
  var moodOverlap = (userProfile.moods || []).filter(function(m){ return ic.moods.indexOf(m) > -1; }).length;
  if (moodOverlap > 0) points += moodOverlap;
  max += 3;
  return Math.min(Math.round(points / max * 100), 95);
}

function renderIconClosetMatch(ic) {
  var row = document.getElementById('icon-you-have');
  if (!row) return;
  var catIco = {Tops:'👔',Bottoms:'👖',Outerwear:'🧥',Footwear:'👟',Accessories:'🧣',Suiting:'🤵',Other:'👕'};

  if (ITEMS.length === 0) {
    row.innerHTML = '<div style="font-size:12px;color:var(--ink4);padding:10px">Your closet is empty — add items and come back to see your match.</div>';
    return;
  }

  // Match items in closet to ic's needed categories
  var matched = [];
  ic.matchCats.forEach(function(cat) {
    var found = ITEMS.filter(function(i){ return i.cat === cat; });
    found.forEach(function(f){ matched.push({item:f, matchCat:cat}); });
  });

  if (matched.length === 0) {
    row.innerHTML = '<div style="font-size:12px;color:var(--ink4);padding:10px">None of your items match '+ic.name+'\'s key categories. Add '+ic.matchCats.join(', ')+'.</div>';
    return;
  }

  row.innerHTML = matched.slice(0,6).map(function(m) {
    var ico = catIco[m.item.cat] || '👕';
    return '<div class="you-have-item">'+
      '<div class="you-have-img">'+(m.item.img ? '<img src="'+m.item.img+'" onerror="this.style.display=\'none\'" alt="">' : '')+ico+'</div>'+
      '<div class="you-have-match">'+m.item.name.split(' ').slice(0,2).join(' ')+'</div>'+
      '</div>';
  }).join('');
}

function renderIconAddList(ic) {
  var list = document.getElementById('icon-add-list');
  if (!list) return;
  var ownedCats = {};
  ITEMS.forEach(function(i){ ownedCats[i.cat] = true; });

  var missing = ic.keyItems.filter(function(ki) {
    // Show all key items user doesn't already have a match for
    var matchName = ITEMS.find(function(i){ return i.name.toLowerCase().indexOf(ki.name.split(' ')[0].toLowerCase()) > -1; });
    return !matchName;
  });

  if (missing.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:14px;color:var(--ink3);font-size:12px">You likely have most of the pieces — check the Shop tab for specific item recommendations.</div>';
    return;
  }

  list.innerHTML = missing.slice(0,4).map(function(ki, idx) {
    var tier = ki.budget !== '-' ? '<span class="shop-price-badge badge-budget">Budget: '+ki.budget+'</span>' : '';
    tier += ' <span class="shop-price-badge badge-mid">Mid: '+ki.mid+'</span>';
    var imgHtml = ki.img 
      ? '<img src="'+ki.img+'" alt="'+ki.name+'" style="width:100%;height:100%;object-fit:cover;border-radius:6px" onerror="this.style.display=\'none\'">'
      : (ki.ico || '');
    var searchQuery = encodeURIComponent(ki.name + ' ' + ki.brand.split('/')[0].trim());
    return '<div onclick="openProductSearch(\''+ki.name+'\', \''+ki.brand.replace(/'/g, "")+'\')" style="display:flex;align-items:flex-start;gap:10px;padding:12px 0;border-bottom:1px solid var(--border);cursor:pointer">'+
      '<div style="width:50px;height:50px;flex-shrink:0;background:var(--s2);border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center">'+imgHtml+'</div>'+
      '<div style="flex:1">'+
        '<div style="font-size:13px;font-weight:700;margin-bottom:3px">'+ki.name+'</div>'+
        '<div style="font-size:11px;color:var(--ink3);line-height:1.5;margin-bottom:6px">'+ki.why+'</div>'+
        '<div style="display:flex;gap:4px;flex-wrap:wrap">'+tier+'</div>'+
      '</div>'+
      '<div style="color:var(--ink3);font-size:12px;align-self:center">→</div>'+
    '</div>';
  }).join('');
}

function openProductSearch(name, brand) {
  var brandClean = brand.split('/')[0].trim();
  var query = encodeURIComponent(name + ' ' + brandClean);
  // Open Google Shopping search
  window.open('https://www.google.com/search?tbm=shop&q=' + query, '_blank');
}

function renderIconShopList(ic) {
  var list = document.getElementById('icon-shop-list');
  var intro = document.getElementById('icon-shop-intro');
  if (!list) return;
  if (intro) intro.textContent = 'The '+ic.keyItems.length+' pieces that define '+ic.name+'\'s style — with options at every price point.';

  list.innerHTML = ic.keyItems.map(function(ki) {
    var imgHtml = ki.img 
      ? '<img src="'+ki.img+'" alt="'+ki.name+'" style="width:100%;height:100%;object-fit:cover;border-radius:6px" onerror="this.style.display=\'none\'">'
      : (ki.ico || '');
    return '<div class="shop-item-card" onclick="showToast(\'Finding '+ki.name+'...\')">' +
      '<div class="shop-item-ico">'+imgHtml+'</div>'+
      '<div style="flex:1">'+
        '<div class="shop-item-name">'+ki.name+'</div>'+
        '<div class="shop-item-brand">'+ki.brand+'</div>'+
        '<div class="shop-price-row">'+
          (ki.budget!=='-' ? '<span class="shop-price-badge badge-budget">'+ki.budget+'</span>' : '')+
          '<span class="shop-price-badge badge-mid">'+ki.mid+'</span>'+
          '<span class="shop-price-badge badge-invest">'+ki.invest+'</span>'+
        '</div>'+
      '</div>'+
      '<div style="font-size:12px;font-weight:700;color:var(--ink3);align-self:center">→</div>'+
    '</div>';
  }).join('');
}

function renderIconCoachPrompts(ic) {
  var prompts = document.getElementById('icon-coach-prompts');
  var coachIntro = document.getElementById('icon-coach-intro');
  if (coachIntro) coachIntro.textContent = 'Your coach has '+ic.name+'\'s full style profile loaded. Ask anything about how to adopt this aesthetic.';
  if (!prompts) return;
  prompts.innerHTML = ic.coachPrompts.map(function(p) {
    return '<button class="coach-quick" onclick="sendIconPrompt(\''+p.replace(/'/g, "\\'")+'\', this)" style="text-align:left;white-space:normal;padding:10px 14px;border-radius:10px;width:100%">'+p+'</button>';
  }).join('');
}

function iconTab(el, tab) {
  document.querySelectorAll('.icon-tab').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.icon-tab-content').forEach(function(t){ t.classList.remove('active'); });
  if (el) el.classList.add('active');
  else {
    var tabs = document.querySelectorAll('.icon-tab');
    if (tabs[0]) tabs[0].classList.add('active');
  }
  var content = document.getElementById('itab-'+tab);
  if (content) content.classList.add('active');
}

function sendIconPrompt(prompt, btn) {
  var ic = ICONS_DATA.find(function(x){ return x.id === activeIconId; });
  var context = ic ? ' (Style context: '+ic.name+' — '+ic.vibe.substring(0,80)+')' : '';
  if (btn) btn.style.opacity = '0.5';
  closeIconSheet();
  showPage('coach', document.querySelector('.bn-item[onclick*="coach"]'));

  if (!isPremium) {
    setTimeout(function(){
      showToast('Unlock Premium to chat with your Style Coach');
    }, 400);
    return;
  }
  document.getElementById('coach-upsell').style.display = 'none';
  document.getElementById('coach-chat').style.display = 'flex';
  setTimeout(function(){
    sendCoachMsgText(prompt + context);
  }, 500);
}

function openCoachWithIcon() {
  var ic = ICONS_DATA.find(function(x){ return x.id === activeIconId; });
  if (!ic) return;
  sendIconPrompt('Help me dress like '+ic.name+'. Here\'s their vibe: '+ic.vibe.substring(0,120), null);
}

// ════════════════════════════════════════════════════════
// CREATE LOOK FROM CELEBRITY ICON
// ════════════════════════════════════════════════════════

function createIconLook() {
  var ic = ICONS_DATA.find(function(x){ return x.id === activeIconId; });
  if (!ic) return;
  
  if (ITEMS.length < 2) {
    showToast('Add more items to your closet first');
    return;
  }
  
  // Build an outfit matching the celebrity's style
  var outfit = buildCelebrityOutfit(ic);
  
  if (outfit.length < 2) {
    showToast('Not enough matching items in your closet');
    return;
  }
  
  // Save as today's outfit
  var todayKey = getTodayKey();
  var itemIds = outfit.map(function(i) { return i.id; });
  
  weekPlan[todayKey] = {
    items: itemIds,
    name: ic.name + ' Inspired'
  };
  saveWeekPlan();
  
  // Close sheet and go home
  closeIconSheet();
  showPage('home', document.querySelector('.bn-item[onclick*="home"]'));
  renderWeekView();
  renderTodayOutfit();
  showToast('✦ ' + ic.name + '-inspired outfit created!');
}

function buildCelebrityOutfit(ic) {
  var outfit = [];
  var usedIds = [];
  var wardrobe = categorizeWardrobe();
  
  // Get celebrity's signature items and moods
  var signature = ic.signature || [];
  var celebMoods = ic.moods || [];
  var palette = ic.palette || [];
  
  // Try to match signature items first
  signature.forEach(function(sig) {
    var sigLower = sig.toLowerCase();
    var match = ITEMS.find(function(item) {
      if (usedIds.indexOf(item.id) > -1) return false;
      var nameLower = (item.name || '').toLowerCase();
      // Check if item name contains any word from signature
      var sigWords = sigLower.split(' ');
      return sigWords.some(function(word) {
        return word.length > 3 && nameLower.indexOf(word) > -1;
      });
    });
    if (match) {
      outfit.push(match);
      usedIds.push(match.id);
    }
  });
  
  // Fill in missing categories based on celebrity's needed categories
  var neededCats = ic.matchCats || ['Tops', 'Bottoms', 'Footwear', 'Outerwear'];
  var haveCats = outfit.map(function(i) { return i.cat; });
  
  neededCats.forEach(function(cat) {
    if (haveCats.indexOf(cat) > -1) return;
    if (outfit.length >= 4) return;
    
    // Find best item in this category
    var catItems = ITEMS.filter(function(i) { 
      return i.cat === cat && usedIds.indexOf(i.id) === -1; 
    });
    
    if (catItems.length === 0) return;
    
    // Score items based on mood/style match
    var scored = catItems.map(function(item) {
      var score = 0;
      var nameLower = (item.name || '').toLowerCase();
      
      // Check palette match
      palette.forEach(function(color) {
        if (nameLower.indexOf(color.toLowerCase()) > -1) score += 2;
      });
      
      // Check if item style matches celeb mood
      if (celebMoods.indexOf('business') > -1 || celebMoods.indexOf('old-money') > -1) {
        if (nameLower.match(/dress|oxford|loafer|blazer|suit|chino|wool/)) score += 3;
      }
      if (celebMoods.indexOf('streetwear') > -1) {
        if (nameLower.match(/sneaker|hoodie|jeans|graphic|jordan/)) score += 3;
      }
      if (celebMoods.indexOf('minimal') > -1) {
        if (nameLower.match(/white|black|grey|basic|clean/)) score += 3;
      }
      if (celebMoods.indexOf('ald') > -1 || celebMoods.indexOf('coastal') > -1) {
        if (nameLower.match(/polo|chino|loafer|boat|rugby/)) score += 3;
      }
      
      return { item: item, score: score };
    });
    
    scored.sort(function(a, b) { return b.score - a.score; });
    
    if (scored.length > 0) {
      outfit.push(scored[0].item);
      usedIds.push(scored[0].item.id);
    }
  });
  
  return outfit.slice(0, 4);
}

// ════════════════════════════════════════════════════════
// MATCH THIS LOOK - Photo Upload & AI Analysis
// ════════════════════════════════════════════════════════

var matchLookResults = [];

function openMatchLookUpload() {
  document.getElementById('match-look-overlay').classList.add('open');
  resetMatchLook();
}

function closeMatchLook() {
  document.getElementById('match-look-overlay').classList.remove('open');
}

function resetMatchLook() {
  document.getElementById('match-look-upload').style.display = 'block';
  document.getElementById('match-look-analyzing').style.display = 'none';
  document.getElementById('match-look-results').style.display = 'none';
  matchLookResults = [];
}

function handleMatchLookUpload(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  // Show analyzing state
  document.getElementById('match-look-upload').style.display = 'none';
  document.getElementById('match-look-analyzing').style.display = 'block';
  
  var reader = new FileReader();
  reader.onload = function(e) {
    var base64 = e.target.result.split(',')[1];
    var mimeType = file.type || 'image/jpeg';
    
    // Show preview
    document.getElementById('match-look-img').src = e.target.result;
    
    // Send to AI for vibe analysis
    analyzeOutfitVibe(base64, mimeType);
  };
  reader.readAsDataURL(file);
}

function analyzeOutfitVibe(base64, mimeType) {
  fetch(VESTIARY_SERVER + '/api/analyze-vibe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ image: base64, mimeType: mimeType })
  })
  .then(function(r) { return r.json(); })
  .then(function(result) {
    if (result.error) {
      console.error('Vibe analysis error:', result.error);
      // Fallback to basic matching
      showMatchResults({ 
        vibe: 'Stylish Look',
        description: 'A put-together outfit',
        keywords: ['stylish', 'modern'],
        formality: 'smart-casual',
        colors: [],
        pieces: []
      });
    } else {
      showMatchResults(result);
    }
  })
  .catch(function(err) {
    console.error('Vibe analysis error:', err);
    // Fallback to basic matching
    showMatchResults({ 
      vibe: 'Stylish Look',
      description: 'A put-together outfit',
      keywords: ['casual', 'modern'],
      formality: 'smart-casual',
      colors: [],
      pieces: []
    });
  });
}

function showMatchResults(vibeData) {
  // Parse vibe data
  var vibe = vibeData.vibe || 'Stylish Look';
  var desc = vibeData.description || 'A great look to recreate';
  var keywords = vibeData.keywords || [];
  var formality = vibeData.formality || 'smart-casual';
  var colors = vibeData.colors || [];
  var pieces = vibeData.pieces || [];
  
  // Add pieces to keywords for better matching
  var allKeywords = keywords.concat(pieces);
  
  // Find matching items from closet
  matchLookResults = findMatchingItems(allKeywords, formality, colors);
  
  // Update UI
  document.getElementById('match-look-vibe').textContent = vibe;
  document.getElementById('match-look-desc').textContent = desc;
  
  // Render matching items
  var itemsContainer = document.getElementById('match-look-items');
  if (matchLookResults.length === 0) {
    itemsContainer.innerHTML = '<div style="grid-column:1/5;text-align:center;padding:20px;color:var(--ink4);font-size:12px">No matching items found. Add more to your closet!</div>';
  } else {
    itemsContainer.innerHTML = matchLookResults.slice(0, 4).map(function(item) {
      var imgHtml = item.img 
        ? '<img src="' + item.img + '" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML=\'' + item.name.substring(0,2) + '\'">'
        : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:10px;background:var(--s2)">' + item.name.substring(0,8) + '</div>';
      return '<div style="aspect-ratio:1;border-radius:10px;overflow:hidden;border:2px solid var(--ink)">' + imgHtml + '</div>';
    }).join('');
  }
  
  // Show results
  document.getElementById('match-look-analyzing').style.display = 'none';
  document.getElementById('match-look-results').style.display = 'block';
}

function findMatchingItems(keywords, formality, colors) {
  var matches = [];
  var usedIds = [];
  var wardrobe = categorizeWardrobe();
  
  // Score all items
  var scored = ITEMS.map(function(item) {
    var score = 0;
    var nameLower = (item.name || '').toLowerCase();
    
    // Keyword matches
    keywords.forEach(function(kw) {
      if (nameLower.indexOf(kw.toLowerCase()) > -1) score += 3;
    });
    
    // Color matches
    colors.forEach(function(color) {
      if (nameLower.indexOf(color.toLowerCase()) > -1) score += 2;
    });
    
    // Formality match
    var isCasual = nameLower.match(/casual|jeans|sneaker|t-shirt|hoodie/);
    var isDressy = nameLower.match(/dress|oxford|loafer|blazer|suit/);
    
    if (formality === 'casual' && isCasual) score += 2;
    if (formality === 'business' && isDressy) score += 2;
    if (formality === 'smart-casual') score += 1; // Anything works
    if (formality === 'business-casual' && (isDressy || !isCasual)) score += 2;
    
    return { item: item, score: score };
  });
  
  // Sort by score
  scored.sort(function(a, b) { return b.score - a.score; });
  
  // Pick top items, one from each category
  var categories = ['Tops', 'Bottoms', 'Footwear', 'Outerwear'];
  
  categories.forEach(function(cat) {
    var catItems = scored.filter(function(s) { 
      return s.item.cat === cat && usedIds.indexOf(s.item.id) === -1;
    });
    if (catItems.length > 0) {
      matches.push(catItems[0].item);
      usedIds.push(catItems[0].item.id);
    }
  });
  
  return matches;
}

function applyMatchedOutfit() {
  if (matchLookResults.length < 2) {
    showToast('Not enough matching items');
    return;
  }
  
  var todayKey = getTodayKey();
  var itemIds = matchLookResults.map(function(i) { return i.id; });
  
  weekPlan[todayKey] = {
    items: itemIds,
    name: 'Matched Look'
  };
  saveWeekPlan();
  
  closeMatchLook();
  showPage('home', document.querySelector('.bn-item[onclick*="home"]'));
  renderWeekView();
  renderTodayOutfit();
  showToast('✦ Matched outfit saved for today!');
}


// ════════════════════════════════════════════════════════
// DECLUTTER MODE
// ════════════════════════════════════════════════════════

var declutterSelected = [];

function openDeclutterMode() {
  declutterSelected = [];
  
  // Get unworn or rarely worn items
  var unwornItems = ITEMS.filter(function(i) { return (i.wears || 0) === 0; });
  var rarelyWorn = ITEMS.filter(function(i) { return (i.wears || 0) === 1; });
  var candidates = unwornItems.concat(rarelyWorn);
  
  // Calculate potential recovery value (estimate 30% of original cost)
  var potentialValue = candidates.reduce(function(sum, i) { 
    return sum + (i.cost || 0) * 0.3; 
  }, 0);
  
  // Update summary
  document.getElementById('declutter-unworn-count').textContent = unwornItems.length;
  document.getElementById('declutter-value').textContent = '$' + Math.round(potentialValue);
  
  // Render item list
  var container = document.getElementById('declutter-items');
  
  if (candidates.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--ink3)">' +
      '<div style="font-size:36px;margin-bottom:12px">✨</div>' +
      '<div style="font-size:14px;font-weight:600;margin-bottom:4px">Your closet is well-loved!</div>' +
      '<div style="font-size:12px">All your items have been worn. Great job!</div>' +
    '</div>';
  } else {
    container.innerHTML = candidates.map(function(item) {
      var wearText = (item.wears || 0) === 0 ? 'Never worn' : 'Worn once';
      var costText = item.cost ? ' · $' + item.cost : '';
      var ageText = getItemAge(item);
      
      var imgHtml = item.img 
        ? '<img src="' + item.img + '" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display=\'none\'">'
        : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--s3);font-size:14px">' + (item.name || '?').substring(0,2) + '</div>';
      
      return '<div class="declutter-item" id="declutter-item-' + item.id + '" onclick="toggleDeclutterItem(' + item.id + ')">' +
        '<div class="declutter-item-check"><span>✓</span></div>' +
        '<div class="declutter-item-img">' + imgHtml + '</div>' +
        '<div class="declutter-item-info">' +
          '<div class="declutter-item-name">' + (item.name || 'Item') + '</div>' +
          '<div class="declutter-item-meta">' + wearText + costText + '</div>' +
          '<div class="declutter-item-meta">' + (item.cat || 'Item') + ageText + '</div>' +
        '</div>' +
        '<div class="declutter-item-action">' +
          '<button class="btn btn-outline" style="padding:6px 12px;font-size:11px" onclick="event.stopPropagation();sellItem(' + item.id + ')">Sell</button>' +
        '</div>' +
      '</div>';
    }).join('');
  }
  
  document.getElementById('declutter-overlay').classList.add('open');
}

function closeDeclutter() {
  document.getElementById('declutter-overlay').classList.remove('open');
  declutterSelected = [];
}

function toggleDeclutterItem(id) {
  var idx = declutterSelected.indexOf(id);
  if (idx > -1) {
    declutterSelected.splice(idx, 1);
  } else {
    declutterSelected.push(id);
  }
  
  var el = document.getElementById('declutter-item-' + id);
  if (el) {
    el.classList.toggle('selected', declutterSelected.indexOf(id) > -1);
  }
}

function getItemAge(item) {
  if (!item.id) return '';
  // Item ID is timestamp when created
  var created = new Date(item.id);
  var now = new Date();
  var days = Math.floor((now - created) / (1000 * 60 * 60 * 24));
  
  if (days < 7) return '';
  if (days < 30) return ' · ' + Math.floor(days / 7) + 'w ago';
  if (days < 365) return ' · ' + Math.floor(days / 30) + 'mo ago';
  return ' · ' + Math.floor(days / 365) + 'y ago';
}

function sellItem(id) {
  var item = ITEMS.find(function(i) { return i.id === id; });
  if (!item) return;
  
  // Create a search query for resale sites
  var query = encodeURIComponent(item.name + ' ' + (item.brand || ''));
  
  // Show options
  var options = [
    { name: 'Poshmark', url: 'https://poshmark.com/search?query=' + query },
    { name: 'eBay', url: 'https://www.ebay.com/sch/i.html?_nkw=' + query },
    { name: 'Depop', url: 'https://www.depop.com/search/?q=' + query },
    { name: 'Grailed', url: 'https://www.grailed.com/shop?query=' + query },
    { name: 'TheRealReal', url: 'https://www.therealreal.com/search?q=' + query }
  ];
  
  showSellOptions(item, options);
}

function showSellOptions(item, options) {
  var html = '<div style="padding:20px">' +
    '<div style="font-size:14px;font-weight:600;margin-bottom:4px">Sell: ' + item.name + '</div>' +
    '<div style="font-size:12px;color:var(--ink3);margin-bottom:16px">' + 
      (item.cost ? 'Original: $' + item.cost + ' · Suggest listing ~$' + Math.round(item.cost * 0.4) : 'List on a resale platform') + 
    '</div>' +
    '<div style="display:flex;flex-direction:column;gap:8px">' +
    options.map(function(opt) {
      return '<button class="btn btn-outline" style="width:100%;padding:12px;justify-content:space-between;display:flex" onclick="window.open(\'' + opt.url + '\', \'_blank\');closeSellOptions()">' +
        '<span>' + opt.name + '</span><span style="color:var(--ink3)">→</span>' +
      '</button>';
    }).join('') +
    '</div>' +
    '<button class="btn btn-outline" style="width:100%;margin-top:12px;padding:10px" onclick="closeSellOptions()">Cancel</button>' +
  '</div>';
  
  // Create temporary overlay
  var overlay = document.createElement('div');
  overlay.id = 'sell-options-overlay';
  overlay.className = 'modal-overlay open';
  overlay.style.zIndex = '1000';
  overlay.innerHTML = '<div class="modal-sheet" style="max-width:340px">' + html + '</div>';
  overlay.onclick = function(e) { if (e.target === overlay) closeSellOptions(); };
  document.body.appendChild(overlay);
}

function closeSellOptions() {
  var overlay = document.getElementById('sell-options-overlay');
  if (overlay) overlay.remove();
}

function confirmDeclutter() {
  if (declutterSelected.length === 0) {
    showToast('Select items to remove');
    return;
  }
  
  var count = declutterSelected.length;
  
  // Remove selected items from closet
  ITEMS = ITEMS.filter(function(i) {
    return declutterSelected.indexOf(i.id) === -1;
  });
  
  saveCloset();
  renderCloset();
  updateHomeStats();
  initStats();
  
  closeDeclutter();
  showToast('🧹 Removed ' + count + ' item' + (count !== 1 ? 's' : '') + ' from closet');
}

// Render declutter suggestions in stats page
function renderDeclutterSuggestions() {
  var container = document.getElementById('declutter-suggestions');
  var card = document.getElementById('declutter-card');
  if (!container || !card) return;
  
  var unworn = ITEMS.filter(function(i) { return (i.wears || 0) === 0; });
  
  if (unworn.length === 0) {
    card.style.display = 'none';
    return;
  }
  
  card.style.display = 'block';
  
  container.innerHTML = '<div style="display:flex;gap:8px;overflow-x:auto;padding:4px 0">' +
    unworn.slice(0, 5).map(function(item) {
      var imgHtml = item.img 
        ? '<img src="' + item.img + '" style="width:100%;height:100%;object-fit:cover">'
        : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#fff;font-size:10px">' + (item.name || '?').substring(0,6) + '</div>';
      return '<div style="flex-shrink:0;width:60px">' +
        '<div style="width:60px;height:60px;border-radius:8px;overflow:hidden;border:1px solid var(--border)">' + imgHtml + '</div>' +
        '<div style="font-size:9px;color:var(--ink2);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + (item.name || 'Item').split(' ')[0] + '</div>' +
      '</div>';
    }).join('') +
  '</div>' +
  '<div style="font-size:11px;color:var(--ink3);margin-top:8px">' +
    unworn.length + ' item' + (unworn.length !== 1 ? 's' : '') + ' never worn' +
  '</div>';
}

function checkServerStatus() {
  var badge = document.getElementById('server-status-badge');
  if (badge) badge.textContent = 'Checking...';
  fetch(VESTIARY_SERVER + '/health')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (badge) {
        badge.textContent = d.keyConfigured
          ? '✓ Connected — AI ready'
          : '⚠ Server running but API key not configured';
        badge.style.color = d.keyConfigured ? 'green' : 'orange';
      }
      showToast(d.keyConfigured ? 'Server connected ✓' : 'Server up but key missing');
    })
    .catch(function() {
      if (badge) {
        badge.textContent = '✗ Server not reachable — is server.js running?';
        badge.style.color = 'red';
      }
      showToast('Cannot reach server');
    });
}


// ── iOS INSTALL PROMPT ──
function showIosBanner() {
  var isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  var isInApp = window.navigator.standalone;
  var dismissed = false;
  try { dismissed = !!localStorage.getItem('vestiary_ios_banner_dismissed'); } catch(e) {}
  if (isIos && !isInApp && !dismissed) {
    setTimeout(function() {
      var banner = document.getElementById('ios-install-banner');
      if (banner) banner.style.display = 'flex';
    }, 3000); // show 3s after load
  }
}
function dismissIosBanner() {
  var banner = document.getElementById('ios-install-banner');
  if (banner) banner.style.display = 'none';
  try { localStorage.setItem('vestiary_ios_banner_dismissed', '1'); } catch(e) {}
}

</script>

<!-- LOCATION PERMISSION SHEET -->
<div class="perm-sheet" id="location-sheet">
  <div class="perm-card">
    <div class="perm-handle"></div>
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:48px;margin-bottom:12px">📍</div>
      <div style="font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:300;margin-bottom:8px">Better outfits need<br><em style="font-style:italic">your weather.</em></div>
      <div style="font-size:13px;color:var(--ink2);line-height:1.7">Vestiary uses your location to show real-time weather and dress you for the actual temperature — not a guess.</div>
    </div>
    <div style="background:var(--s2);border-radius:10px;padding:12px 14px;margin-bottom:18px">
      <div style="font-size:11px;color:var(--ink2);line-height:1.7">
        <div style="margin-bottom:4px">✓ &nbsp;Real-time temperature &amp; conditions</div>
        <div style="margin-bottom:4px">✓ &nbsp;Layering recommendations</div>
        <div style="margin-bottom:4px">✓ &nbsp;Never shared or sold individually</div>
        <div>✓ &nbsp;City-level only — not precise location</div>
      </div>
    </div>
    <button onclick="grantLocation()" style="width:100%;padding:15px;background:var(--ink);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Karla',sans-serif;margin-bottom:10px">Allow Location →</button>
    <button onclick="skipLocation()" style="width:100%;padding:13px;background:transparent;color:var(--ink3);border:none;font-size:13px;cursor:pointer;font-family:'Karla',sans-serif">Not now — I'll enter my city manually</button>
  </div>
</div>


<!-- ICON DETAIL SHEET -->
<div class="icon-sheet-overlay" id="icon-sheet-overlay" onclick="if(event.target===this)closeIconSheet()">
  <div class="icon-sheet" id="icon-sheet">
    <div class="icon-sheet-hero">
      <img id="icon-sheet-img" src="" alt="">
      <div class="icon-sheet-hero-overlay"></div>
      <button class="icon-sheet-close" onclick="closeIconSheet()">✕</button>
      <div class="icon-sheet-hero-info">
        <div class="icon-sheet-sub" id="icon-sheet-cat"></div>
        <div class="icon-sheet-name" id="icon-sheet-name">David Beckham</div>
      </div>
    </div>
    <div class="icon-sheet-body">
      <!-- Vibe summary -->
      <div style="font-size:13px;color:var(--ink2);line-height:1.7;margin-bottom:14px" id="icon-sheet-vibe"></div>
      <!-- Tab switcher -->
      <div class="icon-tab-row">
        <button class="icon-tab active" onclick="iconTab(this,'match')">Match My Closet</button>
        <button class="icon-tab" onclick="iconTab(this,'shop')">Shop the Look</button>
        <button class="icon-tab" onclick="iconTab(this,'coach')">Ask Coach</button>
      </div>
      <!-- MATCH MY CLOSET -->
      <div class="icon-tab-content active" id="itab-match">
        <div class="match-score-bar">
          <div class="match-score-ring" id="icon-match-ring" style="background:conic-gradient(var(--ink) 0% 40%, var(--s3) 40% 100%)">
            <div style="width:38px;height:38px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center">
              <div class="match-score-pct" id="icon-match-pct">40%</div>
            </div>
          </div>
          <div>
            <div style="font-size:13px;font-weight:700;margin-bottom:2px" id="icon-match-headline">You're already 40% there</div>
            <div style="font-size:11px;color:var(--ink3)" id="icon-match-sub">3 key pieces would complete the look</div>
          </div>
        </div>
        <div class="match-section-title">What You Already Have</div>
        <div class="you-have-row" id="icon-you-have">
          <div style="font-size:12px;color:var(--ink4);padding:10px">Add items to your closet to see matches</div>
        </div>
        
        <!-- CREATE THIS LOOK BUTTON -->
        <button onclick="createIconLook()" class="btn btn-dark" style="width:100%;padding:14px;border-radius:12px;font-size:14px;margin:16px 0" id="create-icon-look-btn">
          ✦ Create This Look From My Closet
        </button>
        
        <div class="match-section-title">What To Add</div>
        <div id="icon-add-list"></div>
      </div>
      <!-- SHOP THE LOOK -->
      <div class="icon-tab-content" id="itab-shop">
        <div style="font-size:11px;color:var(--ink3);margin-bottom:12px" id="icon-shop-intro"></div>
        <div id="icon-shop-list"></div>
      </div>
      <!-- ASK COACH -->
      <div class="icon-tab-content" id="itab-coach">
        <div style="background:var(--s2);border-radius:12px;padding:16px;margin-bottom:12px">
          <div style="font-size:12px;font-weight:700;margin-bottom:4px">✦ Ask your Style Coach</div>
          <div style="font-size:12px;color:var(--ink3);line-height:1.6" id="icon-coach-intro">Send a message to your coach pre-loaded with this celebrity's style context.</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px" id="icon-coach-prompts"></div>
        <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
          <button onclick="openCoachWithIcon()" class="btn btn-dark" style="width:100%;padding:13px;border-radius:10px;font-size:13px">Open Style Coach with this context →</button>
          <div style="font-size:10px;text-align:center;color:var(--ink4);margin-top:6px">Requires Vestiary Premium</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DECLUTTER MODE MODAL -->
<div id="declutter-overlay" class="modal-overlay" onclick="if(event.target===this)closeDeclutter()">
  <div class="modal-sheet" style="max-height:92vh">
    <div class="modal-handle"></div>
    <div class="modal-title">🧹 Declutter Your Closet</div>
    <div class="modal-sub">Review items you haven't worn. Keep what you love, let go of what you don't.</div>
    
    <div id="declutter-content" style="padding:16px 0">
      <!-- Summary -->
      <div style="display:flex;gap:10px;margin-bottom:20px">
        <div style="flex:1;background:var(--s2);border-radius:12px;padding:14px;text-align:center">
          <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:400" id="declutter-unworn-count">0</div>
          <div style="font-size:10px;color:var(--ink3);text-transform:uppercase;letter-spacing:0.05em">Never Worn</div>
        </div>
        <div style="flex:1;background:var(--s2);border-radius:12px;padding:14px;text-align:center">
          <div style="font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:400" id="declutter-value">$0</div>
          <div style="font-size:10px;color:var(--ink3);text-transform:uppercase;letter-spacing:0.05em">Could Recover</div>
        </div>
      </div>
      
      <!-- Item list -->
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--ink3);margin-bottom:10px">Review These Items</div>
      <div id="declutter-items" style="max-height:45vh;overflow-y:auto"></div>
      
      <!-- Actions -->
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
        <div style="font-size:11px;color:var(--ink3);margin-bottom:10px;text-align:center">
          Selected items will be marked for donation/sale
        </div>
        <button class="btn btn-dark" style="width:100%;padding:14px" onclick="confirmDeclutter()">
          Remove Selected Items
        </button>
        <button class="btn btn-outline" style="width:100%;padding:12px;margin-top:8px" onclick="closeDeclutter()">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MATCH LOOK MODAL -->
<div id="match-look-overlay" class="modal-overlay" onclick="if(event.target===this)closeMatchLook()">
  <div class="modal-sheet" style="max-height:90vh">
    <div class="modal-handle"></div>
    <div class="modal-title">Match This Look</div>
    <div class="modal-sub">Upload a photo of an outfit you like and we'll find matching items from your closet.</div>
    
    <!-- Upload State -->
    <div id="match-look-upload" style="padding:20px 0">
      <label style="display:block;border:2px dashed var(--border);border-radius:16px;padding:40px 20px;text-align:center;cursor:pointer">
        <input type="file" accept="image/*" onchange="handleMatchLookUpload(event)" style="display:none">
        <div style="font-size:36px;margin-bottom:12px">📸</div>
        <div style="font-size:14px;font-weight:600;margin-bottom:4px">Tap to upload</div>
        <div style="font-size:12px;color:var(--ink3)">or take a photo of an outfit</div>
      </label>
    </div>
    
    <!-- Analyzing State -->
    <div id="match-look-analyzing" style="display:none;padding:40px 20px;text-align:center">
      <div style="font-size:36px;margin-bottom:16px;animation:pulse 1.5s infinite">✦</div>
      <div style="font-size:14px;font-weight:600">Analyzing the vibe...</div>
      <div style="font-size:12px;color:var(--ink3);margin-top:4px">Finding matches in your closet</div>
    </div>
    
    <!-- Results State -->
    <div id="match-look-results" style="display:none">
      <div style="display:flex;gap:12px;margin-bottom:16px">
        <div id="match-look-preview" style="width:100px;height:100px;border-radius:12px;overflow:hidden;background:var(--s2);flex-shrink:0">
          <img id="match-look-img" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="flex:1">
          <div style="font-size:11px;color:var(--ink3);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">Detected Vibe</div>
          <div id="match-look-vibe" style="font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:300;margin-bottom:4px">Casual Street</div>
          <div id="match-look-desc" style="font-size:11px;color:var(--ink2);line-height:1.5">Relaxed, urban aesthetic with sneakers and layered pieces.</div>
        </div>
      </div>
      
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--ink3);margin-bottom:10px">Matching Items From Your Closet</div>
      <div id="match-look-items" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px"></div>
      
      <button onclick="applyMatchedOutfit()" class="btn btn-dark" style="width:100%;padding:14px;border-radius:12px;font-size:14px">
        Use This Outfit for Today
      </button>
      <button onclick="resetMatchLook()" class="btn btn-outline" style="width:100%;padding:12px;border-radius:10px;font-size:13px;margin-top:8px">
        Try Another Photo
      </button>
    </div>
  </div>
</div>

<!-- OUTFIT PICKER MODAL -->
<div id="outfit-picker-overlay" onclick="if(event.target===this)closeOutfitPicker()">
  <div class="outfit-picker-sheet">
    <div class="outfit-picker-header">
      <div class="outfit-picker-title" id="outfit-picker-title">Plan Outfit</div>
      <button class="outfit-picker-close" onclick="closeOutfitPicker()">✕</button>
    </div>
    <div class="outfit-picker-content">
      <div class="outfit-picker-section">
        <div class="outfit-picker-section-title">Select Items for This Outfit</div>
        <div id="outfit-picker-items" class="outfit-picker-grid"></div>
      </div>
      <div class="outfit-picker-section" id="saved-outfits-section">
        <div class="outfit-picker-section-title">Or Choose a Saved Outfit</div>
        <div id="outfit-picker-saved"></div>
      </div>
    </div>
    <div class="outfit-picker-actions">
      <button class="btn btn-outline" onclick="clearDayOutfit()">Clear</button>
      <button class="btn btn-dark" onclick="saveDayOutfit()">Save Outfit</button>
    </div>
  </div>
</div>


<!-- iOS Add to Home Screen banner -->
<div id="ios-install-banner" style="display:none" class="ios-banner">
  <div style="font-size:22px">📲</div>
  <div class="ios-banner-text">
    <strong>Add to Home Screen</strong><br>
    Tap <strong>Share</strong> then <strong>Add to Home Screen</strong> for the full app experience
  </div>
  <button class="ios-banner-close" onclick="dismissIosBanner()">✕</button>
</div>

</body>
</html>
